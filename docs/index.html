<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Influent Package Maker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --color-border-default: #d0d7de;
      --color-border-muted: #d8dee4;
      --color-canvas-default: #ffffff;
      --color-canvas-subtle: #f6f8fa;
      --color-fg-default: #24292f;
      --color-fg-muted: #57606a;
      --color-accent-fg: #0969da;
      --color-success-fg: #1a7f37;
      --color-danger-fg: #cf222e;
      --color-attention-fg: #9a6700;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background-color: var(--color-canvas-default);
      color: var(--color-fg-default);
      line-height: 1.5;
    }
    
    .header {
      background-color: #24292f;
      color: white;
      padding: 16px;
      border-bottom: 1px solid var(--color-border-default);
    }
    
    .header-content {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo {
      width: 32px;
      height: 32px;
      background: white;
      border-radius: 6px;
    }
    
    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 24px;
    }
    
    .section {
      background: var(--color-canvas-default);
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      margin-bottom: 24px;
    }
    
    .section-header {
      padding: 16px;
      border-bottom: 1px solid var(--color-border-default);
      background: var(--color-canvas-subtle);
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
    }
    
    .section-body {
      padding: 16px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 4px;
      font-size: 14px;
    }
    
    .form-control {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      font-size: 14px;
      background: var(--color-canvas-default);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--color-accent-fg);
      box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.1);
    }
    
    .textarea {
      min-height: 80px;
      resize: vertical;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 13px;
    }
    
    .btn {
      padding: 8px 16px;
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      background: var(--color-canvas-default);
      color: var(--color-fg-default);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn:hover {
      background: var(--color-canvas-subtle);
    }
    
    .btn-primary {
      background: var(--color-success-fg);
      border-color: var(--color-success-fg);
      color: white;
    }
    
    .btn-primary:hover {
      background: #1a7f37;
      border-color: #1a7f37;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .status {
      padding: 12px;
      border-radius: 6px;
      margin: 12px 0;
      font-size: 14px;
    }
    
    .status-success {
      background: #dafbe1;
      border: 1px solid #ace1af;
      color: var(--color-success-fg);
    }
    
    .status-error {
      background: #ffebe9;
      border: 1px solid #ffcecb;
      color: var(--color-danger-fg);
    }
    
    .status-warning {
      background: #fff8c5;
      border: 1px solid #fae17d;
      color: var(--color-attention-fg);
    }
    
    .status-info {
      background: #ddf4ff;
      border: 1px solid #b6e3ff;
      color: var(--color-accent-fg);
    }
    
    .thinking {
      background: #fff8c5;
      border: 1px solid #fae17d;
      padding: 12px;
      border-radius: 6px;
      margin: 12px 0;
      font-size: 14px;
      font-style: italic;
      color: var(--color-attention-fg);
    }
    
    .file-tree {
      background: var(--color-canvas-subtle);
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      padding: 16px;
      margin: 16px 0;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 13px;
    }
    
    .file-item {
      padding: 4px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .file-icon {
      color: var(--color-fg-muted);
      width: 16px;
      text-align: center;
    }
    
    .code-block {
      background: #0d1117;
      color: #e6edf3;
      padding: 16px;
      border-radius: 6px;
      margin: 12px 0;
      overflow-x: auto;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 13px;
      line-height: 1.45;
    }
    
    .code-block-header {
      background: #161b22;
      margin: -16px -16px 16px -16px;
      padding: 12px 16px;
      border-bottom: 1px solid #30363d;
      font-size: 12px;
      color: #7d8590;
    }
    
    .verification-step {
      padding: 8px 12px;
      margin: 4px 0;
      background: var(--color-canvas-subtle);
      border-radius: 4px;
      font-size: 13px;
      border-left: 3px solid var(--color-border-default);
    }
    
    .verification-step.success {
      border-left-color: var(--color-success-fg);
      background: #dafbe1;
    }
    
    .verification-step.error {
      border-left-color: var(--color-danger-fg);
      background: #ffebe9;
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid currentColor;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }
    
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
      .container {
        padding: 16px;
      }
    }
    
    .ai-thinking {
      background: #fff8c5;
      border: 1px solid #fae17d;
      padding: 12px;
      border-radius: 6px;
      margin: 8px 0;
      font-size: 13px;
      color: var(--color-attention-fg);
    }
    
    .prompt-log {
      background: var(--color-canvas-subtle);
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      padding: 12px;
      margin: 8px 0;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 12px;
      color: var(--color-fg-muted);
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="logo"></div>
      <h1 style="font-size: 16px; font-weight: 600;">Influent Package Maker</h1>
    </div>
  </div>

  <div class="container">
    <div class="grid">
      <!-- Columna Izquierda: Formulario y Configuración -->
      <div>
        <div class="section">
          <div class="section-header">
            <h2 class="section-title">Configuración del Proyecto</h2>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label">Fabricante</label>
              <input type="text" class="form-control" id="empresa" value="influent" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">Nombre interno</label>
              <input type="text" class="form-control" id="nombre" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">Versión</label>
              <input type="text" class="form-control" id="version" value="1.0.0" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">Título completo</label>
              <input type="text" class="form-control" id="titulo" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">Tipo de aplicación</label>
              <select class="form-control" id="tipo">
                <option value="calculadora">Calculadora/Científica</option>
                <option value="utilidad">Utilidad del Sistema</option>
                <option value="herramienta">Herramienta de Desarrollo</option>
                <option value="productividad">Productividad</option>
                <option value="multimedia">Multimedia</option>
              </select>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2 class="section-title">Descripción con IA</h2>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label">Describe tu aplicación en detalle</label>
              <textarea class="form-control textarea" id="idea-input" placeholder="Ej: Calculadora científica con interfaz moderna, funciones trigonométricas, historial de operaciones y temas personalizables..."></textarea>
            </div>
            
            <button class="btn btn-primary" id="btn-generar">
              <span id="btn-text">🚀 Generar Proyecto Completo</span>
              <span id="btn-loading" class="loading" style="display: none;"></span>
            </button>
            
            <div id="thinking" class="thinking" style="display: none;">
              <span class="loading"></span> La IA está analizando y generando tu proyecto...
            </div>
          </div>
        </div>
      </div>

      <!-- Columna Derecha: Resultados y Verificación -->
      <div>
        <div class="section">
          <div class="section-header">
            <h2 class="section-title">Progreso y Verificación</h2>
          </div>
          <div class="section-body">
            <div id="status" class="status status-info">
              Esperando descripción del proyecto...
            </div>
            
            <div id="prompt-log" class="prompt-log" style="display: none;">
              <!-- Log de prompts y respuestas de la IA -->
            </div>
            
            <div id="verification-steps">
              <!-- Pasos de verificación se insertarán aquí -->
            </div>
            
            <div id="ai-thinking" class="ai-thinking" style="display: none;">
              <!-- Pensamientos en tiempo real de la IA -->
            </div>
          </div>
        </div>

        <div class="section" id="results-section" style="display: none;">
          <div class="section-header">
            <h2 class="section-title">Resultados Generados</h2>
          </div>
          <div class="section-body">
            <div id="file-tree" class="file-tree">
              <!-- Estructura de archivos se insertará aquí -->
            </div>
            
            <div id="code-preview">
              <!-- Vista previa del código se insertará aquí -->
            </div>
            
            <div class="form-group">
              <button class="btn btn-primary" id="btn-descargar">📦 Descargar Paquete .iflapp</button>
              <button class="btn" id="btn-validar">🔍 Validar Código</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
// --- Configuración y Constantes ---
// API Key corregida para Gemini
const GEMINI_API_KEY = "AIzaSyDD8X1GvPm6j3axGaWz-pmjKSQXdP8eci4";

const DEFAULT_FOLDERS = ["app", "assets", "config", "docs", "source", "lib", "tests"];
let currentProjectData = null;
let lastFiles = null;

// --- Utilidades Básicas ---
function getTimestamp() {
  const d = new Date();
  return `${d.getFullYear().toString().slice(-2)}.${(d.getMonth()+1).toString().padStart(2, '0')}-${d.getHours().toString().padStart(2, '0')}.${d.getMinutes().toString().padStart(2, '0')}`;
}

async function sha256(str) {
  const buf = new TextEncoder().encode(str);
  const hash = await window.crypto.subtle.digest('SHA-256', buf);
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, "0")).join("");
}

// --- Sistema de Logging ---
function logPrompt(prompt, response = null) {
  const logElement = document.getElementById('prompt-log');
  logElement.style.display = 'block';
  
  const timestamp = new Date().toLocaleTimeString();
  let logEntry = `[${timestamp}] PROMPT: ${prompt.substring(0, 100)}...\n`;
  
  if (response) {
    logEntry += `[${timestamp}] RESPUESTA: ${response.substring(0, 150)}...\n`;
    logEntry += '─'.repeat(50) + '\n';
  }
  
  logElement.textContent += logEntry;
  logElement.scrollTop = logElement.scrollHeight;
}

function showThinking(message) {
  const thinkingElement = document.getElementById('ai-thinking');
  thinkingElement.style.display = 'block';
  thinkingElement.textContent = `💭 ${message}`;
}

function hideThinking() {
  document.getElementById('ai-thinking').style.display = 'none';
}

function showStatus(message, type = 'info') {
  const statusElement = document.getElementById('status');
  statusElement.textContent = message;
  statusElement.className = `status status-${type}`;
}

// --- Sistema de Verificación Mejorado ---
async function verifyWithAI(content, fileType, context) {
  showThinking(`Verificando ${fileType}...`);
  
  const prompt = `ANÁLISIS DE ${fileType.toUpperCase()} - CONTEXTO: ${context}

CONTENIDO A VERIFICAR:
\`\`\`
${content.substring(0, 2000)}
\`\`\`

CRITERIOS DE VERIFICACIÓN:
1. ✅ SINTÁXIS: El código debe ser sintácticamente correcto
2. ✅ SEGURIDAD: No debe contener vulnerabilidades o código malicioso
3. ✅ FUNCIONALIDAD: Debe cumplir con su propósito declarado

RESPONDE EXCLUSIVAMENTE con este formato JSON:
{
  "is_valid": true/false,
  "confidence": 0-100,
  "issues": ["lista específica de problemas"],
  "suggestions": ["sugerencias concretas de mejora"]
}`;

  try {
    logPrompt(`Verificación ${fileType}`, `Analizando: ${context}`);
    
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [{ text: prompt }]
        }],
        generationConfig: {
          temperature: 0.1,
          maxOutputTokens: 1024
        }
      })
    });

    if (!response.ok) {
      throw new Error(`Error HTTP: ${response.status}`);
    }

    const data = await response.json();
    const resultText = data.candidates[0].content.parts[0].text;
    
    logPrompt(`Verificación ${fileType}`, `Respuesta recibida: ${resultText.substring(0, 100)}...`);
    
    // Extraer JSON de la respuesta
    const jsonMatch = resultText.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      return JSON.parse(jsonMatch[0]);
    } else {
      return {
        is_valid: false,
        confidence: 0,
        issues: ["No se pudo parsear la respuesta de verificación"],
        suggestions: ["Revisar el formato de la respuesta"]
      };
    }
  } catch (error) {
    console.error('Error en verificación:', error);
    return {
      is_valid: false,
      confidence: 0,
      issues: [`Error de conexión: ${error.message}`],
      suggestions: ["Reintentar la verificación"]
    };
  } finally {
    hideThinking();
  }
}

// --- Generación de Proyecto con IA ---
async function generateProjectWithAI(idea, projectConfig) {
  showThinking("Analizando requisitos y generando estructura del proyecto...");
  
  const prompt = `GENERACIÓN DE PROYECTO PYTHON COMPLETO

CONFIGURACIÓN:
- Idea: ${idea}
- Fabricante: ${projectConfig.empresa}
- Nombre: ${projectConfig.nombre}
- Versión: ${projectConfig.version}
- Título: ${projectConfig.titulo}
- Tipo: ${projectConfig.tipo}

REQUISITOS TÉCNICOS:
1. Aplicación Python con PyQt5 para interfaz gráfica
2. Estructura de proyecto profesional
3. Código limpio y documentado
4. Archivos de configuración y dependencias

GENERA EXCLUSIVAMENTE en formato JSON:

{
  "project_structure": {
    "folders": ["lista", "de", "carpetas"],
    "files": {
      "main.py": "contenido completo del archivo principal aquí",
      "requirements.txt": "PyQt5\\nnumpy\\nmatplotlib",
      "README.md": "# Título\\n\\nDescripción"
    }
  },
  "metadata": {
    "description": "Descripción completa del proyecto",
    "dependencies": ["PyQt5", "numpy"],
    "entry_point": "main.py"
  }
}

IMPORTANTE: Genera código Python real y funcional.`;

  try {
    logPrompt("Generación de proyecto completo", `Idea: ${idea}`);
    
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [{ text: prompt }]
        }],
        generationConfig: {
          temperature: 0.2,
          maxOutputTokens: 4096
        }
      })
    });

    if (!response.ok) {
      throw new Error(`Error HTTP: ${response.status}`);
    }

    const data = await response.json();
    const resultText = data.candidates[0].content.parts[0].text;
    
    logPrompt("Generación de proyecto completo", `Respuesta recibida (${resultText.length} caracteres)`);
    
    // Extraer y parsear JSON
    const jsonMatch = resultText.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      // Si no encuentra JSON, crear una estructura básica
      return createFallbackProject(idea, projectConfig);
    }
    
    return JSON.parse(jsonMatch[0]);
  } catch (error) {
    console.error('Error en generación:', error);
    // En caso de error, crear proyecto de fallback
    return createFallbackProject(idea, projectConfig);
  } finally {
    hideThinking();
  }
}

// --- Proyecto de Fallback ---
function createFallbackProject(idea, projectConfig) {
  return {
    project_structure: {
      folders: ["app", "config", "lib"],
      files: {
        "main.py": `#!/usr/bin/env python3
# ${projectConfig.titulo}
# Versión: ${projectConfig.version}

import sys
import os
from PyQt5.QtWidgets import (QApplication, QMainWindow, QVBoxLayout, 
                             QWidget, QPushButton, QLabel, QTextEdit)
from PyQt5.QtCore import Qt
from PyQt5.QtGui import QFont

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.initUI()
        
    def initUI(self):
        self.setWindowTitle("${projectConfig.titulo}")
        self.setGeometry(100, 100, 600, 400)
        
        # Widget central
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        
        # Layout principal
        layout = QVBoxLayout()
        central_widget.setLayout(layout)
        
        # Título
        title = QLabel("${projectConfig.titulo}")
        title.setAlignment(Qt.AlignCenter)
        title.setFont(QFont("Arial", 16, QFont.Bold))
        layout.addWidget(title)
        
        # Descripción
        desc = QLabel("${idea.substring(0, 100)}...")
        desc.setAlignment(Qt.AlignCenter)
        layout.addWidget(desc)
        
        # Área de texto
        self.text_area = QTextEdit()
        self.text_area.setPlaceholderText("Aquí irá la funcionalidad principal...")
        layout.addWidget(self.text_area)
        
        # Botón de ejemplo
        btn = QPushButton("Ejecutar Función")
        btn.clicked.connect(self.ejecutar_funcion)
        layout.addWidget(btn)
        
    def ejecutar_funcion(self):
        self.text_area.append("Función ejecutada correctamente ✓")
        
if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = MainWindow()
    window.show()
    sys.exit(app.exec_())`,
        "requirements.txt": "PyQt5==5.15.9\nnumpy",
        "README.md": `# ${projectConfig.titulo}

${idea}

## Instalación

1. Instalar dependencias:
\\`\\`\\`bash
pip install -r requirements.txt
\\`\\`\\`

2. Ejecutar la aplicación:
\\`\\`\\`bash
python main.py
\\`\\`\\`

## Características

- Interfaz gráfica moderna con PyQt5
- Desarrollado con Influent Package Maker
- Tipo: ${projectConfig.tipo}
- Versión: ${projectConfig.version}`,
        "config/settings.json": `{
  "app_name": "${projectConfig.titulo}",
  "version": "${projectConfig.version}",
  "company": "${projectConfig.empresa}",
  "description": "${idea.substring(0, 100)}"
}`,
        "lib/utils.py": `# Utilidades para ${projectConfig.titulo}

def saludar():
    """Función de ejemplo"""
    return "¡Hola desde ${projectConfig.titulo}!"

def calcular_suma(a, b):
    """Calcula la suma de dos números"""
    return a + b`
      }
    },
    metadata: {
      description: idea,
      dependencies: ["PyQt5", "numpy"],
      entry_point: "main.py"
    }
  };
}

// --- Verificación en Bucle Mejorada ---
async function verifyAllFiles(files, context) {
  const verificationSteps = document.getElementById('verification-steps');
  verificationSteps.innerHTML = '<div class="verification-step">🔄 Iniciando verificación de archivos...</div>';
  
  let allValid = true;
  const issues = [];
  let filesProcessed = 0;
  const totalFiles = Object.keys(files).filter(f => typeof files[f] === 'string').length;

  for (const [filePath, content] of Object.entries(files)) {
    if (typeof content === 'string' && (filePath.endsWith('.py') || filePath.endsWith('.md'))) {
      filesProcessed++;
      const progress = Math.round((filesProcessed / totalFiles) * 100);
      
      verificationSteps.innerHTML += `<div class="verification-step">🔍 Verificando (${progress}%): ${filePath}</div>`;
      
      const fileType = filePath.endsWith('.py') ? 'código Python' : 'documentación Markdown';
      
      const result = await verifyWithAI(content, fileType, `${context} - ${filePath}`);
      
      if (result.is_valid && result.confidence > 70) {
        verificationSteps.innerHTML += `<div class="verification-step success">✅ ${filePath} - Válido (${result.confidence}% confianza)</div>`;
      } else {
        verificationSteps.innerHTML += `<div class="verification-step error">❌ ${filePath} - Problemas encontrados</div>`;
        issues.push({ 
          file: filePath, 
          problems: result.issues,
          suggestions: result.suggestions
        });
        allValid = false;
      }
      
      // Pequeña pausa para no saturar la API
      await new Promise(resolve => setTimeout(resolve, 500));
    }
  }
  
  return { allValid, issues };
}
<script>
// --- Lógica Principal de la Aplicación ---
document.getElementById('btn-generar').addEventListener('click', async function() {
  const ideaInput = document.getElementById('idea-input').value.trim();
  if (!ideaInput) {
    showStatus('❌ Por favor, describe tu aplicación primero', 'error');
    return;
  }

  // Obtener configuración del formulario
  const projectConfig = {
    empresa: document.getElementById('empresa').value,
    nombre: document.getElementById('nombre').value,
    version: document.getElementById('version').value,
    titulo: document.getElementById('titulo').value,
    tipo: document.getElementById('tipo').value
  };

  // Validar campos requeridos
  if (!projectConfig.nombre || !projectConfig.titulo) {
    showStatus('❌ Completa todos los campos requeridos', 'error');
    return;
  }

  await generateCompleteProject(ideaInput, projectConfig);
});

// Función principal de generación
async function generateCompleteProject(idea, projectConfig) {
  const btn = document.getElementById('btn-generar');
  const btnText = document.getElementById('btn-text');
  const btnLoading = document.getElementById('btn-loading');
  const thinkingElement = document.getElementById('thinking');
  
  // Estado de carga
  btn.disabled = true;
  btnText.textContent = 'Generando...';
  btnLoading.style.display = 'inline-block';
  thinkingElement.style.display = 'block';
  
  try {
    showStatus('🚀 Iniciando generación del proyecto...', 'info');
    
    // Paso 1: Generar estructura con IA
    showStatus('📋 Analizando requisitos con IA...', 'info');
    const aiResult = await generateProjectWithAI(idea, projectConfig);
    
    if (!aiResult.project_structure || !aiResult.metadata) {
      throw new Error('La IA no generó una estructura válida');
    }
    
    // Paso 2: Crear estructura de archivos
    showStatus('📁 Creando estructura de archivos...', 'info');
    const folderName = `${projectConfig.empresa}.${projectConfig.nombre}.v${projectConfig.version}-${getTimestamp()}`;
    const hash = await sha256(`${projectConfig.empresa}.${projectConfig.nombre}.v${projectConfig.version}`);
    
    const files = {};
    
    // Crear carpetas
    [...DEFAULT_FOLDERS, ...(aiResult.project_structure.folders || [])].forEach(folder => {
      files[`${folderName}/${folder}/.gitkeep`] = '# Carpeta ' + folder;
    });
    
    // Archivos generados por IA
    Object.entries(aiResult.project_structure.files || {}).forEach(([filePath, content]) => {
      files[`${folderName}/${filePath}`] = content;
    });
    
    // Archivo details.xml requerido
    files[`${folderName}/details.xml`] = `<?xml version="1.0" encoding="UTF-8"?>
<app>
  <publisher>${projectConfig.empresa}</publisher>
  <app>${projectConfig.nombre}</app>
  <name>${projectConfig.titulo}</name>
  <version>${projectConfig.version}</version>
  <description>${aiResult.metadata.description}</description>
  <entry_point>${aiResult.metadata.entry_point || 'main.py'}</entry_point>
  <hash>${hash}</hash>
</app>`;
    
    // Paso 3: Verificación rápida (opcional)
    showStatus('🔍 Verificando archivos principales...', 'info');
    const verificationResult = await verifyAllFiles(files, aiResult.metadata.description);
    
    // Paso 4: Mostrar resultados
    showResults(files, projectConfig, aiResult, verificationResult);
    
    if (verificationResult.allValid) {
      showStatus('✅ Proyecto generado y verificado exitosamente!', 'success');
    } else {
      showStatus('⚠️ Proyecto generado con algunas advertencias', 'warning');
      showVerificationIssues(verificationResult.issues);
    }
    
    lastFiles = files;
    currentProjectData = { projectConfig, aiResult };
    
  } catch (error) {
    console.error('Error en generación:', error);
    showStatus(`❌ Error: ${error.message}`, 'error');
  } finally {
    // Restaurar estado del botón
    btn.disabled = false;
    btnText.textContent = '🚀 Generar Proyecto Completo';
    btnLoading.style.display = 'none';
    thinkingElement.style.display = 'none';
  }
}

// --- Funciones de UI ---
function showResults(files, projectConfig, aiResult, verificationResult) {
  // Mostrar sección de resultados
  document.getElementById('results-section').style.display = 'block';
  
  // Mostrar árbol de archivos
  const fileTree = document.getElementById('file-tree');
  fileTree.innerHTML = '<strong>Estructura generada:</strong><br>';
  
  Object.keys(files).forEach(filePath => {
    const icon = filePath.endsWith('.py') ? '🐍' : 
                 filePath.endsWith('.md') ? '📝' : 
                 filePath.endsWith('.txt') ? '📄' : 
                 filePath.endsWith('.xml') ? '⚙️' : 
                 filePath.endsWith('.json') ? '🔧' : '📁';
    
    fileTree.innerHTML += `<div class="file-item"><span class="file-icon">${icon}</span> ${filePath}</div>`;
  });
  
  // Mostrar vista previa del código principal
  const codePreview = document.getElementById('code-preview');
  const mainFile = Object.entries(files).find(([path]) => path.includes('main.py') || path.includes('.py') && !path.includes('__'));
  
  if (mainFile) {
    const [filePath, content] = mainFile;
    codePreview.innerHTML = `
      <div class="code-block">
        <div class="code-block-header">${filePath}</div>
        <pre>${escapeHtml(content)}</pre>
      </div>
    `;
  }
  
  // Mostrar issues de verificación si los hay
  if (!verificationResult.allValid) {
    showVerificationIssues(verificationResult.issues);
  }
}

function showVerificationIssues(issues) {
  const verificationSteps = document.getElementById('verification-steps');
  
  issues.forEach(issue => {
    verificationSteps.innerHTML += `
      <div class="verification-step error">
        <strong>${issue.file}:</strong><br>
        ${issue.problems.join('<br>')}
        ${issue.suggestions.length ? `<br><em>Sugerencias: ${issue.suggestions.join(', ')}</em>` : ''}
      </div>
    `;
  });
}

function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// --- Descarga del Proyecto ---
document.getElementById('btn-descargar').addEventListener('click', async function() {
  if (!lastFiles) return;
  
  showStatus('📦 Preparando descarga del paquete...', 'info');
  
  try {
    // Crear ZIP
    const zip = new JSZip();
    for (const [filePath, content] of Object.entries(lastFiles)) {
      zip.file(filePath, content);
    }
    
    const folderName = Object.keys(lastFiles)[0].split('/')[0];
    const blob = await zip.generateAsync({ type: 'blob' });
    
    saveAs(blob, `${folderName}.iflapp`);
    showStatus(`✅ Paquete descargado: ${folderName}.iflapp`, 'success');
    
  } catch (error) {
    console.error('Error en descarga:', error);
    showStatus(`❌ Error al descargar: ${error.message}`, 'error');
  }
});

// --- Validación Adicional ---
document.getElementById('btn-validar').addEventListener('click', async function() {
  if (!lastFiles) return;
  
  showStatus('🔍 Ejecutando validación completa...', 'info');
  
  const result = await verifyAllFiles(lastFiles, 'Validación completa solicitada por usuario');
  
  if (result.allValid) {
    showStatus('✅ Validación completada - Todo el código es correcto', 'success');
  } else {
    showStatus('⚠️ Validación completada - Se encontraron problemas que requieren atención', 'warning');
  }
});

// --- Inicialización ---
document.addEventListener('DOMContentLoaded', function() {
  showStatus('💡 Describe tu aplicación y haz clic en "Generar Proyecto Completo" para comenzar', 'info');
  
  // Ejemplo de descripción pre-cargada
  document.getElementById('idea-input').value = 'Calculadora científica con interfaz moderna PyQt5, funciones trigonométricas, historial de operaciones, temas claros/oscuros y exportación de resultados.';
  document.getElementById('nombre').value = 'scicalc';
  document.getElementById('titulo').value = 'Scientific Calculator Pro';
});
</script>
</body>
</html>