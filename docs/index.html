<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Influent Package Maker — IA (Cliente)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval'">
  <style>
    :root{
      --gradient-from:#0366d6;
      --gradient-to:#2ea44f;
      --bg:#f4f6f8;
      --surface:#ffffff;
      --text:#222;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial; background:var(--bg); color:var(--text);}
    header{display:flex;gap:12px;align-items:center;padding:18px;background:linear-gradient(90deg,var(--gradient-from),var(--gradient-to));color:#fff}
    .logo{width:44px;height:44px;border-radius:8px;background:#fff;padding:6px;display:flex;align-items:center;justify-content:center}
    main{max-width:980px;margin:18px auto;display:grid;grid-template-columns:1fr 420px;gap:18px;padding:0 14px}
    @media (max-width:980px){main{grid-template-columns:1fr;padding:12px}}
    .card{background:var(--surface);border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(20,20,40,.05);border:1px solid rgba(10,10,10,.03)}
    h2{margin:0 0 10px 0;font-size:1.05rem}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type="text"], textarea {width:100%;padding:10px;border-radius:8px;border:1px solid #dfe7ee;background:#fbfdff;font-size:0.95rem}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .full{grid-column:1/-1}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--gradient-from);color:#fff}
    .btn-ghost{background:transparent;border:1px solid rgba(0,0,0,.06)}
    .preview{margin-top:12px;background:#f7fbff;padding:10px;border-radius:10px;max-height:520px;overflow:auto;border:1px solid #eef6ff}
    .file-edit{font-family:monospace;font-size:.95rem;border-radius:8px;border:1px solid #e6eef3;padding:8px;width:100%;min-height:96px}
    .muted{color:#687182;font-size:0.9rem}
    footer{text-align:center;padding:10px;color:#6b7280}
  </style>
</head>
<body>
  <header>
    <div class="logo"><img src="https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/assets/product_logo.png" alt="logo" style="height:100%;width:100%;object-fit:contain;border-radius:6px"></div>
    <div>
      <div style="font-weight:800">Influent Package Maker — IA</div>
      <div class="muted" style="font-size:.9rem">Autocompletado y edición de archivos, descarga .iflapp (ZIP)</div>
    </div>
  </header>

  <main>
    <!-- LEFT: generator -->
    <section class="card">
      <h2>Generador — estructura y archivos</h2>

      <div class="form-grid" style="margin-bottom:10px">
        <div>
          <label>Fabricante</label>
          <input id="inp-empresa" type="text" placeholder="ej. influent-labs">
        </div>
        <div>
          <label>Nombre interno</label>
          <input id="inp-nombre" type="text" placeholder="ej. weatherly">
        </div>
        <div>
          <label>Versión</label>
          <input id="inp-version" type="text" placeholder="1.0">
        </div>
        <div>
          <label>Título completo</label>
          <input id="inp-titulo" type="text" placeholder="Weatherly - App del Clima">
        </div>

        <div class="full">
          <label>Detalle (prompt principal)</label>
          <input id="inp-detail" type="text" placeholder="Descripción breve: 'app de notas local, UI minimal'">
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="btn-ai-suggest" class="btn btn-primary">Autocompletar con IA</button>
        <button id="btn-ai-editfiles" class="btn btn-ghost">Editar archivos existentes (IA)</button>
        <button id="btn-generate" class="btn btn-primary">Generar estructura local</button>
      </div>

      <div id="status" style="margin-top:10px;color:#16a34a;font-weight:700"></div>

      <div id="preview-files" class="preview"></div>
    </section>

    <!-- RIGHT: IA controls & output -->
    <aside class="card">
      <h2>Asistente IA — prompts</h2>
      <div style="margin-bottom:8px" class="muted">Flujo IA: el cliente envía prompts al backend. El backend ejecuta los 3 prompts y devuelve JSON validado.</div>

      <label style="margin-top:8px">Prompt primario</label>
      <input id="ai-prompt" type="text" placeholder="ej. 'app de clima, tema azul, ligera, offline'">

      <label style="margin-top:8px">Modo</label>
      <select id="ai-mode" style="width:100%;padding:8px;border-radius:8px;border:1px solid #dfe7ee">
        <option value="suggest">Sugerir campos y colores (meta)</option>
        <option value="files-min">Generar README + main.py</option>
        <option value="files-full" selected>Generar archivos principales (README, main, requirements, details, autorun, LICENSE)</option>
      </select>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btn-ai-run" class="btn btn-primary">Ejecutar IA</button>
        <button id="btn-clear" class="btn btn-ghost">Limpiar salida</button>
      </div>

      <div id="ai-output" class="preview" style="margin-top:12px;min-height:160px"></div>

      <details style="margin-top:12px">
        <summary>Formato esperado (JSON compacto)</summary>
        <pre style="font-family:monospace;background:#f0f7ff;padding:10px;border-radius:8px">
{
  "meta": {
    "empresa":"tech-nova",
    "nombre":"weatherly",
    "version":"1.0",
    "titulo":"Weatherly - App Clima",
    "colores": { "primario":"#0b6ef6", "secundario":"#20c997", "fondo":"#f6fbff" }
  },
  "files":[
    {"path":"{folder}/README.md","content":"..."},
    {"path":"{folder}/weatherly.py","content":"..."},
    {"path":"{folder}/lib/requirements.txt","content":"..."},
    {"path":"{folder}/details.xml","content":"..."},
    {"path":"{folder}/autorun","content":"..."},
    {"path":"{folder}/LICENSE","content":"..."}
  ]
}
        </pre>
      </details>
    </aside>
  </main>

  <footer>
    <div class="muted">GitHub: <a href="https://github.com/JesusQuijada34/packagemaker/" target="_blank" rel="noopener">packagemaker</a></div>
  </footer>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
  /**************************************************************************
   * CONFIG
   * - API_BASE: endpoint de tu backend (proxy seguro donde está la API key).
   *   El backend hace las 3 llamadas por ti y devuelve JSON ya validado.
   **************************************************************************/
  const API_BASE = "AIzaSyAXnbWHp1-7wC8vVbDbrTWBVIOBPGv7nis"; // cambiar por tu URL si es distinto

  // utilidades
  function getVersionStamp(){
    const d = new Date();
    return `${d.getFullYear().toString().slice(-2)}.${d.getMonth()+1}-${d.getHours()}.${String(d.getMinutes()).padStart(2,"0")}`;
  }
  async function sha256hex(msg){
    const buf = new TextEncoder().encode(msg);
    const hash = await crypto.subtle.digest('SHA-256', buf);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  // sanitizar contenido (básico)
  function sanitizeContent(s){
    if(!s) return s;
    // eliminar scripts/iframes y javascript: handlers básicos
    return s.replace(/<\s*script[\s\S]*?>[\s\S]*?<\/\s*script\s*>/gi,"")
            .replace(/<\s*iframe[\s\S]*?>[\s\S]*?<\/\s*iframe\s*>/gi,"")
            .replace(/javascript:/gi,"");
  }

  // aplicar gradiente/paletado al UI desde JSON meta
  function applyGradient(meta){
    if(!meta || !meta.colores) return;
    const c1 = meta.colores.primario || "#0366d6";
    const c2 = meta.colores.secundario || "#2ea44f";
    const bg = meta.colores.fondo || "#f4f6f8";
    document.documentElement.style.setProperty('--gradient-from', c1);
    document.documentElement.style.setProperty('--gradient-to', c2);
    document.documentElement.style.setProperty('--bg', bg);
  }

  // render de archivos en preview (textareas editables)
  let LAST_FILES = {}; // map path -> content (strings or Blobs)
  function renderFiles(filesArray, folderName){
    LAST_FILES = {};
    const preview = document.getElementById("preview-files");
    preview.innerHTML = "";
    filesArray.forEach(f=>{
      const path = (f.path || "").replace("{folder}", folderName);
      const content = sanitizeContent(String(f.content || ""));
      LAST_FILES[path] = content;
      const div = document.createElement("div");
      div.style.marginBottom = "12px";
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <strong style="font-family:Inter,system-ui">${path}</strong>
          <span class="muted" style="font-size:.9rem">${path.split('.').pop()}</span>
        </div>
        <textarea class="file-edit" data-path="${path}">${content}</textarea>
      `;
      preview.appendChild(div);
    });

    // download button
    const btnWrap = document.createElement("div");
    btnWrap.style.marginTop = "8px";
    btnWrap.innerHTML = `<button id="btn-download-zip" class="btn btn-primary">Descargar .iflapp (ZIP)</button>`;
    preview.appendChild(btnWrap);
    document.getElementById("btn-download-zip").onclick = async ()=>{
      // actualizar LAST_FILES con ediciones
      document.querySelectorAll(".file-edit").forEach(el=>{ LAST_FILES[el.dataset.path] = el.value; });
      const zip = new JSZip();
      for(const p in LAST_FILES){
        zip.file(p, LAST_FILES[p]);
      }
      const folderBase = folderName;
      document.getElementById("status").textContent = "Empaquetando ZIP...";
      const blob = await zip.generateAsync({type:"blob"});
      saveAs(blob, `${folderBase}.iflapp`);
      document.getElementById("status").textContent = `✅ ZIP generado: ${folderBase}.iflapp`;
    };
  }

  // Generación local "manual" (igual que tu script original)
  document.getElementById("btn-generate").addEventListener("click", async ()=>{
    const empresa = (document.getElementById("inp-empresa").value || "influent").trim().toLowerCase().replace(/\s+/g,"-");
    const nombre = (document.getElementById("inp-nombre").value || "myapp").trim().toLowerCase();
    let version = (document.getElementById("inp-version").value || "").trim();
    version = version ? `${version}-${getVersionStamp()}` : `1-${getVersionStamp()}`;
    const titulo = (document.getElementById("inp-titulo").value || nombre.toUpperCase()).trim();
    const folder = `${empresa}.${nombre}.v${version}`;
    const hv = await sha256hex(`${empresa}.${nombre}.v${version}`);

    // crear estructura idéntica
    const DEFAULT_FOLDERS = ["app","assets","config","docs","source","lib"];
    const files = [];
    DEFAULT_FOLDERS.forEach(f => files.push({path:`{folder}/${f}/.${f}-container`, content:`#store (sha256 hash):${f}/.${hv}`}));
    // LICENSE (fetch fallback)
    let license = "GNU GENERAL PUBLIC LICENSE Version 3";
    try {
      const res = await fetch("https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/LICENSE");
      if(res.ok) license = await res.text();
    } catch(e){}
    files.push({path:"{folder}/LICENSE", content:license});
    files.push({path:"{folder}/README.md", content:`# ${empresa} ${titulo}\nProyecto generado con Influent Package Maker Web.`});
    files.push({path:`{folder}/${nombre}.py`, content:`#!/usr/bin/env python\n# publisher: ${empresa}\n# name: ${nombre}\n# version: IO-${version}\nprint('Hello from ${titulo}')`});
    files.push({path:"{folder}/autorun.bat", content:`REM\npip install -r lib/requirements.txt\npython ${nombre}.py\n`});
    files.push({path:"{folder}/autorun", content:`#!/usr/bin/env sh\npip install -r "./lib/requirements.txt"\nclear\npython3 "./${nombre}.py"\n`});
    files.push({path:"{folder}/details.xml", content:`<app>\n  <publisher>${empresa}</publisher>\n  <app>${nombre}</app>\n  <name>${titulo}</name>\n  <version>v${version}</version>\n  <with>${navigator.platform}</with>\n  <danenone>${getVersionStamp()}</danenone>\n  <correlationid>${hv}</correlationid>\n  <rate>Todas las edades</rate>\n</app>`});
    files.push({path:"{folder}/lib/requirements.txt", content:"# Dependencias del paquete\n"});

    // render
    renderFiles(files, folder);
    document.getElementById("status").textContent = "✅ Estructura generada localmente.";
  });

  // ------------------------
  // IA: 3-step flow via backend
  // - cliente envía: { prompt, mode }
  // - backend ejecuta prompts (1 interpret, 2 produce JSON meta+files, 3 validate) y devuelve JSON final
  // ------------------------
  async function callBackendAI(prompt, mode){
    const res = await fetch(API_BASE, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt, mode })
    });
    if(!res.ok) throw new Error("Backend IA error: " + res.status);
    const json = await res.json(); // expected: { meta: {...}, files: [...] }
    return json;
  }

  // Autocompletar campos con IA y aplicar gradiente
  document.getElementById("btn-ai-suggest").addEventListener("click", async ()=>{
    const prompt = document.getElementById("inp-detail").value || document.getElementById("ai-prompt").value;
    if(!prompt){ alert("Escribe un prompt/descripcion."); return; }
    document.getElementById("status").textContent = "🤖 Solicitando sugerencias (backend)...";
    try{
      const parsed = await callBackendAI(prompt, "suggest");
      if(parsed && parsed.meta){
        document.getElementById("inp-empresa").value = parsed.meta.empresa || "";
        document.getElementById("inp-nombre").value = parsed.meta.nombre || "";
        document.getElementById("inp-version").value = parsed.meta.version || "";
        document.getElementById("inp-titulo").value = parsed.meta.titulo || "";
        applyGradient(parsed.meta);
        document.getElementById("status").textContent = "✅ Campos autocompletados por IA.";
        document.getElementById("ai-output").innerHTML = `<pre style="font-family:monospace">${JSON.stringify(parsed,null,2)}</pre>`;
      } else {
        document.getElementById("status").textContent = "⚠️ IA no devolvió meta válido.";
      }
    }catch(err){
      document.getElementById("status").textContent = "Error IA: " + err.message;
    }
  });

  // Editar archivos existentes con IA (backend de edición)
  document.getElementById("btn-ai-editfiles").addEventListener("click", async ()=>{
    // obtener prompt y files actuales
    const prompt = document.getElementById("ai-prompt").value || document.getElementById("inp-detail").value;
    if(!prompt){ alert("Escribe un prompt para que IA edite archivos."); return; }
    if(!Object.keys(LAST_FILES).length){ alert("No hay archivos generados aún. Genera la estructura primero."); return; }
    document.getElementById("status").textContent = "🤖 Solicitando edición de archivos (backend)...";

    try{
      // enviar archivos al backend (size cuidado: en producción limita tamaños)
      const filesForSend = Object.keys(LAST_FILES).map(p=>({ path:p, content: LAST_FILES[p].toString() }));
      const res = await fetch(API_BASE + "/edit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt, files: filesForSend })
      });
      if(!res.ok) throw new Error("Backend IA edit error: " + res.status);
      const edited = await res.json(); // expected: { files: [ {path, content}, ... ], meta? }
      // update preview textareas if paths match
      if(edited && Array.isArray(edited.files)){
        edited.files.forEach(f=>{
          const ta = document.querySelector(`textarea[data-path="${f.path}"]`);
          if(ta) ta.value = f.content;
          LAST_FILES[f.path] = f.content;
        });
        document.getElementById("status").textContent = "✅ Archivos actualizados por IA.";
        document.getElementById("ai-output").innerHTML = `<pre style="font-family:monospace">${JSON.stringify(edited,null,2)}</pre>`;
      } else {
        document.getElementById("status").textContent = "⚠️ Backend edit no devolvió archivos válidos.";
      }
    }catch(err){
      document.getElementById("status").textContent = "Error IA edit: " + err.message;
    }
  });

  // ejecutar IA para generar archivos completos (meta+files)
  document.getElementById("btn-ai-run").addEventListener("click", async ()=>{
    const prompt = document.getElementById("ai-prompt").value;
    const mode = document.getElementById("ai-mode").value;
    if(!prompt){ alert("Escribe un prompt para IA."); return; }
    document.getElementById("status").textContent = "🤖 Solicitando generación completa (backend)...";
    try{
      const parsed = await callBackendAI(prompt, mode === "files-full" ? "full" : (mode === "files-min" ? "minimal":"suggest"));
      if(!parsed || !parsed.meta || !Array.isArray(parsed.files)){
        document.getElementById("status").textContent = "⚠️ Respuesta IA inválida.";
        document.getElementById("ai-output").innerText = JSON.stringify(parsed || {}, null, 2);
        return;
      }
      // derive folder name
      const empresa = (parsed.meta.empresa || "influent").toString().trim().toLowerCase().replace(/\s+/g,"-");
      const nombre = (parsed.meta.nombre || "myapp").toString().trim().toLowerCase();
      const version = (parsed.meta.version || getVersionStamp()).toString().trim();
      const folder = `${empresa}.${nombre}.v${version}`;
      // render files and apply gradient
      renderFiles(parsed.files, folder);
      applyGradient(parsed.meta);
      // fill form fields
      document.getElementById("inp-empresa").value = parsed.meta.empresa || "";
      document.getElementById("inp-nombre").value = parsed.meta.nombre || "";
      document.getElementById("inp-version").value = parsed.meta.version || "";
      document.getElementById("inp-titulo").value = parsed.meta.titulo || "";
      document.getElementById("status").textContent = "✅ Archivos generados por IA. Edita si deseas y descarga.";
      document.getElementById("ai-output").innerHTML = `<pre style="font-family:monospace">${JSON.stringify(parsed,null,2)}</pre>`;
    }catch(err){
      document.getElementById("status").textContent = "Error IA: " + err.message;
    }
  });

  document.getElementById("btn-clear").addEventListener("click", ()=>{ document.getElementById("ai-output").innerHTML = ""; });

  // -------------------------
  // MEDIDAS DISUASORIAS (NO SEGURAS)
  // - Bloquea F12, Ctrl+Shift+I, Ctrl+U, context menu, etc.
  // - Advertencia: Es solo disuasión; usuarios decididos pueden ver todo.
  // -------------------------
  (function addDeterrents(){
    window.addEventListener('keydown', function(e){
      // F12
      if(e.key === 'F12'){ e.preventDefault(); e.stopPropagation(); return false; }
      // Ctrl+Shift+I or Cmd+Opt+I
      if(e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i')){ e.preventDefault(); return false; }
      // Ctrl+U / Cmd+U (view-source)
      if((e.ctrlKey || e.metaKey) && (e.key === 'u' || e.key === 'U')){ e.preventDefault(); return false; }
      // Ctrl+Shift+C (inspect element)
      if(e.ctrlKey && e.shiftKey && (e.key === 'C' || e.key === 'c')){ e.preventDefault(); return false; }
    }, {capture:true});

    // right-click block
    window.addEventListener('contextmenu', function(e){ e.preventDefault(); }, {capture:true});
    // disable selection/copy keys (light)
    window.addEventListener('copy', function(e){ /* allow copy for accessibility - don't block */ }, {capture:true});
  })();

  // finally: helper to apply gradient quickly if inputs already filled
  function applyGradientFromInputs(){
    // optional: generate a two-color gradient from empresa/nombre text hash (fallback)
    const e = document.getElementById("inp-empresa").value || "";
    const n = document.getElementById("inp-nombre").value || "";
    if(!e && !n) return;
    function hashToColor(s){
      let h=0; for(let i=0;i<s.length;i++){ h = ((h<<5)-h)+s.charCodeAt(i); h |= 0; }
      const r = (h & 0xFF0000) >> 16; const g = (h & 0x00FF00) >> 8; const b = h & 0x0000FF;
      return `#${(Math.abs(r)%200+30).toString(16).padStart(2,'0')}${(Math.abs(g)%200+30).toString(16).padStart(2,'0')}${(Math.abs(b)%200+30).toString(16).padStart(2,'0')}`;
    }
    document.documentElement.style.setProperty('--gradient-from', hashToColor(e||n));
    document.documentElement.style.setProperty('--gradient-to', hashToColor((n||e).split('').reverse().join('')));
  }
  // small auto apply on input blur
  document.getElementById("inp-empresa").addEventListener("blur", applyGradientFromInputs);
  document.getElementById("inp-nombre").addEventListener("blur", applyGradientFromInputs);
  </script>
</body>
</html>
