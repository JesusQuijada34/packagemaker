<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Influent Package Maker — Web</title>

  <!-- Favicon (RAW GitHub) -->
  <link rel="icon" href="https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/app/app-icon.ico" type="image/x-icon">

  <!-- Basic styles + GitHub-like controls + glass card + dark-mode support -->
  <style>
    /* ===== Color tokens (light / dark automatic) ===== */
    :root{
      --bg: #fafbfc;
      --panel: #ffffff;
      --fg: #24292e;
      --muted: #57606a;
      --border: #e1e4e8;
      --accent: #0366d6;
      --success: #28a745;
      --glass: rgba(255,255,255,0.6);
      --glass-border: rgba(0,0,0,0.06);
      --shadow: 0 10px 30px rgba(2,6,23,0.08);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Segoe UI Mono", monospace;
    }
    @media (prefers-color-scheme: dark) {
      :root{
        --bg: #0d1117;
        --panel: #0f1720;
        --fg: #c9d1d9;
        --muted: #8b949e;
        --border: #30363d;
        --accent: #58a6ff;
        --success: #2ea44f;
        --glass: rgba(255,255,255,0.03);
        --glass-border: rgba(255,255,255,0.04);
        --shadow: 0 10px 30px rgba(2,6,23,0.6);
      }
    }

    /* ===== Layout ===== */
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background: linear-gradient(180deg,var(--bg) 0%, color-mix(in srgb, var(--bg) 90%, #ffffff 10%) 100%); color:var(--fg); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; display:flex; align-items:center; justify-content:center; padding:20px;}
    .container{width:100%; max-width:1100px; border-radius:14px; overflow:hidden; box-shadow:var(--shadow); border:1px solid var(--glass-border); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); backdrop-filter: blur(10px) saturate(130%);}

    /* ===== Header ===== */
    header.app-header{display:flex;align-items:center;gap:14px;padding:18px 20px;border-bottom:1px solid var(--border); background:var(--glass);}
    .logo{width:44px;height:44px;border-radius:8px;flex:0 0 44px;background:linear-gradient(90deg,#fff,#f3f4f6);display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid var(--border)}
    .logo img{width:100%;height:100%;object-fit:contain}
    .title{font-weight:700;font-size:1.05rem;line-height:1;color:var(--fg)}
    .subtitle{color:var(--muted);font-size:0.9rem;margin-left:auto}

    /* ===== Main split layout ===== */
    .main{display:flex;min-height:520px;max-height:78vh;}
    /* file explorer left */
    .explorer{width:280px;border-right:1px solid var(--border); background:var(--panel); padding:18px; display:flex;flex-direction:column; gap:12px; box-sizing:border-box;}
    .explorer h3{margin:0;font-size:0.95rem;color:var(--fg)}
    .form-row{display:flex;flex-direction:column;gap:8px}
    .form-row label{font-size:0.86rem;color:var(--muted)}
    .input, input[type="text"], input[type="file"], select{padding:9px 10px;border-radius:8px;border:1px solid var(--border); background:transparent; color:var(--fg); font-size:0.95rem; width:100%; box-sizing:border-box}
    input[type="text"]:focus, .input:focus{outline:none;border-color:var(--accent); box-shadow:0 0 0 3px color-mix(in srgb, var(--accent) 8%, transparent)}
    .btn-row{display:flex;gap:8px;margin-top:6px}
    button.btn{padding:9px 12px;border-radius:8px;border:none;font-weight:600; cursor:pointer;background:var(--accent); color:white}
    button.ghost{background:transparent;border:1px solid var(--border); color:var(--fg)}
    button.success{background:var(--success)}
    .status{font-size:0.92rem;color:var(--muted);min-height:1.2rem}

    /* file list */
    .file-list{flex:1;overflow:auto;margin-top:6px;border-radius:8px;border:1px solid var(--border);padding:8px;background:linear-gradient(180deg,transparent, transparent);box-sizing:border-box}
    .file-item{padding:8px 10px;border-radius:6px;margin-bottom:6px;cursor:pointer;font-size:0.92rem;color:var(--fg);display:flex;align-items:center;gap:8px}
    .file-item:hover{background:color-mix(in srgb, var(--accent) 8%, transparent); color:var(--fg)}
    .file-item.active{background:var(--accent); color:#fff}
    .file-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .badge{font-size:0.78rem;color:var(--muted);padding:2px 6px;border-radius:999px;border:1px solid var(--border); background:transparent}

    /* editor area right */
    .editor{flex:1;display:flex;flex-direction:column;background:var(--panel);padding:18px;gap:10px;box-sizing:border-box}
    .editor-top{display:flex;align-items:center;gap:12px}
    .editor-title{font-weight:700;color:var(--fg);font-size:0.98rem}
    .editor-sub{font-size:0.88rem;color:var(--muted);margin-left:auto}
    textarea.editor-area{flex:1;width:100%;min-height:320px;border-radius:10px;border:1px solid var(--border);padding:14px;font-family:var(--mono);font-size:0.95rem;background:transparent;color:var(--fg);resize:vertical;line-height:1.45}
    textarea.editor-area:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px color-mix(in srgb,var(--accent) 8%,transparent)}
    .editor-actions{display:flex;gap:8px;align-items:center}
    .small-muted{font-size:0.86rem;color:var(--muted)}

    /* preview / xml / license viewer */
    .preview{border:1px solid var(--border);border-radius:8px;padding:12px;background:transparent;color:var(--fg);font-size:0.93rem;max-height:180px;overflow:auto}
    pre{white-space:pre-wrap;font-family:var(--mono);font-size:0.92rem;margin:0}

    /* responsive */
    @media (max-width:860px){
      .main{flex-direction:column;min-height:600px}
      .explorer{width:100%;border-right:none;border-bottom:1px solid var(--border)}
      .file-list{max-height:160px}
    }
  </style>
</head>
<body>
  <div class="container gh-glass">
    <header class="app-header gh-header" role="banner">
      <div class="logo" title="Influent package logo">
        <!-- fallback inline placeholder; replaced by fetched RAW icon if available -->
        <img id="raw-icon-img" src="https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/app/app-icon.ico" alt="icon">
      </div>
      <div>
        <div class="title">Influent Package Maker</div>
        <div style="font-size:0.9rem;color:var(--muted)">Crear · Editar · Empaquetar</div>
      </div>
      <div class="subtitle" id="platform">—</div>
    </header>

    <div class="main" role="main">
      <aside class="explorer" aria-label="Explorador de archivos">
        <h3>Crear proyecto</h3>

        <form id="create-form" class="create-form" autocomplete="off" onsubmit="return false;">
          <div class="form-row">
            <label>Fabricante <input class="input" name="empresa" type="text" placeholder="influent"></label>
            <label>Nombre interno <input class="input" name="nombre" type="text" placeholder="mycoolapp"></label>
            <label>Versión <input class="input" name="version" type="text" placeholder="1.0"></label>
            <label>Título <input class="input" name="titulo" type="text" placeholder="My Cool App"></label>
          </div>

          <div class="btn-row" style="margin-top:8px">
            <button id="btn-generate" class="btn" title="Generar estructura">Generar</button>
            <button id="btn-download" class="btn success" title="Descargar paquete" style="display:none">Descargar</button>
            <button id="btn-reset" class="btn ghost" title="Resetear" style="display:none">Reset</button>
          </div>
        </form>

        <div class="status" id="status-create" aria-live="polite"></div>

        <h3 style="margin-top:10px">Archivos</h3>
        <div class="file-list" id="file-list" role="list"></div>

        <hr style="border:none;border-top:1px solid var(--border);margin:8px 0">

        <h3>Explorar paquete</h3>
        <form class="create-form" style="margin-top:6px">
          <label>Subir ZIP <input class="input" id="input-zip" type="file" accept=".zip,.iflapp,.iflappb"></label>
        </form>
        <div id="install-status" class="status"></div>
        <div id="zip-details" class="preview" style="margin-top:8px"></div>
      </aside>

      <section class="editor" aria-label="Editor">
        <div class="editor-top">
          <div>
            <div id="editor-file" class="editor-title">Selecciona un archivo</div>
            <div id="editor-file-sub" class="editor-sub small-muted">Preview y edición</div>
          </div>
          <div class="editor-actions" style="margin-left:auto">
            <div id="file-type-badge" class="badge small-muted" style="display:none"></div>
          </div>
        </div>

        <textarea id="editor-area" class="editor-area" placeholder="Selecciona un archivo a la izquierda..." spellcheck="false" aria-label="Editor de archivo"></textarea>

        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div class="small-muted">Puedes editar archivos de texto (.py, .md, .xml, .txt) antes de empaquetar.</div>
          <div style="display:flex;gap:8px">
            <button id="btn-preview" class="btn ghost" title="Ver contenido">Vista rápida</button>
            <button id="btn-apply" class="btn" title="Aplicar cambios al archivo">Aplicar</button>
          </div>
        </div>

        <div id="preview-area" class="preview" style="display:none;margin-top:8px"></div>
      </section>
    </div>

    <footer style="padding:12px 18px;text-align:center;border-top:1px solid var(--border);background:var(--glass)">
      <small style="color:var(--muted)">Powered by Influent · <a href="https://github.com/JesusQuijada34/packagemaker" target="_blank" style="color:var(--accent)">repo</a></small>
    </footer>
  </div>

  <!-- Libraries -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <!-- Main script -->
  <script>
    (function(){
      // Utilities
      const RAW_ICON_URL = "https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/app/app-icon.ico";
      const RAW_LICENSE_URL = "https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/LICENSE";
      const DEFAULT_FOLDERS = ["app","assets","config","docs","source","lib"];
      function getversion(){ const d=new Date(); return `${d.getFullYear().toString().slice(-2)}.${(d.getMonth()+1)}-${d.getHours()}.${String(d.getMinutes()).padStart(2,'0')}`; }
      async function sha256(str){ const buf=new TextEncoder().encode(str); const h=await crypto.subtle.digest('SHA-256',buf); return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join(''); }

      // DOM
      const platformEl = document.getElementById('platform');
      const rawIconImg = document.getElementById('raw-icon-img');
      const form = document.getElementById('create-form');
      const btnGenerate = document.getElementById('btn-generate');
      const btnDownload = document.getElementById('btn-download');
      const btnReset = document.getElementById('btn-reset');
      const statusCreate = document.getElementById('status-create');
      const fileListEl = document.getElementById('file-list');
      const editorFile = document.getElementById('editor-file');
      const editorSub = document.getElementById('editor-file-sub');
      const editorArea = document.getElementById('editor-area');
      const fileTypeBadge = document.getElementById('file-type-badge');
      const btnApply = document.getElementById('btn-apply');
      const btnPreview = document.getElementById('btn-preview');
      const previewArea = document.getElementById('preview-area');
      const inputZip = document.getElementById('input-zip');
      const installStatus = document.getElementById('install-status');
      const zipDetails = document.getElementById('zip-details');

      platformEl.textContent = navigator.platform || navigator.userAgent;

      // State
      let files = null;          // map path -> string|Blob
      let order = [];            // ordered file list
      let selected = null;       // selected file path

      // Helper: render file list
      function renderFileList(){
        fileListEl.innerHTML = '';
        order.forEach(p=>{
          const li = document.createElement('div');
          li.className = 'file-item' + (p===selected ? ' active' : '');
          li.setAttribute('role','listitem');
          const nameSpan = document.createElement('span');
          nameSpan.className = 'file-name';
          nameSpan.textContent = p.replace(/^.*?\//,'');
          const badge = document.createElement('span');
          badge.className = 'badge';
          const ext = p.split('.').pop().toLowerCase();
          if(ext==='ico' || ext==='ico') badge.textContent = 'icon';
          else badge.textContent = ext;
          li.appendChild(nameSpan);
          li.appendChild(badge);
          li.onclick = ()=>selectFile(p);
          fileListEl.appendChild(li);
        });
      }

      // Select file: show in editor or show binary note
      function selectFile(path){
        selected = path;
        renderFileList();
        const val = files[path];
        editorFile.textContent = path;
        editorSub.textContent = path.includes('/app/') ? 'Ruta: ' + path : '';
        fileTypeBadge.style.display = 'inline-block';
        const ext = path.split('.').pop().toLowerCase();
        fileTypeBadge.textContent = ext;
        previewArea.style.display = 'none';
        if(val instanceof Blob){
          editorArea.value = '[Archivo binario: ' + ext + ' — no editable]';
          editorArea.readOnly = true;
        } else {
          editorArea.value = val;
          editorArea.readOnly = false;
        }
      }

      // Generate structure
      async function generateProject(){
        statusCreate.textContent = 'Generando estructura...';
        btnGenerate.disabled = true;
        const data = new FormData(form);
        let empresa = (data.get('empresa')||'').toString().trim().toLowerCase().replace(/\s+/g,'-') || 'influent';
        let nombre = (data.get('nombre')||'').toString().trim().toLowerCase() || 'mycoolapp';
        let version = (data.get('version')||'').toString().trim();
        version = version ? `${version}-${getversion()}-danenone` : `1-${getversion()}-danenone`;
        let titulo = (data.get('titulo')||'').toString().trim() || nombre.toUpperCase();
        const folder = `${empresa}.${nombre}.v${version}`;
        const hv = await sha256(`${empresa}.${nombre}.v${version}`);

        // Build files map
        const map = {};
        DEFAULT_FOLDERS.forEach(f=>{
          map[`${folder}/${f}/.${f}-container`] = `#store (sha256 hash):${f}/.${hv}`;
        });

        // LICENSE (prefer raw license)
        try{
          const r = await fetch(RAW_LICENSE_URL);
          if(r.ok) map[`${folder}/LICENSE`] = await r.text();
          else map[`${folder}/LICENSE`] = 'GNU GENERAL PUBLIC LICENSE Version 3...';
        }catch(e){
          map[`${folder}/LICENSE`] = 'GNU GENERAL PUBLIC LICENSE Version 3...';
        }

        // Other files
        map[`${folder}/README.md`] = `# ${empresa} ${titulo}\n\nPaquete generado con Influent Package Maker Web.`;
        map[`${folder}/${nombre}.py`] = `#!/usr/bin/env python\n# publisher: ${empresa}\n# name: ${nombre}\n# version: IO-${version}\n\n\ndef main(argv):\n    return 0\n\nif __name__=='__main__':\n    import sys\n    sys.exit(main(sys.argv))\n`;
        map[`${folder}/autorun.bat`] = `@echo off\npip install -r lib\\requirements.txt\npython ${nombre}.py\n`;
        map[`${folder}/autorun`] = `#!/usr/bin/env sh\npip install -r "./lib/requirements.txt"\nclear\n/usr/bin/python3 "./${nombre}.py"\n`;
        map[`${folder}/details.xml`] = `<app>\n  <publisher>${empresa}</publisher>\n  <app>${nombre}</app>\n  <name>${titulo}</name>\n  <version>v${version}</version>\n  <with>${navigator.platform}</with>\n  <danenone>${getversion()}</danenone>\n  <correlationid>${hv}</correlationid>\n  <rate>Todas las edades</rate>\n</app>`;
        map[`${folder}/lib/requirements.txt`] = '# Dependencias del paquete\n';

        // Try fetch icon and include as Blob
        try{
          const r = await fetch(RAW_ICON_URL);
          if(r.ok){
            const b = await r.blob();
            map[`${folder}/app/app-icon.ico`] = b;
            // replace header icon shown (image element)
            try{
              const url = URL.createObjectURL(b);
              rawIconImg.src = url;
            }catch(e){}
          }
        }catch(e){
          // ignore icon fetch failure
        }

        // Assign to state
        files = map;
        order = Object.keys(map);
        selected = order[0] || null;
        renderFileList();
        if(selected) selectFile(selected);

        statusCreate.textContent = `Estructura lista — revisa archivos y edita los de texto. SHA256: ${hv}`;
        btnDownload.style.display = 'inline-block';
        btnReset.style.display = 'inline-block';
        btnGenerate.disabled = false;
      }

      // Apply edits in editor to current file
      function applyEdits(){
        if(!selected) return;
        if(files[selected] instanceof Blob){
          statusCreate.textContent = 'Este archivo es binario y no se puede editar en el navegador.';
          return;
        }
        files[selected] = editorArea.value;
        statusCreate.textContent = `Cambios aplicados a ${selected}`;
      }

      // Preview current file in preview area
      function previewFile(){
        if(!selected) return;
        const val = files[selected];
        if(val instanceof Blob){
          previewArea.style.display = 'block';
          previewArea.innerHTML = '<div style="font-weight:600;margin-bottom:6px">Archivo binario</div>';
          const url = URL.createObjectURL(val);
          previewArea.innerHTML += `<div><a href="${url}" target="_blank" rel="noopener">Abrir icono (.ico)</a></div>`;
          return;
        }
        previewArea.style.display = 'block';
        previewArea.innerHTML = '<pre>' + escapeHtml(val).replace(/\t/g,'  ') + '</pre>';
      }

      // Download zip (collect files from files map)
      async function downloadZip(){
        if(!files) return;
        statusCreate.textContent = 'Generando ZIP...';
        btnDownload.disabled = true;
        // Ensure latest editor content applied
        if(selected && !(files[selected] instanceof Blob) && editorArea.value !== files[selected]) {
          files[selected] = editorArea.value;
        }
        const zip = new JSZip();
        for(const p of order){
          const v = files[p];
          if(v instanceof Blob){
            zip.file(p, v);
          } else {
            zip.file(p, v);
          }
        }
        const root = order.length ? order[0].split('/')[0] : 'package';
        const name = `${root}.iflapp`;
        const blob = await zip.generateAsync({type:'blob', compression:'DEFLATE', compressionOptions:{level:6}});
        saveAs(blob, name);
        statusCreate.textContent = `ZIP listo y descargado: ${name}`;
        btnDownload.disabled = false;
      }

      // Reset UI and state
      function resetAll(){
        files = null; order = []; selected = null;
        fileListEl.innerHTML = ''; editorArea.value = ''; editorFile.textContent = 'Selecciona un archivo';
        editorSub.textContent = ''; previewArea.style.display = 'none'; statusCreate.textContent = '';
        btnDownload.style.display = 'none'; btnReset.style.display = 'none';
      }

      // Inspect uploaded zip
      async function inspectZip(file){
        installStatus.textContent = 'Leyendo ZIP...';
        zipDetails.innerHTML = '';
        try{
          con
