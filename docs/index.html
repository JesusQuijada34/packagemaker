<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Influent Package Maker ‚Äî IA Avanzada</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg: #f4f6f8;
      --surface:#ffffff;
      --text:#24292e;
      --accent:#0366d6;
      --accent-2:#2ea44f;
      --gradient-from: #0366d6;
      --gradient-to: #2ea44f;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.35;
    }
    header{
      display:flex;
      gap:14px;
      align-items:center;
      padding:18px;
      color:#fff;
      background:linear-gradient(90deg,var(--gradient-from) 0%,var(--gradient-to) 100%);
      box-shadow:0 4px 18px rgba(0,0,0,0.12);
    }
    .logo{
      width:44px;height:44px;border-radius:8px;background:#fff;padding:6px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(0,0,0,0.06);
    }
    .title{
      font-weight:700;font-size:1.05rem;
    }
    main{
      max-width:920px;margin:22px auto;padding:20px;display:grid;grid-template-columns:1fr 420px;gap:20px;
    }
    @media (max-width:980px){ main{grid-template-columns:1fr; padding:14px} }
    .card{
      background:var(--surface);
      border-radius:12px;
      padding:16px;
      box-shadow:0 6px 18px rgba(20,20,30,0.04);
      border:1px solid rgba(10,10,10,0.03);
    }
    h2{margin:0 0 10px 0;font-size:1rem}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .form-grid .full{grid-column:1/-1}
    label{display:block;font-weight:600;margin-bottom:6px;font-size:0.9rem}
    input[type="text"], select{
      width:100%;padding:10px;border-radius:8px;border:1px solid #d9e0e7;background:#fbfcfd;
      font-size:0.95rem;
    }
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--text)}
    .status{font-size:0.95rem;margin-top:8px;color:var(--accent-2)}
    .preview{margin-top:12px;background:#f7fafc;border-radius:8px;padding:10px;border:1px solid #eef3f6;max-height:440px;overflow:auto}
    textarea.file-edit{width:100%;min-height:96px;border-radius:8px;border:1px solid #e6eef3;padding:8px;font-family:monospace;resize:vertical;background:#fff}
    .file-row{margin-bottom:10px}
    .muted{color:#667085;font-size:0.9rem}
    .small{font-size:0.85rem;color:#475569}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .preset{padding:8px 10px;border-radius:8px;border:1px solid rgba(10,10,10,0.04);cursor:pointer;background:#fff}
    .ai-output code{display:block;background:#0f1724;color:#e6f2ff;padding:10px;border-radius:8px;font-family:monospace;white-space:pre-wrap}
    footer{max-width:920px;margin:16px auto;text-align:center;color:#556; font-size:0.9rem}
    /* small helpers */
    .row{display:flex;gap:10px;align-items:center}
    .grow{flex:1}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(0,0,0,0.03);font-weight:600}
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/assets/product_logo.png" alt="logo" style="width:100%;height:100%;object-fit:contain;border-radius:6px;">
    </div>
    <div>
      <div class="title">Influent Package Maker ‚Äî Asistente IA</div>
      <div class="small">Genera estructura, archivos y dise√±o desde prompts compactos (JSON).</div>
    </div>
  </header>

  <main>
    <!-- LEFT: Editor & Preview -->
    <section class="card">
      <h2>Generador de Proyecto (estructura)</h2>

      <form id="create-form" style="margin-top:8px">
        <div class="form-grid">
          <div>
            <label>Fabricante</label>
            <input name="empresa" type="text" placeholder="p.ej. influent-labs" />
          </div>
          <div>
            <label>Nombre interno</label>
            <input name="nombre" type="text" placeholder="p.ej. weatherly" />
          </div>
          <div>
            <label>Versi√≥n</label>
            <input name="version" type="text" placeholder="1.0" />
          </div>
          <div>
            <label>T√≠tulo completo</label>
            <input name="titulo" type="text" placeholder="Weatherly - App del Clima" />
          </div>

          <div class="full">
            <label>Descripci√≥n / Detalle (breve)</label>
            <input id="manual-detail" type="text" placeholder="Descripci√≥n corta para generaci√≥n manual..." />
          </div>
        </div>

        <div style="display:flex;gap:10px;margin-top:12px;align-items:center">
          <button id="btn-generate-manual" class="btn btn-primary" type="button">Generar estructura</button>
          <button id="btn-pack-manual" class="btn btn-ghost" type="button">Empaquetar ZIP</button>
          <div class="muted small">Puedes editar archivos luego en la vista previa.</div>
        </div>
      </form>

      <div id="create-status" class="status" style="margin-top:10px"></div>

      <div id="preview-files" class="preview" aria-live="polite"></div>
    </section>

    <!-- RIGHT: AI Assistant -->
    <aside class="card">
      <h2>Asistente IA ‚Äî Prompts y generaci√≥n</h2>

      <label style="margin-top:6px">Prompt interno (breve):</label>
      <input id="ai-prompt" type="text" placeholder="Ej. 'app de notas, m√≥vil, ligero, icono azul'">

      <div style="margin-top:10px" class="small">Modo de generaci√≥n:</div>
      <div style="display:flex;gap:8px;margin-top:8px" id="presets">
        <div class="preset" data-mode="suggest">Sugerir campos</div>
        <div class="preset" data-mode="minimal">M√≠nimo (README + main)</div>
        <div class="preset" data-mode="full">Completo (README, main, requirements, details)</div>
        <div class="preset" data-mode="extras">Completo + Extras (autorun, LICENSE)</div>
      </div>

      <div style="margin-top:12px" class="controls">
        <button id="btn-ai-suggest" class="btn btn-primary">Generar con IA</button>
        <button id="btn-ai-files" class="btn btn-ghost">Generar archivos ordenados</button>
      </div>

      <div id="ai-status" class="status" style="margin-top:10px"></div>

      <div id="ai-output" class="ai-output preview" style="margin-top:12px;min-height:120px"></div>

      <hr style="margin:14px 0">

      <div class="small">Presets: escoge una plantilla r√°pida para controlar el alcance de la generaci√≥n. Las respuestas IA deben ser <strong>JSON compacto</strong> con estructura estricta (ver especificaci√≥n abajo).</div>

      <details style="margin-top:10px">
        <summary class="small">Especificaci√≥n de prompt (clic para ver)</summary>
        <div class="small" style="margin-top:8px">
          La IA debe devolver un √∫nico bloque JSON con dos campos: <code>meta</code> y <code>files</code>.
          <pre style="background:#f3f7fb;padding:8px;border-radius:6px;border:1px solid #e6eef3;font-family:monospace">
{
  "meta": {
    "empresa":"TechNova",
    "nombre":"weatherly",
    "version":"1.0",
    "titulo":"Weatherly - App Clima",
    "colores": { "primario":"#0b6ef6", "secundario":"#20c997", "fondo":"#f6fbff" }
  },
  "files":[
    {"path":"{folder}/README.md","content":"..."},
    {"path":"{folder}/weatherly.py","content":"#!/usr/bin/env python..."},
    {"path":"{folder}/lib/requirements.txt","content":"flask\nrequests"},
    {"path":"{folder}/details.xml","content":"<app>...</app>"},
    {"path":"{folder}/autorun","content":"#!/bin/sh..."},
    {"path":"{folder}/LICENSE","content":"MIT..."}
  ]
}
          </pre>
        </div>
      </details>
    </aside>
  </main>

  <footer>
    <div>Influent Package Maker ‚Ä¢ GitHub: <a href="https://github.com/JesusQuijada34/packagemaker/" target="_blank" rel="noopener">packagemaker</a></div>
  </footer>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script type="module">
  // -------------------------
  // IMPORT SDK GEMINI (cliente)
  // -------------------------
  import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
  const ai = new GoogleGenerativeAI("AIzaSyAXnbWHp1-7wC8vVbDbrTWBVIOBPGv7nis"); // <-- reemplaza
  const model = ai.getGenerativeModel({ model: "gemini-2.0-flash" });

  // -------------------------
  // Config / utilidades
  // -------------------------
  const DEFAULT_FOLDERS = ["app","assets","config","docs","source","lib"];
  let lastFiles = null; // mantiene la estructura generada por IA o manual
  const previewEl = document.getElementById("preview-files");
  const createStatus = document.getElementById("create-status");
  const aiOutput = document.getElementById("ai-output");
  const aiStatus = document.getElementById("ai-status");

  function getVersionStamp(){
    const d = new Date();
    return `${d.getFullYear().toString().slice(-2)}.${d.getMonth()+1}-${d.getHours()}.${String(d.getMinutes()).padStart(2,"0")}`;
  }
  async function sha256hex(msg){
    const buf = new TextEncoder().encode(msg);
    const hash = await crypto.subtle.digest("SHA-256", buf);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  // Filtrado b√°sico de seguridad: neutraliza scripts y patrones peligrosos
  function sanitizeContent(s){
    if(!s || typeof s !== "string") return s;
    // bloquea etiquetas script, javascript: , onerror, eval, <iframe
    const dangerous = /<\s*script|javascript:|onerror=|eval\(|<\s*iframe/i;
    if(dangerous.test(s)){
      // reemplaza las ocurrencias peligrosas
      s = s.replace(/<\s*script[\s\S]*?>[\s\S]*?<\/\s*script\s*>/gi,"");
      s = s.replace(/javascript:/gi,"[javascript_removed]");
      s = s.replace(/onerror=/gi,"onerror_removed=");
      s = s.replace(/eval\(/gi,"eval_removed(");
      s = s.replace(/<\s*iframe[\s\S]*?>[\s\S]*?<\/\s*iframe\s*>/gi,"");
    }
    return s;
  }

  // Aplica gradiente desde colores IA
  function applyGradient(colors){
    if(!colors) return;
    const root = document.documentElement.style;
    if(colors.primario) root.setProperty("--gradient-from", colors.primario);
    if(colors.secundario) root.setProperty("--gradient-to", colors.secundario);
    if(colors.fondo) root.setProperty("--bg", colors.fondo);
  }
  function applyMetaToForm(meta){
    if(!meta) return;
    if(meta.empresa) document.querySelector('[name="empresa"]').value = meta.empresa;
    if(meta.nombre) document.querySelector('[name="nombre"]').value = meta.nombre;
    if(meta.version) document.querySelector('[name="version"]').value = meta.version;
    if(meta.titulo) document.querySelector('[name="titulo"]').value = meta.titulo;
  }

  // Render preview files (crea textareas editables)
  function renderFilesPreview(files, folderName){
    lastFiles = {}; // reset
    previewEl.innerHTML = "";
    const ordered = files.slice(); // expect files in order
    ordered.forEach(fobj=>{
      const path = fobj.path.replace("{folder}", folderName);
      const safe = sanitizeContent(fobj.content || "");
      lastFiles[path] = safe;
      const row = document.createElement("div");
      row.className = "file-row";
      row.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">${path}</div>
          <div class="muted small">${(path.split(".").pop()||"txt").toLowerCase()}</div>
        </div>
        <textarea class="file-edit" data-path="${path}">${safe}</textarea>
      `;
      previewEl.appendChild(row);
    });

    // add note + download button
    const footer = document.createElement("div");
    footer.style.marginTop = "8px";
    footer.innerHTML = `
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btn-download-zip" class="btn btn-primary">Descargar .iflapp (ZIP)</button>
        <div class="muted small">Edita los archivos arriba antes de descargar.</div>
      </div>
    `;
    previewEl.appendChild(footer);

    document.getElementById("btn-download-zip").onclick = async ()=>{
      // recoger ediciones
      document.querySelectorAll(".file-edit").forEach(t=>{
        lastFiles[t.dataset.path] = t.value;
      });
      // crear zip
      const zip = new JSZip();
      for(const p in lastFiles){
        // Si hay blob base64 para icon, podr√≠amos manejarlo, por ahora texto.
        zip.file(p, lastFiles[p]);
      }
      const folderBase = folderName;
      createStatus.textContent = "Empaquetando...";
      zip.generateAsync({type:"blob"}).then(blob=>{
        saveAs(blob, `${folderBase}.iflapp`);
        createStatus.textContent = `‚úÖ ZIP generado: ${folderBase}.iflapp`;
      }).catch(err=>{
        createStatus.textContent = `Error al generar ZIP: ${err.message}`;
      });
    };
  }

  // -------------------------
  // Manual generation (existing feature kept)
  // -------------------------
  document.getElementById("btn-generate-manual").addEventListener("click", async ()=>{
    const empresa = (document.querySelector('[name="empresa"]').value || "influent").trim().toLowerCase().replace(/\s+/g,"-");
    const nombre = (document.querySelector('[name="nombre"]').value || "myapp").trim().toLowerCase();
    let version = document.querySelector('[name="version"]').value.trim();
    version = version ? `${version}-${getVersionStamp()}` : `1-${getVersionStamp()}`;
    const titulo = document.querySelector('[name="titulo"]').value || nombre.toUpperCase();
    const folder = `${empresa}.${nombre}.v${version}`;
    const hv = await sha256hex(`${empresa}.${nombre}.v${version}`);

    const files = [
      { path: "{folder}/README.md", content: `# ${titulo}\nGenerado con Influent Package Maker Web.` },
      { path: "{folder}/"+nombre+".py", content: `#!/usr/bin/env python\n# publisher: ${empresa}\n# name: ${nombre}\n# version: ${version}\nprint('Hello from ${nombre}')\n` },
      { path: "{folder}/lib/requirements.txt", content: "# Dependencias\n" },
      { path: "{folder}/details.xml", content: `<app><publisher>${empresa}</publisher><app>${nombre}</app><name>${titulo}</name><version>${version}</version><correlationid>${hv}</correlationid></app>` },
      { path: "{folder}/autorun", content: "#!/usr/bin/env sh\npip install -r lib/requirements.txt\npython " + nombre + ".py\n" },
      { path: "{folder}/LICENSE", content: "GNU GENERAL PUBLIC LICENSE v3.0" }
    ];

    renderFilesPreview(files, folder);
    createStatus.textContent = "Estructura generada (manual). Puedes editar y descargar.";
  });

  // -------------------------
  // AI integration: prompts and generation modes
  // -------------------------
  // presets UI
  document.querySelectorAll("#presets .preset").forEach(el=>{
    el.addEventListener("click", ()=>{
      document.querySelectorAll("#presets .preset").forEach(p=>p.style.opacity= "0.6");
      el.style.opacity = "1";
      // set placeholder according to preset
      const mode = el.dataset.mode;
      const pinput = document.getElementById("ai-prompt");
      if(mode === "suggest") pinput.placeholder = "Sugerir nombres/campos (muy corto)";
      if(mode === "minimal") pinput.placeholder = "App simple: 'notas, ligero, local'";
      if(mode === "full") pinput.placeholder = "App con backend ligero: 'app clima, API openweather'";
      if(mode === "extras") pinput.placeholder = "App completa con licencia y autorun";
      // store selected
      pinput.dataset.mode = mode;
    });
  });
  // default select first
  document.querySelector("#presets .preset").click();

  // System prompt template (strict JSON)
  const SYSTEM_BASE = `Eres un asistente profesional de desarrollo. RESPONDE √öNICAMENTE con un JSON v√°lido y COMPACTO (sin explicaci√≥n ni texto adicional).
El JSON debe tener: "meta" y "files".
- meta: { empresa, nombre, version, titulo, colores{primario,secundario,fondo} }
- files: array en ORDEN: README.md, main .py, lib/requirements.txt, details.xml, autorun, LICENSE (opcional), cualquier otro archivo (opcional).
Cada archivo: { "path":"{folder}/ruta", "content":"..." }.
Sustituye {folder} por el nombre del folder que se forme con meta: empresa.nombre.v{version}.
No uses descripciones largas, ni texto fuera del JSON.`;

  async function callModelWithPrompt(userPrompt, mode){
    aiStatus.textContent = "ü§ñ solicitando IA...";
    aiOutput.innerHTML = "";
    try {
      // Compose full prompt
      let scope = "";
      if(mode === "suggest") scope = " Solo sugiere meta (empresa,nombre,version,titulo,colores) sin cuerpo de archivos.";
      if(mode === "minimal") scope = " Genera meta y files: README.md y main script (python).";
      if(mode === "full") scope = " Genera meta y files: README.md, main python, requirements, details.xml.";
      if(mode === "extras") scope = " Genera meta y files completos: README, main python, requirements, details.xml, autorun, LICENSE.";
      const fullPrompt = SYSTEM_BASE + "\n" + scope + "\nDescripci√≥n: " + userPrompt;

      const response = await model.generateContent(fullPrompt);
      const raw = (response && response.response && response.response.text) ? response.response.text() : String(response);
      const text = (typeof raw === "function") ? await raw() : raw;
      aiStatus.textContent = "Respuesta recibida. Parseando JSON...";

      // Extract JSON block (first { ... })
      const jsonMatch = text.match(/\{[\s\S]*\}$/);
      if(!jsonMatch){
        aiStatus.textContent = "‚ö†Ô∏è No se encontr√≥ JSON en la respuesta.";
        aiOutput.textContent = text.substring(0,1000);
        return null;
      }
      const jsonText = jsonMatch[0];
      let parsed;
      try{
        parsed = JSON.parse(jsonText);
      }catch(parseErr){
        // try to fix common trailing commas by removing them
        const cleaned = jsonText.replace(/,\s*}/g,"}").replace(/,\s*]/g,"]");
        parsed = JSON.parse(cleaned);
      }
      aiStatus.textContent = "JSON parseado correctamente.";
      aiOutput.innerHTML = `<code>${JSON.stringify(parsed,null,2)}</code>`;
      return parsed;
    } catch(err){
      aiStatus.textContent = "Error IA: " + (err.message || err);
      aiOutput.textContent = "";
      return null;
    }
  }

  // Suggest (autofill fields only)
  document.getElementById("btn-ai-suggest").addEventListener("click", async ()=>{
    const prompt = document.getElementById("ai-prompt").value.trim();
    const mode = document.getElementById("ai-prompt").dataset.mode || "suggest";
    if(!prompt){ aiStatus.textContent = "Escribe un prompt breve."; return; }
    const parsed = await callModelWithPrompt(prompt, mode);
    if(!parsed) return;
    if(parsed.meta){
      applyMetaToForm(parsed.meta);
      if(parsed.meta.colores) applyGradient(parsed.meta.colores);
      aiStatus.textContent = "Campos autocompletados desde IA.";
    } else {
      aiStatus.textContent = "La respuesta no incluy√≥ meta.";
    }
  });

  // Generate files in order
  document.getElementById("btn-ai-files").addEventListener("click", async ()=>{
    const prompt = document.getElementById("ai-prompt").value.trim();
    const mode = document.getElementById("ai-prompt").dataset.mode || "full";
    if(!prompt){ aiStatus.textContent = "Escribe un prompt para generar archivos."; return; }
    const parsed = await callModelWithPrompt(prompt, mode);
    if(!parsed) return;
    // Validate minimal structure
    if(!parsed.meta || !Array.isArray(parsed.files) || parsed.files.length === 0){
      aiStatus.textContent = "JSON no tiene meta o files adecuados.";
      return;
    }
    // derive folder name
    const meta = parsed.meta;
    const empresa = (meta.empresa||"influent").toString().trim().toLowerCase().replace(/\s+/g,"-");
    const nombre = (meta.nombre||"myapp").toString().trim().toLowerCase();
    const version = (meta.version || getVersionStamp()).toString().trim();
    const folder = `${empresa}.${nombre}.v${version}`;
    // replace {folder} placeholders in files (if provided by IA)
    const files = parsed.files.map(f=>{
      const path = (f.path || "").replace(/\{folder\}/g, folder);
      const content = sanitizeContent(String(f.content || ""));
      return { path, content };
    });

    // Ensure required files exist in order: README, main .py, requirements, details.xml, autorun, LICENSE
    // Try to reorder to prefer requested order if files contain those names
    const preferOrder = ["README.md", `${nombre}.py`, "requirements.txt", "lib/requirements.txt", "details.xml", "autorun", "LICENSE"];
    const ordered = [];
    const remaining = files.slice();
    preferOrder.forEach(pref=>{
      for(let i=0;i<remaining.length;i++){
        if(remaining[i].path.endsWith(pref)){
          ordered.push(remaining.splice(i,1)[0]);
          i--;
        }
      }
    });
    // then append remaining in their provided order
    ordered.push(...remaining);

    // If main python missing, create a small default
    const hasMain = ordered.some(f=>f.path.endsWith(".py"));
    if(!hasMain){
      ordered.splice(1,0,{ path: `${folder}/${nombre}.py`, content: `#!/usr/bin/env python\n# ${nombre} main\nprint("Hello ${nombre}")\n`});
    }

    // Render preview and apply UI changes
    renderFilesPreview(ordered, folder);
    applyMetaToForm(parsed.meta);
    applyGradient(parsed.meta.colores);
    aiStatus.textContent = "Archivos generados y listos. Edita y descarga si deseas.";
    createStatus.textContent = `Estructura generada por IA: ${folder}`;
  });

  // -------------------------
  // Keep compatibility: drag & drop or zip install omitted for brevity but you may reuse earlier code
  // (We maintain original packing behavior when clicking download on preview)
  // -------------------------
  </script>
</body>
</html>
