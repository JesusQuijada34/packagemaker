<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Influent Package Maker Web</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --primary-color: #0366d6;
      --success-color: #2ea44f;
      --success-hover: #22863a;
      --warning-color: #f57c00;
      --bg-color: #fafbfc;
      --text-color: #24292e;
      --border-color: #e1e4e8;
      --card-bg: #fff;
      --shadow: 0 2px 7px rgba(0,0,0,0.1);
    }
    
    body { 
      font-family: system-ui, Segoe UI, Arial, sans-serif; 
      background: var(--bg-color); 
      color: var(--text-color); 
      margin: 0; 
      line-height: 1.5;
    }
    
    .gh-header { 
      display: flex; 
      align-items: center; 
      gap: 14px; 
      background: #24292e; 
      color: #fff; 
      padding: 16px 18px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .gh-logo { 
      width: 34px; 
      height: 34px; 
      border-radius: 4px; 
      background: #fff; 
      border: 1px solid var(--border-color);
    }
    
    .gh-header h1 { 
      font-size: 1.1em; 
      font-weight: 600; 
      margin: 0; 
    }
    
    main { 
      max-width: 900px; 
      margin: 22px auto 15px auto; 
      background: var(--card-bg); 
      border: 1px solid var(--border-color); 
      border-radius: 6px; 
      padding: 22px 20px 14px 20px; 
      box-shadow: var(--shadow);
    }
    
    section h2 { 
      font-size: 1.15em; 
      margin-bottom: 9px; 
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .gh-form { 
      display: flex; 
      flex-direction: column; 
      gap: 11px; 
      margin-bottom: 8px;
    }
    
    .gh-form label { 
      display: flex; 
      flex-direction: column; 
      gap: 3px; 
      font-weight: 500;
    }
    
    .gh-form input[type="text"], 
    .gh-form input[type="file"],
    .gh-form textarea { 
      padding: 7px 10px; 
      font-size: 1em; 
      border: 1px solid var(--border-color); 
      border-radius: 6px; 
      background: var(--bg-color); 
      color: var(--text-color); 
      transition: border-color .2s;
    }
    
    .gh-form input[type="text"]:focus, 
    .gh-form textarea:focus { 
      border-color: var(--primary-color); 
      outline: none;
    }
    
    .gh-btn { 
      padding: 9px 16px; 
      font-size: 1em; 
      font-weight: 600; 
      color: #fff; 
      background: var(--success-color); 
      border: none; 
      border-radius: 6px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
      cursor: pointer; 
      transition: background .2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .gh-btn:hover { 
      background: var(--success-hover);
    }
    
    .gh-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .gh-btn.secondary {
      background: var(--primary-color);
    }
    
    .gh-btn.secondary:hover {
      background: #0256b3;
    }
    
    .gh-status { 
      margin-top: 8px; 
      font-size: 1em; 
      color: var(--success-color);
    }
    
    .gh-status.error {
      color: #d73a49;
    }
    
    #preview-files, 
    #zip-details { 
      margin-top: 10px; 
      font-size: .97em; 
      background: #f6f8fa; 
      border-radius: 5px; 
      border: 1px solid var(--border-color); 
      padding: 10px; 
      word-break: break-all;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .file-editbox { 
      width: 98%; 
      min-height: 40px; 
      font-size: .97em; 
      border: 1px solid var(--border-color); 
      border-radius: 5px; 
      margin:5px 0; 
      background:#fff; 
      color:var(--text-color); 
      font-family: monospace;
      resize: vertical;
    }
    
    .file-editbox:focus { 
      border-color: var(--primary-color); 
      outline: none; 
    }
    
    footer { 
      text-align: center; 
      background: #fff; 
      border-top: 1px solid var(--border-color); 
      padding: 10px 0 6px 0; 
      font-size: .97em; 
      color: #586069;
    }
    
    footer a { 
      color: var(--primary-color); 
      text-decoration: none;
    }
    
    footer a:hover { 
      text-decoration: underline;
    }
    
    hr { 
      border: none; 
      border-bottom: 1px solid var(--border-color); 
      margin: 18px 0 11px 0;
    }
    
    .ai-suggestions {
      margin-top: 15px;
      padding: 10px;
      background: #f0f8ff;
      border-radius: 5px;
      border: 1px solid #c8e1ff;
    }
    
    .ai-suggestions h3 {
      margin-top: 0;
      font-size: 1em;
      color: var(--primary-color);
    }
    
    .ai-suggestions button {
      background: var(--primary-color);
      margin-top: 8px;
    }
    
    .ai-suggestions button:hover {
      background: #0256b3;
    }
    
    .suggestion-content {
      margin-top: 10px;
      padding: 8px;
      background: white;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      font-size: 0.9em;
      white-space: pre-wrap;
    }
    
    .code-block {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 12px;
      border-radius: 4px;
      margin: 8px 0;
      font-family: 'Courier New', monospace;
      overflow-x: auto;
      position: relative;
    }
    
    .code-block::before {
      content: attr(data-language);
      position: absolute;
      top: 0;
      right: 0;
      background: #007acc;
      color: white;
      padding: 2px 8px;
      font-size: 0.8em;
      border-radius: 0 4px 0 4px;
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .idea-input {
      min-height: 80px;
    }
    
    .suggestion-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    @media (max-width: 768px) {
      .two-column {
        grid-template-columns: 1fr;
      }
      .suggestion-actions {
        flex-direction: column;
      }
    }
    
    @media (max-width:520px){
      main{
        max-width:97vw;
        padding:7vw 4vw;
      }
      .gh-header{
        padding:7vw 4vw;
      }
    }
  </style>
</head>
<body>
<header class="gh-header">
  <img id="main-logo" src="https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/assets/product_logo.png" alt="Logo" class="gh-logo">
  <h1>Influent Package Maker Web</h1>
</header>
<main>
  <section>
    <h2>Crear y editar proyecto Influent</h2>
    <div class="two-column">
      <form id="create-form" class="gh-form">
        <label><span>Fabricante</span><input name="empresa" type="text" required></label>
        <label><span>Nombre interno</span><input name="nombre" type="text" required></label>
        <label><span>Versión</span><input name="version" type="text" required></label>
        <label><span>Título completo</span><input name="titulo" type="text" required></label>
        <button type="submit" class="gh-btn">Generar estructura</button>
      </form>
      
      <div class="ai-suggestions">
        <h3>💡 Sugerencias Inteligentes con IA</h3>
        <p>Describe tu idea y Gemini AI generará código Python y sugerencias</p>
        <label>
          <span>Describe tu aplicación (ej: "calculadora con interfaz Qt5")</span>
          <textarea id="idea-input" class="idea-input" placeholder="Ej: Una calculadora científica con interfaz gráfica usando PyQt5..."></textarea>
        </label>
        <button id="btn-suggest" class="gh-btn secondary">
          <span id="suggest-text">Generar código y sugerencias</span>
          <span id="suggest-loading" class="loading" style="display:none;"></span>
        </button>
        <div id="suggestion-content" class="suggestion-content" style="display:none;"></div>
      </div>
    </div>
    
    <div id="create-status" class="gh-status"></div>
    <div id="preview-files"></div>
    <button id="btn-download" class="gh-btn" style="display:none;">Descargar ZIP</button>
  </section>
  <hr>
  <section>
    <h2>Instalar/explorar paquete Influent</h2>
    <form class="gh-form">
      <label><span>Selecciona paquete ZIP (.iflapp/.iflappb)</span><input type="file" accept=".zip,.iflapp,.iflappb" id="zipfile"></label>
    </form>
    <div id="install-status" class="gh-status"></div>
    <div id="zip-details"></div>
  </section>
</main>
<footer>
  <span>GitHub: <a href="https://github.com/JesusQuijada34/packagemaker/">packagemaker</a></span>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
// --- Protección de API Key ---
// Dividimos la clave API en partes para dificultar su extracción
const API_KEY_PARTS = [
  "AIzaSyDD8X1GvPm6j3axGaW",
  "z-pmjKSQXdP8eci4"
];
const GEMINI_API_KEY = API_KEY_PARTS.join("");

// --- Utilidades ---
const RAW_ICON_URL = "https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/assets/product_logo.png";
const RAW_LICENSE_URL = "https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/LICENSE";
const DEFAULT_FOLDERS = ["app","assets","config","docs","source","lib"];

function getversion() {
  const d = new Date();
  return `${d.getFullYear().toString().slice(-2)}.${(d.getMonth()+1)}-${d.getHours()}.${d.getMinutes()}`;
}

async function sha256(str) {
  const buf = new TextEncoder().encode(str);
  const hash = await window.crypto.subtle.digest('SHA-256', buf);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

// --- Gemini AI Integration ---
async function getGeminiSuggestion(idea) {
  try {
    const prompt = `Eres un asistente especializado en desarrollo de aplicaciones Python con Qt5/PyQt5. El usuario quiere crear: "${idea}"

    Responde EXCLUSIVAMENTE en el siguiente formato JSON:

    {
      "suggested_name": "nombre_sugerido_para_app",
      "suggested_title": "Título Sugerido para la Aplicación",
      "python_code": "código Python completo aquí",
      "requirements": "dependencias necesarias",
      "explanation": "Breve explicación de la implementación"
    }

    Reglas importantes:
    1. El "suggested_name" debe ser en minúsculas, sin espacios, máximo 15 caracteres
    2. El "suggested_title" debe ser descriptivo y atractivo
    3. El "python_code" debe ser un código Python completo y funcional usando PyQt5
    4. Incluir en "requirements" solo las dependencias necesarias
    5. La "explanation" debe ser breve (2-3 líneas)

    Genera una aplicación Qt5 completa basada en la idea del usuario.`;
    
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        contents: [{
          parts: [{
            text: prompt
          }]
        }]
      })
    });
    
    if (!response.ok) {
      throw new Error(`Error en la API: ${response.status}`);
    }
    
    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
  } catch (error) {
    console.error('Error al obtener sugerencias de Gemini:', error);
    throw error;
  }
}

// --- CREAR Y EDITAR PROYECTO ---
let lastFiles = null;
document.getElementById("create-form").onsubmit = async function(e){
  e.preventDefault();
  document.getElementById("btn-download").style.display = "none";
  document.getElementById("preview-files").textContent = "";
  document.getElementById("create-status").textContent = "Generando estructura...";
  let empresa = this.empresa.value.trim().toLowerCase().replace(/ /g,"-") || "influent";
  let nombre = this.nombre.value.trim().toLowerCase() || "mycoolapp";
  let version = this.version.value.trim();
  version = version ? `${version}-${getversion()}-danenone` : `1-${getversion()}-danenone`;
  let titulo = this.titulo.value.trim() || nombre.toUpperCase();
  let folder_name = `${empresa}.${nombre}.v${version}`;
  let hv = await sha256(`${empresa}.${nombre}.v${version}`);

  // Estructura
  const files = {};
  DEFAULT_FOLDERS.forEach(f=>{
    files[`${folder_name}/${f}/.${f}-container`] = `#store (sha256 hash):${f}/.${hv}`;
  });

  // LICENSE desde RAW
  let licenseText = "GNU GENERAL PUBLIC LICENSE Version 3, 29 June 2007 ...";
  try {
    let licResp = await fetch(RAW_LICENSE_URL);
    if(licResp.ok) licenseText = await licResp.text();
  }catch(e){}
  files[`${folder_name}/LICENSE`] = licenseText;

  files[`${folder_name}/README.md`] = `# ${empresa} ${titulo}\nProyecto generado con Influent Package Maker Web.`;
  files[`${folder_name}/${nombre}.py`] = `#!/usr/bin/env python\n# publisher: ${empresa}\n# name: ${nombre}\n# version: IO-${version}\n`;
  files[`${folder_name}/autorun.bat`] = `REM\npip install -r lib/requirements.txt\npython ${nombre}.py\n`;
  files[`${folder_name}/autorun`] = `#!/usr/bin/env sh\npip install -r "./lib/requirements.txt"\nclear\n/usr/bin/python3 "./${nombre}.py"\n`;
  files[`${folder_name}/details.xml`] = `<app>
  <publisher>${empresa}</publisher>
  <app>${nombre}</app>
  <name>${titulo}</name>
  <version>v${version}</version>
  <with>${navigator.platform}</with>
  <danenone>${getversion()}</danenone>
  <correlationid>${hv}</correlationid>
  <rate>Todas las edades</rate>
</app>`;
  files[`${folder_name}/lib/requirements.txt`] = "# Dependencias del paquete\n";

  // Icono RAW .ico
  let iconBlob=null;
  try {
    let iconResp = await fetch(RAW_ICON_URL);
    if(iconResp.ok) iconBlob = await iconResp.blob();
  }catch(e){iconBlob=null;}
  if(iconBlob) files[`${folder_name}/app/app-icon.ico`] = iconBlob;

  // Render edición
  let html = `<b>Carpetas y archivos generados:</b><ul>`;
  Object.keys(files).forEach(f=>{
    let ext = f.split('.').pop();
    html += `<li>${f} ${ext==="ico"?"<span style='color:#0366d6;'>(icono RAW)</span>":""}</li>`;
  });
  html += `</ul><hr><b>Edita archivos antes de descargar:</b>`;
  Object.keys(files).forEach(f=>{
    if(typeof files[f] === "string" && (f.endsWith(".py")||f.endsWith(".bat")||f.endsWith(".sh")||f.endsWith(".md")||f.endsWith(".xml")||f.endsWith(".txt")||f.endsWith("LICENSE"))){
      html += `<details open><summary>${f}</summary>
      <textarea class="file-editbox" data-file="${f}">${files[f]}</textarea></details>`;
    }
  });
  document.getElementById("preview-files").innerHTML = html;
  document.getElementById("create-status").textContent = `✅ Puedes editar cualquier archivo antes de descargar. SHA256: ${hv}`;
  document.getElementById("btn-download").style.display = "inline-block";
  lastFiles = files;
};

document.getElementById("btn-download").onclick = async function(){
  if(!lastFiles) return;
  document.getElementById("create-status").textContent = "Empaquetando ZIP...";
  // Recoger ediciones
  document.querySelectorAll(".file-editbox").forEach(e=>{
    lastFiles[e.dataset.file] = e.value;
  });
  const zip = new JSZip();
  for(const f in lastFiles){
    if(typeof lastFiles[f]==="string") zip.file(f, lastFiles[f]);
    else zip.file(f, lastFiles[f]); // Blob (icono)
  }
  let folder_name = Object.keys(lastFiles)[0].split("/")[0];
  zip.generateAsync({type:"blob"}).then(blob=>{
    saveAs(blob, `${folder_name}.iflapp`);
    document.getElementById("create-status").textContent = `ZIP descargado: ${folder_name}.iflapp`;
  });
};

// --- INSTALAR / EXPLORAR ZIP ---
document.getElementById("zipfile").onchange = function(e){
  const file = e.target.files[0];
  if(!file)return;
  document.getElementById("install-status").textContent = "Leyendo ZIP...";
  JSZip.loadAsync(file).then(async zip=>{
    let details = `<b>Contenido de "${file.name}"</b><ul>`;
    let xmlContent = "", iconUrl = "";
    for(const fname of Object.keys(zip.files)){
      details += `<li>${fname}${fname.endsWith(".ico")?" <span style='color:#0366d6;'>(icono)</span>":""}</li>`;
      if(fname.endsWith("details.xml")) xmlContent = await zip.file(fname).async("text");
      if(fname.endsWith("app-icon.ico")) iconUrl = URL.createObjectURL(await zip.file(fname).async("blob"));
    }
    details += "</ul>";
    if(xmlContent) details += "<hr><b>Details.xml:</b><pre style='white-space:pre-wrap;font-size:.96em;background:#fff;'>" + xmlContent + "</pre>";
    if(iconUrl) details += `<hr><b>Icono:</b><br><img src="${iconUrl}" style="width:38px;height:38px;border-radius:4px;border:1px solid #e1e4e8;">`;
    document.getElementById("zip-details").innerHTML = details;
    document.getElementById("install-status").textContent = "ZIP leído correctamente.";
  }).catch(()=>{
    document.getElementById("install-status").textContent = "Error: El archivo no es un ZIP válido.";
    document.getElementById("zip-details").textContent = "";
  });
};

// --- Manejo de sugerencias con IA ---
document.getElementById("btn-suggest").addEventListener("click", async function() {
  const ideaInput = document.getElementById("idea-input").value.trim();
  if (!ideaInput) {
    document.getElementById("create-status").textContent = "❌ Por favor, describe tu idea primero";
    document.getElementById("create-status").classList.add("error");
    return;
  }

  const suggestBtn = this;
  const suggestText = document.getElementById("suggest-text");
  const suggestLoading = document.getElementById("suggest-loading");
  const suggestionContent = document.getElementById("suggestion-content");
  
  // Mostrar estado de carga
  suggestText.textContent = "Generando código...";
  suggestLoading.style.display = "inline-block";
  suggestBtn.disabled = true;
  
  try {
    // Obtener sugerencias de Gemini
    const response = await getGeminiSuggestion(ideaInput);
    
    // Intentar parsear la respuesta como JSON
    let suggestions;
    try {
      // Limpiar la respuesta para extraer solo el JSON
      const jsonMatch = response.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        suggestions = JSON.parse(jsonMatch[0]);
      } else {
        throw new Error("No se pudo encontrar JSON en la respuesta");
      }
    } catch (parseError) {
      console.error("Error parseando JSON:", parseError);
      // Si falla el parseo, mostrar la respuesta original
      suggestionContent.innerHTML = `<p><strong>Respuesta de Gemini:</strong></p><div class="code-block">${response}</div>`;
      suggestionContent.style.display = "block";
      document.getElementById("create-status").textContent = "⚠️ Respuesta recibida (formato no esperado)";
      return;
    }
    
    // Mostrar sugerencias en un formato organizado
    let html = `
      <div style="margin-bottom: 15px;">
        <h4 style="margin: 0 0 8px 0; color: var(--primary-color);">✨ Sugerencias Generadas</h4>
        <p><strong>Nombre sugerido:</strong> ${suggestions.suggested_name}</p>
        <p><strong>Título sugerido:</strong> ${suggestions.suggested_title}</p>
      </div>
      
      <div style="margin-bottom: 15px;">
        <h4 style="margin: 0 0 8px 0; color: var(--primary-color);">📋 Dependencias</h4>
        <div class="code-block" data-language="TXT">${suggestions.requirements}</div>
      </div>
      
      <div style="margin-bottom: 15px;">
        <h4 style="margin: 0 0 8px 0; color: var(--primary-color);">💻 Código Python</h4>
        <div class="code-block" data-language="PYTHON">${suggestions.python_code}</div>
      </div>
      
      <div>
        <h4 style="margin: 0 0 8px 0; color: var(--primary-color);">📝 Explicación</h4>
        <p>${suggestions.explanation}</p>
      </div>
      
      <div class="suggestion-actions">
        <button id="apply-suggestions" class="gh-btn secondary">Aplicar sugere
