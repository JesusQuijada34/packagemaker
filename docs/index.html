<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Influent Package Maker Web</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Favicon RAW -->
  <link rel="icon" href="https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/app/app-icon.ico" type="image/x-icon">
  <meta name="theme-color" content="#24292e">
  <style>
    :root {
      --gh-bg: #fafbfc;
      --gh-bg-2: #fff;
      --gh-fg: #24292e;
      --gh-accent: #0366d6;
      --gh-btn: #2ea44f;
      --gh-btn-hover: #22863a;
      --gh-border: #e1e4e8;
      --gh-blur: rgba(255,255,255,0.2);
      --gh-blur-dark: rgba(44,62,80,0.25);
      --gh-shadow: 0 4px 18px 0 rgba(60,120,200,0.13), 0 2px 6px #29b6f688;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --gh-bg: #22272e;
        --gh-bg-2: #2d333b;
        --gh-fg: #cdd9e5;
        --gh-accent: #539bf5;
        --gh-btn: #238636;
        --gh-btn-hover: #2ea44f;
        --gh-border: #444c56;
        --gh-blur: rgba(44,62,80,0.40);
        --gh-blur-dark: rgba(44,62,80,0.55);
        --gh-shadow: 0 4px 18px 0 rgba(44,62,80,0.24), 0 2px 6px #23863688;
      }
    }
    html, body {
      height:100%;
      background: var(--gh-bg);
      color: var(--gh-fg);
      margin:0;
      padding:0;
    }
    body {
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      background: linear-gradient(120deg,var(--gh-bg) 70%,var(--gh-bg-2) 100%);
    }
    .gh-glass {
      box-shadow: var(--gh-shadow);
      background: var(--gh-blur);
      backdrop-filter: blur(17px) saturate(160%);
      border-radius: 20px;
      border: 1.5px solid var(--gh-border);
      margin: 18px auto;
      max-width: 900px;
      min-width: 330px;
      padding: 0;
    }
    .gh-header {
      display: flex;
      align-items: center;
      gap: 14px;
      background: var(--gh-blur-dark);
      color: var(--gh-fg);
      padding: 20px 28px 12px 28px;
      border-radius: 20px 20px 0 0;
      border-bottom:1px solid var(--gh-border);
      font-weight: 600;
      font-size:1.1em;
      letter-spacing: .01em;
    }
    .gh-logo { 
      width: 38px; height: 38px; border-radius: 7px; background: #fff; border: 1px solid var(--gh-border);
    }
    .gh-header h1 { font-size: 1.13em; font-weight: 600; margin: 0; }
    .gh-main {
      display: flex;
      flex-direction: row;
      gap: 0;
      min-height: 420px;
      border-radius: 0 0 20px 20px;
      overflow: hidden;
      background: var(--gh-blur);
    }
    .gh-files {
      flex: 0 0 210px;
      background: var(--gh-bg-2);
      border-right: 1px solid var(--gh-border);
      padding: 18px 0 18px 0;
      overflow-y: auto;
      min-width: 140px;
      max-width: 270px;
      height:100%;
    }
    .gh-files-list {
      list-style: none;
      margin: 0;
      padding:0 0 0 18px;
      font-size: 0.98em;
    }
    .gh-files-list li {
      margin: 2px 0;
      padding: 7px 6px 7px 17px;
      border-radius: 6px;
      cursor: pointer;
      background: none;
      border: none;
      color: var(--gh-fg);
      user-select:none;
      transition: background 0.18s, color 0.18s;
    }
    .gh-files-list li.selected, .gh-files-list li:hover {
      background: var(--gh-accent);
      color: #fff;
    }
    .gh-editor {
      flex: 1;
      background: var(--gh-bg-2);
      padding: 26px 18px 18px 18px;
      min-width: 210px;
      height:100%;
      display: flex;
      flex-direction: column;
    }
    .gh-form {
      display: flex;
      flex-direction: column;
      gap: 13px;
      margin-bottom: 11px;
    }
    .gh-form label { display: flex; flex-direction: column; gap: 2px; font-weight: 500;}
    .gh-form input[type="text"], .gh-form input[type="file"] { padding: 7px 11px; font-size: 1em; border: 1px solid var(--gh-border); border-radius: 6px; background: var(--gh-bg); color: var(--gh-fg); transition: border-color .2s;}
    .gh-form input[type="text"]:focus { border-color: var(--gh-accent); outline: none;}
    .gh-btn { padding: 10px 20px; font-size: 1em; font-weight: 600; color: #fff; background: var(--gh-btn); border: none; border-radius: 6px; box-shadow: 0 2px 4px #0001; cursor: pointer; transition: background .2s;}
    .gh-btn:hover { background: var(--gh-btn-hover);}
    .gh-status { margin-top: 7px; font-size: .99em; color: var(--gh-btn-hover);}
    .gh-editor-title {
      font-size:1em;
      font-weight:600;
      margin-bottom:4px;
      color:var(--gh-accent);
      background:var(--gh-bg-2);
      padding:7px;
      border-radius:5px;
      border-bottom:1px solid var(--gh-border);
      letter-spacing:.02em;
    }
    .gh-editor-box {
      width: 100%;
      flex: 1;
      min-height: 180px;
      font-size: .97em;
      border: 1px solid var(--gh-border);
      border-radius: 7px;
      margin: 0;
      background: var(--gh-bg);
      color: var(--gh-fg);
      resize: vertical;
      padding: 10px;
      box-sizing: border-box;
      font-family: 'Fira Mono', 'Consolas', 'Menlo', 'monospace';
      transition: border-color .18s;
    }
    .gh-editor-box:focus { border-color: var(--gh-accent); outline: none; }
    .gh-files-list::-webkit-scrollbar, .gh-editor-box::-webkit-scrollbar {
      width:8px; background:var(--gh-bg);
    }
    .gh-files-list::-webkit-scrollbar-thumb, .gh-editor-box::-webkit-scrollbar-thumb {
      background:var(--gh-border); border-radius:6px;
    }
    .gh-explorer-actions {
      display:flex; gap:7px; margin-top:12px;
    }
    #btn-download { margin-left:0; }
    #btn-reset { background:#0366d6; }
    #btn-reset:hover { background:#539bf5; }
    @media (max-width:760px){
      .gh-glass{max-width:99vw;}
      .gh-main{flex-direction:column;}
      .gh-files{flex:0 0 56px;max-width:unset;border-right:none;border-bottom:1px solid var(--gh-border);}
      .gh-editor{padding:15px 7px;}
    }
    footer { text-align: center; background: var(--gh-blur-dark); border-top: 1px solid var(--gh-border); padding: 9px 0 6px 0; font-size: .97em; color: #586069; border-radius:0 0 20px 20px;}
    footer a { color: var(--gh-accent); text-decoration: none;}
    footer a:hover { text-decoration: underline;}
    hr { border: none; border-bottom: 1px solid var(--gh-border); margin: 18px 0 11px 0;}
  </style>
</head>
<body>
  <div class="gh-glass">
    <header class="gh-header">
      <img id="main-logo" src="https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/app/app-icon.ico" alt="Logo" class="gh-logo">
      <h1>Influent Package Maker Web</h1>
    </header>
    <div class="gh-main">
      <nav class="gh-files">
        <form id="create-form" class="gh-form" autocomplete="off">
          <label><span>Fabricante</span><input name="empresa" type="text" required></label>
          <label><span>Nombre interno</span><input name="nombre" type="text" required></label>
          <label><span>Versión</span><input name="version" type="text" required></label>
          <label><span>Título completo</span><input name="titulo" type="text" required></label>
          <button type="submit" class="gh-btn">Generar proyecto</button>
        </form>
        <div id="create-status" class="gh-status"></div>
        <ul id="file-list" class="gh-files-list"></ul>
        <div class="gh-explorer-actions">
          <button id="btn-download" class="gh-btn" style="display:none;">Descargar ZIP</button>
          <button id="btn-reset" class="gh-btn" style="display:none;">Resetear</button>
        </div>
        <hr>
        <form class="gh-form" style="margin-top:8px;">
          <label><span>Instalar ZIP (.iflapp/.iflappb)</span><input type="file" accept=".zip,.iflapp,.iflappb" id="zipfile"></label>
        </form>
        <div id="install-status" class="gh-status"></div>
        <div id="zip-details"></div>
      </nav>
      <section class="gh-editor">
        <div id="editor-title" class="gh-editor-title"></div>
        <textarea id="editor-box" class="gh-editor-box" spellcheck="false"></textarea>
        <div id="editor-hint" style="font-size:.92em;color:#999;margin-top:8px;"></div>
      </section>
    </div>
    <footer>
      <span>GitHub: <a href="https://github.com/JesusQuijada34/packagemaker/">packagemaker</a></span>
    </footer>
  </div>
  <!-- JSZip y FileSaver -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    // --- Utilidades ---
    const RAW_ICON_URL = "https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/app/app-icon.ico";
    const RAW_LICENSE_URL = "https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/LICENSE";
    const DEFAULT_FOLDERS = ["app","assets","config","docs","source","lib"];
    function getversion() {
      const d = new Date();
      return `${d.getFullYear().toString().slice(-2)}.${(d.getMonth()+1)}-${d.getHours()}.${d.getMinutes()}`;
    }
    async function sha256(str) {
      const buf = new TextEncoder().encode(str);
      const hash = await window.crypto.subtle.digest('SHA-256', buf);
      return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    // --- Proyecto/Editor ---
    let lastFiles = null, fileOrder = [], selectedFile = null, fileBlobs = {};
    const fileListElem = document.getElementById("file-list");
    const editorTitle = document.getElementById("editor-title");
    const editorBox = document.getElementById("editor-box");
    const editorHint = document.getElementById("editor-hint");
    const statusElem = document.getElementById("create-status");
    const btnDownload = document.getElementById("btn-download");
    const btnReset = document.getElementById("btn-reset");

    function renderFileList() {
      fileListElem.innerHTML = "";
      fileOrder.forEach((f,i)=>{
        let ext = f.split('.').pop();
        let li = document.createElement("li");
        li.textContent = f.replace(/^.*?\//,'');
        if(ext==="ico") li.innerHTML += " <span style='color:#0366d6;'>(icono RAW)</span>";
        li.className = (f===selectedFile)?"selected":"";
        li.onclick = ()=>selectFile(f);
        fileListElem.appendChild(li);
      });
    }

    function selectFile(f) {
      selectedFile = f;
      renderFileList();
      if(typeof lastFiles[f]==="string") {
        editorTitle.textContent = f;
        editorBox.value = lastFiles[f];
        editorBox.readOnly = false;
        editorBox.style.opacity = "1";
        editorHint.textContent = "Puedes editar este archivo antes de descargar el ZIP.";
      } else if(lastFiles[f] instanceof Blob) {
        editorTitle.textContent = f + " (icono RAW)";
        editorBox.value = "[Archivo binario .ico incluido desde RAW]";
        editorBox.readOnly = true;
        editorBox.style.opacity = "0.7";
        editorHint.innerHTML = "<a href='"+RAW_ICON_URL+"' target='_blank'>Ver icono RAW original</a>";
      } else {
        editorTitle.textContent = f;
        editorBox.value = "";
        editorBox.readOnly = true;
        editorHint.textContent = "";
      }
    }

    editorBox.addEventListener("input",function(){
      if(selectedFile && typeof lastFiles[selectedFile]==="string") {
        lastFiles[selectedFile] = editorBox.value;
      }
    });

    btnReset.onclick = function() {
      lastFiles = null; fileOrder = []; selectedFile = null;
      fileListElem.innerHTML = "";
      editorTitle.textContent = "";
      editorBox.value = "";
      btnDownload.style.display = "none";
      btnReset.style.display = "none";
      statusElem.textContent = "";
    };

    document.getElementById("create-form").onsubmit = async function(e){
      e.preventDefault();
      btnDownload.style.display = "none";
      btnReset.style.display = "none";
      fileListElem.innerHTML = "";
      editorTitle.textContent = "";
      editorBox.value = "";
      statusElem.textContent = "Generando estructura...";
      let empresa = this.empresa.value.trim().toLowerCase().replace(/ /g,"-") || "influent";
      let nombre = this.nombre.value.trim().toLowerCase() || "mycoolapp";
      let version = this.version.value.trim();
      version = version ? `${version}-${getversion()}-danenone` : `1-${getversion()}-danenone`;
      let titulo = this.titulo.value.trim() || nombre.toUpperCase();
      let folder_name = `${empresa}.${nombre}.v${version}`;
      let hv = await sha256(`${empresa}.${nombre}.v${version}`);

      // Estructura
      const files = {};
      DEFAULT_FOLDERS.forEach(f=>{
        files[`${folder_name}/${f}/.${f}-container`] = `#store (sha256 hash):${f}/.${hv}`;
      });
      // LICENSE desde RAW
      let licenseText = "GNU GENERAL PUBLIC LICENSE Version 3, 29 June 2007 ...";
      try {
        let licResp = await fetch(RAW_LICENSE_URL);
        if(licResp.ok) licenseText = await licResp.text();
      }catch(e){}
      files[`${folder_name}/LICENSE`] = licenseText;
      files[`${folder_name}/README.md`] = `# ${empresa} ${titulo}\nProyecto generado con Influent Package Maker Web.`;
      files[`${folder_name}/${nombre}.py`] = `#!/usr/bin/env python\n# publisher: ${empresa}\n# name: ${nombre}\n# version: IO-${version}\n`;
      files[`${folder_name}/autorun.bat`] = `REM\npip install -r lib/requirements.txt\npython ${nombre}.py\n`;
      files[`${folder_name}/autorun`] = `#!/usr/bin/env sh\npip install -r "./lib/requirements.txt"\nclear\n/usr/bin/python3 "./${nombre}.py"\n`;
      files[`${folder_name}/details.xml`] = `<app>
  <publisher>${empresa}</publisher>
  <app>${nombre}</app>
  <name>${titulo}</name>
  <version>v${version}</version>
  <with>${navigator.platform}</with>
  <danenone>${getversion()}</danenone>
  <correlationid>${hv}</correlationid>
  <rate>Todas las edades</rate>
</app>`;
      files[`${folder_name}/lib/requirements.txt`] = "# Dependencias del paquete\n";
      // Icono RAW .ico
      let iconBlob=null;
      try {
        let iconResp = await fetch(RAW_ICON_URL);
        if(iconResp.ok) iconBlob = await iconResp.blob();
      }catch(e){iconBlob=null;}
      if(iconBlob) files[`${folder_name}/app/app-icon.ico`] = iconBlob;

      lastFiles = files;
      fileOrder = Object.keys(files);
      selectedFile = fileOrder[0];
      renderFileList();
      selectFile(selectedFile);
      statusElem.textContent = `✅ Selecciona y edita archivos antes de descargar. SHA256: ${hv}`;
      btnDownload.style.display = "inline-block";
      btnReset.style.display = "inline-block";
    };

    btnDownload.onclick = async function(){
      if(!lastFiles) return;
      statusElem.textContent = "Empaquetando ZIP...";
      // Recoger ediciones
      document.querySelectorAll(".gh-editor-box").forEach(e=>{
        if(selectedFile && typeof lastFiles[selectedFile]==="string") {
          lastFiles[selectedFile] = e.value;
        }
      });
      const zip = new JSZip();
      for(const f of fileOrder){
        if(typeof lastFiles[f]==="string") zip.file(f, lastFiles[f]);
        else zip.file(f, lastFiles[f]); // Blob (icono)
      }
      let folder_name = fileOrder[0].split("/")[0];
      zip.generateAsync({type:"blob"}).then(blob=>{
        saveAs(blob, `${folder_name}.iflapp`);
        statusElem.textContent = `ZIP descargado: ${folder_name}.iflapp`;
      });
    };

    // --- INSTALAR / EXPLORAR ZIP ---
    document.getElementById("zipfile").onchange = function(e){
      const file = e.target.files[0];
      if(!file)return;
      document.getElementById("install-status").textContent = "Leyendo ZIP...";
      JSZip.loadAsync(file).then(async zip=>{
        let details = `<b>Contenido de "${file.name}"</b><ul>`;
        let xmlContent = "", iconUrl = "";
        for(const fname of Object.keys(zip.files)){
          details += `<li>${fname}${fname.endsWith(".ico")?" <span style='color:#0366d6;'>(icono)</span>":""}</li>`;
          if(fname.endsWith("details.xml")) xmlContent = await zip.file(fname).async("text");
          if(fname.endsWith("app-icon.ico")) iconUrl = URL.createObjectURL(await zip.file(fname).async("blob"));
        }
        details += "</ul>";
        if(xmlContent) details += "<hr><b>Details.xml:</b><pre style='white-space:pre-wrap;font-size:.96em;background:#fff;'>" + xmlContent + "</pre>";
        if(iconUrl) details += `<hr><b>Icono:</b><br><img src="${iconUrl}" style="width:38px;height:38px;border-radius:4px;border:1px solid #e1e4e8;">`;
        document.getElementById("zip-details").innerHTML = details;
        document.getElementById("install-status").textContent = "ZIP leído correctamente.";
      }).catch(()=>{
        document.getElementById("install-status").textContent = "Error: El archivo no es un ZIP válido.";
        document.getElementById("zip-details").textContent = "";
      });
    };
  </script>
</body>
</html>
