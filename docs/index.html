<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Influent Package Maker Web</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --primary-color: #0366d6;
      --success-color: #2ea44f;
      --success-hover: #22863a;
      --warning-color: #f57c00;
      --bg-color: #fafbfc;
      --text-color: #24292e;
      --border-color: #e1e4e8;
      --card-bg: #fff;
      --shadow: 0 2px 7px rgba(0,0,0,0.1);
      --gradient-start: #667eea;
      --gradient-end: #764ba2;
    }
    
    body { 
      font-family: system-ui, Segoe UI, Arial, sans-serif; 
      background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
      color: var(--text-color); 
      margin: 0; 
      line-height: 1.5;
      min-height: 100vh;
    }
    
    .gh-header { 
      display: flex; 
      align-items: center; 
      gap: 14px; 
      background: rgba(36, 41, 46, 0.95); 
      color: #fff; 
      padding: 16px 18px;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }
    
    .gh-logo { 
      width: 34px; 
      height: 34px; 
      border-radius: 4px; 
      background: #fff; 
      border: 1px solid var(--border-color);
    }
    
    .gh-header h1 { 
      font-size: 1.1em; 
      font-weight: 600; 
      margin: 0; 
    }
    
    main { 
      max-width: 1200px; 
      margin: 22px auto 15px auto; 
      background: var(--card-bg); 
      border: 1px solid var(--border-color); 
      border-radius: 12px; 
      padding: 25px; 
      box-shadow: var(--shadow);
    }
    
    section h2 { 
      font-size: 1.25em; 
      margin-bottom: 15px; 
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--primary-color);
    }
    
    .gh-form { 
      display: flex; 
      flex-direction: column; 
      gap: 15px; 
      margin-bottom: 15px;
    }
    
    .gh-form label { 
      display: flex; 
      flex-direction: column; 
      gap: 5px; 
      font-weight: 500;
    }
    
    .gh-form input[type="text"], 
    .gh-form input[type="file"],
    .gh-form textarea,
    .gh-form select { 
      padding: 10px 12px; 
      font-size: 1em; 
      border: 1px solid var(--border-color); 
      border-radius: 8px; 
      background: var(--bg-color); 
      color: var(--text-color); 
      transition: all 0.3s ease;
    }
    
    .gh-form input[type="text"]:focus, 
    .gh-form textarea:focus,
    .gh-form select:focus { 
      border-color: var(--primary-color); 
      outline: none;
      box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.1);
    }
    
    .gh-btn { 
      padding: 12px 20px; 
      font-size: 1em; 
      font-weight: 600; 
      color: #fff; 
      background: var(--success-color); 
      border: none; 
      border-radius: 8px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.15); 
      cursor: pointer; 
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .gh-btn:hover { 
      background: var(--success-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .gh-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .gh-btn.secondary {
      background: var(--primary-color);
    }
    
    .gh-btn.secondary:hover {
      background: #0256b3;
    }
    
    .gh-btn.warning {
      background: var(--warning-color);
    }
    
    .gh-btn.warning:hover {
      background: #e65100;
    }
    
    .gh-status { 
      margin-top: 12px; 
      font-size: 1em; 
      color: var(--success-color);
      padding: 10px;
      border-radius: 6px;
      background: #f0f9f0;
      border: 1px solid #d4edda;
    }
    
    .gh-status.error {
      color: #d73a49;
      background: #fdf2f2;
      border-color: #f5c6cb;
    }
    
    .gh-status.warning {
      color: #856404;
      background: #fff3cd;
      border-color: #ffeaa7;
    }
    
    #preview-files, 
    #zip-details { 
      margin-top: 15px; 
      font-size: .97em; 
      background: #f6f8fa; 
      border-radius: 8px; 
      border: 1px solid var(--border-color); 
      padding: 15px; 
      word-break: break-all;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .file-editbox { 
      width: 98%; 
      min-height: 60px; 
      font-size: .97em; 
      border: 1px solid var(--border-color); 
      border-radius: 6px; 
      margin:8px 0; 
      background:#fff; 
      color:var(--text-color); 
      font-family: 'Courier New', monospace;
      resize: vertical;
      padding: 10px;
    }
    
    .file-editbox:focus { 
      border-color: var(--primary-color); 
      outline: none;
      box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.1);
    }
    
    footer { 
      text-align: center; 
      background: rgba(255, 255, 255, 0.9); 
      border-top: 1px solid var(--border-color); 
      padding: 15px 0 10px 0; 
      font-size: .97em; 
      color: #586069;
      margin-top: 30px;
      backdrop-filter: blur(10px);
    }
    
    footer a { 
      color: var(--primary-color); 
      text-decoration: none;
      font-weight: 500;
    }
    
    footer a:hover { 
      text-decoration: underline;
    }
    
    hr { 
      border: none; 
      border-bottom: 1px solid var(--border-color); 
      margin: 25px 0 15px 0;
    }
    
    .ai-suggestions {
      margin-top: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #f0f8ff 0%, #e6f7ff 100%);
      border-radius: 10px;
      border: 1px solid #c8e1ff;
    }
    
    .ai-suggestions h3 {
      margin-top: 0;
      font-size: 1.1em;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .ai-suggestions button {
      background: var(--primary-color);
      margin-top: 12px;
    }
    
    .ai-suggestions button:hover {
      background: #0256b3;
    }
    
    .suggestion-content {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      font-size: 0.95em;
      white-space: pre-wrap;
    }
    
    .code-block {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      margin: 12px 0;
      font-family: 'Courier New', monospace;
      overflow-x: auto;
      position: relative;
      border: 1px solid #444;
    }
    
    .code-block::before {
      content: attr(data-language);
      position: absolute;
      top: 0;
      right: 0;
      background: #007acc;
      color: white;
      padding: 4px 12px;
      font-size: 0.8em;
      border-radius: 0 6px 0 6px;
      font-weight: 600;
    }
    
    .loading {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .three-column {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
    }
    
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .idea-input {
      min-height: 100px;
      font-size: 1em;
    }
    
    .suggestion-actions {
      display: flex;
      gap: 12px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .logo-preview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    
    .logo-option {
      text-align: center;
      padding: 15px;
      border: 2px solid transparent;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .logo-option:hover {
      border-color: var(--primary-color);
      transform: translateY(-3px);
    }
    
    .logo-option.selected {
      border-color: var(--success-color);
      background: #f0f9f0;
    }
    
    .logo-img {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      margin-bottom: 8px;
      border: 1px solid var(--border-color);
    }
    
    .verification-step {
      padding: 10px 15px;
      margin: 8px 0;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 4px solid var(--primary-color);
    }
    
    .verification-step.success {
      border-left-color: var(--success-color);
      background: #f0f9f0;
    }
    
    .verification-step.error {
      border-left-color: #d73a49;
      background: #fdf2f2;
    }
    
    .advanced-options {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }
    
    .theme-selector {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    
    .theme-option {
      padding: 8px 15px;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
    }
    
    .theme-option:hover {
      border-color: var(--primary-color);
    }
    
    .theme-option.selected {
      border-color: var(--primary-color);
      background: var(--primary-color);
      color: white;
    }
    
    @media (max-width: 968px) {
      .three-column {
        grid-template-columns: 1fr;
      }
      .two-column {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .suggestion-actions {
        flex-direction: column;
      }
      main {
        margin: 15px 10px;
        padding: 15px;
      }
    }
    
    @media (max-width:520px){
      main{
        max-width:97vw;
        padding:5vw;
        margin: 10px auto;
      }
      .gh-header{
        padding:5vw 4vw;
      }
    }
  </style>
</head>
<body>
<header class="gh-header">
  <img id="main-logo" src="https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/assets/product_logo.png" alt="Logo" class="gh-logo">
  <h1>Influent Package Maker Web - Asistente IA</h1>
</header>
<main>
  <section>
    <h2>üöÄ Crear Proyecto Influent con IA</h2>
    <div class="three-column">
      <div class="gh-form">
        <label><span>Fabricante</span><input name="empresa" type="text" required value="influent"></label>
        <label><span>Nombre interno</span><input name="nombre" type="text" required></label>
        <label><span>Versi√≥n</span><input name="version" type="text" required value="1.0"></label>
        <label><span>T√≠tulo completo</span><input name="titulo" type="text" required></label>
        
        <div class="advanced-options">
          <label><span>Tema de la aplicaci√≥n</span>
            <select name="tema">
              <option value="calculadora">Calculadora/Cient√≠fico</option>
              <option value="educativo">Educativo</option>
              <option value="negocios">Negocios/Productividad</option>
              <option value="juegos">Juegos/Entretenimiento</option>
              <option value="utilidades">Utilidades del Sistema</option>
              <option value="multimedia">Multimedia</option>
              <option value="desarrollo">Desarrollo/Programaci√≥n</option>
            </select>
          </label>
          
          <label><span>Complejidad</span>
            <select name="complejidad">
              <option value="basica">B√°sica</option>
              <option value="intermedia" selected>Intermedia</option>
              <option value="avanzada">Avanzada</option>
            </select>
          </label>
        </div>
        
        <button type="button" id="btn-generar-ia" class="gh-btn warning">üéØ Generar Todo con IA</button>
      </div>
      
      <div class="ai-suggestions">
        <h3>üí° Descripci√≥n de la Aplicaci√≥n</h3>
        <p>Describe tu idea en detalle para que la IA pueda generar c√≥digo, estructura y dise√±o completos:</p>
        <label>
          <span>Tu idea (ej: "calculadora cient√≠fica con gr√°ficos, historial y temas")</span>
          <textarea id="idea-input" class="idea-input" placeholder="Describe funcionalidades, interfaz, caracter√≠sticas especiales..."></textarea>
        </label>
        
        <div class="theme-selector">
          <div class="theme-option" data-theme="blue-purple">Azul-Morado</div>
          <div class="theme-option" data-theme="green-teal">Verde-Turquesa</div>
          <div class="theme-option" data-theme="orange-red">Naranja-Rojo</div>
          <div class="theme-option" data-theme="purple-pink">Morado-Rosa</div>
        </div>
        
        <button id="btn-suggest" class="gh-btn secondary">
          <span id="suggest-text">üß† Analizar y Generar</span>
          <span id="suggest-loading" class="loading" style="display:none;"></span>
        </button>
        
        <div id="verification-steps"></div>
      </div>
      
      <div id="suggestion-content" class="suggestion-content" style="display:none;"></div>
    </div>
    
    <div id="create-status" class="gh-status"></div>
    
    <div id="logo-section" style="display:none; margin-top: 20px;">
      <h3>üé® Logotipos Generados</h3>
      <div class="logo-preview" id="logo-preview"></div>
    </div>
    
    <div id="preview-files" style="display:none;"></div>
    
    <div class="suggestion-actions" id="final-actions" style="display:none; margin-top: 20px;">
      <button id="btn-download" class="gh-btn">üì¶ Descargar Paquete Completado</button>
      <button id="btn-optimize" class="gh-btn secondary">‚ö° Optimizar con IA</button>
      <button id="btn-validate" class="gh-btn warning">üîç Validar C√≥digo</button>
    </div>
  </section>
  
  <hr>
  
  <section>
    <h2>üìÅ Instalar/Explorar Paquete Existente</h2>
    <form class="gh-form">
      <label><span>Selecciona paquete ZIP (.iflapp/.iflappb)</span><input type="file" accept=".zip,.iflapp,.iflappb" id="zipfile"></label>
    </form>
    <div id="install-status" class="gh-status"></div>
    <div id="zip-details"></div>
  </section>
</main>

<footer>
  <span>GitHub: <a href="https://github.com/JesusQuijada34/packagemaker/">packagemaker</a> | 
  Desarrollado con ‚ô• y Gemini AI | 
  <a href="#" id="ethics-link">√âtica y Directrices</a></span>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
// --- Protecci√≥n de API Key ---
const API_KEY_PARTS = [
  "AIzaSyDD8X1GvPm6j3axGaW",
  "z-pmjKSQXdP8eci4"
];
const GEMINI_API_KEY = API_KEY_PARTS.join("");

// --- Constantes y Configuraci√≥n ---
const RAW_ICON_URL = "https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/assets/product_logo.png";
const RAW_LICENSE_URL = "https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/LICENSE";
const DEFAULT_FOLDERS = ["app","assets","config","docs","source","lib","tests","resources"];

// Temas de colores
const THEMES = {
  "blue-purple": { start: "#667eea", end: "#764ba2" },
  "green-teal": { start: "#4facfe", end: "#00f2fe" },
  "orange-red": { start: "#fa709a", end: "#fee140" },
  "purple-pink": { start: "#a8edea", end: "#fed6e3" }
};

// --- Utilidades ---
function getversion() {
  const d = new Date();
  return `${d.getFullYear().toString().slice(-2)}.${(d.getMonth()+1)}-${d.getHours()}.${d.getMinutes()}`;
}

async function sha256(str) {
  const buf = new TextEncoder().encode(str);
  const hash = await window.crypto.subtle.digest('SHA-256', buf);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

// --- Sistema de Verificaci√≥n en Bucle ---
let verificationAttempts = 0;
const MAX_VERIFICATION_ATTEMPTS = 3;

async function verifyWithAI(content, type, context) {
  const prompt = `
  Eres un verificador de c√≥digo y contenido especializado. Analiza el siguiente ${type}:

  CONTENIDO:
  ${content}

  CONTEXTO: ${context}

  DIRECTRICES √âTICAS Y T√âCNICAS:
  1. El c√≥digo debe ser seguro, eficiente y seguir mejores pr√°cticas
  2. El contenido debe ser apropiado y profesional
  3. La estructura debe ser l√≥gica y mantenible
  4. Cumplir con est√°ndares de calidad de software

  Responde EXCLUSIVAMENTE con un JSON:
  {
    "is_valid": true/false,
    "issues": ["lista de problemas encontrados"],
    "suggestions": ["sugerencias de mejora"],
    "confidence_score": 0-100
  }

  Solo marca como v√°lido si cumple completamente con las directrices.`;
  
  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });
    
    if (!response.ok) throw new Error(`Error en la API: ${response.status}`);
    
    const data = await response.json();
    const resultText = data.candidates[0].content.parts[0].text;
    const jsonMatch = resultText.match(/\{[\s\S]*\}/);
    
    if (jsonMatch) {
      return JSON.parse(jsonMatch[0]);
    } else {
      return { is_valid: false, issues: ["Formato de respuesta inv√°lido"], suggestions: [], confidence_score: 0 };
    }
  } catch (error) {
    console.error('Error en verificaci√≥n:', error);
    return { is_valid: false, issues: ["Error de conexi√≥n con IA"], suggestions: [], confidence_score: 0 };
  }
}

// --- Gemini AI Integration Mejorada ---
async function getCompleteProjectAnalysis(idea, tema, complejidad) {
  const prompt = `
  Eres un arquitecto de software senior especializado en aplicaciones Python con PyQt5. 
  El usuario quiere crear: "${idea}"
  
  TEMA: ${tema}
  COMPLEJIDAD: ${complejidad}
  
  DIRECTRICES √âTICAS Y T√âCNICAS:
  1. Generar c√≥digo seguro, eficiente y mantenible
  2. Seguir patrones de dise√±o apropiados
  3. Incluir manejo de errores robusto
  4. Documentaci√≥n clara y concisa
  5. Interfaz de usuario intuitiva y accesible
  6. Estructura de proyecto profesional
  
  Responde EXCLUSIVAMENTE en el siguiente formato JSON:

  {
    "project_analysis": {
      "suggested_name": "nombre_autoexplicativo",
      "suggested_title": "T√≠tulo Atractivo y Descriptivo",
      "description": "Descripci√≥n completa del proyecto",
      "complexity_analysis": "An√°lisis de complejidad t√©cnica",
      "ethical_considerations": "Consideraciones √©ticas relevantes"
    },
    "structure": {
      "folders": ["lista", "de", "carpetas", "adicionales"],
      "files": {
        "ruta/archivo.py": "contenido completo del archivo",
        "ruta/otro.txt": "contenido de otro archivo"
      },
      "dependencies": ["lista", "de", "dependencias"]
    },
    "design": {
      "color_scheme": {
        "primary": "#color",
        "secondary": "#color", 
        "accent": "#color"
      },
      "ui_recommendations": ["lista de recomendaciones de UI"],
      "logo_concepts": ["concepto1", "concepto2", "concepto3"]
    }
  }

  Genera una estructura completa y profesional. Incluye al menos 8 archivos esenciales.`;
  
  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });
    
    if (!response.ok) throw new Error(`Error en la API: ${response.status}`);
    
    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
  } catch (error) {
    console.error('Error en an√°lisis completo:', error);
    throw error;
  }
}

// --- Generaci√≥n de Logotipos ---
async function generateLogos(concepts, projectName) {
  // En un entorno real, aqu√≠ se integrar√≠a con una API de generaci√≥n de im√°genes
  // Por ahora simulamos la generaci√≥n de logotipos
  return concepts.map((concept, index) => {
    const colors = ['#667eea', '#764ba2', '#4facfe', '#00f2fe', '#fa709a', '#fee140'];
    const color1 = colors[index % colors.length];
    const color2 = colors[(index + 2) % colors.length];
    
    return {
      concept: concept,
      url: `https://via.placeholder.com/200x200/${color1.replace('#', '')}/${color2.replace('#', '')}?text=${encodeURIComponent(projectName)}`,
      description: concept
    };
  });
}

// --- Aplicaci√≥n de Tema de Colores ---
function applyTheme(themeName) {
  const theme = THEMES[themeName];
  if (theme) {
    document.documentElement.style.setProperty('--gradient-start', theme.start);
    document.documentElement.style.setProperty('--gradient-end', theme.end);
  }
}

// --- Manejo de Verificaci√≥n en Bucle ---
async function verifyAllContent(files, context) {
  const verificationSteps = document.getElementById('verification-steps');
  verificationSteps.innerHTML = '<div class="verification-step">üîÑ Iniciando verificaci√≥n de contenido...</div>';
  
  let allValid = true;
  const issues = [];
  
  for (const [filePath, content] of Object.entries(files)) {
    if (typeof content === 'string') {
      verificationSteps.innerHTML += `<div class="verification-step">üîç Verificando: ${filePath}</div>`;
      
      const result = await verifyWithAI(content, 
        filePath.endsWith('.py') ? 'c√≥digo Python' : 'contenido de archivo',
        `${context} - Archivo: ${filePath}`
      );
      
      if (result.is_valid) {
        verificationSteps.innerHTML += `<div class="verification-step success">‚úÖ ${filePath} - V√°lido (Confianza: ${result.confidence_score}%)</div>`;
      } else {
        verificationSteps.innerHTML += `<div class="verification-step error">‚ùå ${filePath} - Problemas encontrados</div>`;
        issues.push({ file: filePath, problems: result.issues });
        allValid = false;
      }
      
      // Peque√±a pausa para no saturar la API
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
  }
  
  return { allValid, issues };
}
<script>
// --- Implementaci√≥n de Event Listeners ---
let currentProjectData = null;
let lastFiles = null;

// Selectores de tema
document.querySelectorAll('.theme-option').forEach(option => {
  option.addEventListener('click', function() {
    document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('selected'));
    this.classList.add('selected');
    applyTheme(this.dataset.theme);
  });
});

// Bot√≥n principal de generaci√≥n con IA
document.getElementById('btn-generar-ia').addEventListener('click', async function() {
  const ideaInput = document.getElementById('idea-input').value.trim();
  if (!ideaInput) {
    document.getElementById('create-status').textContent = "‚ùå Por favor, describe tu idea primero";
    document.getElementById('create-status').className = "gh-status error";
    return;
  }

  const tema = document.querySelector('select[name="tema"]').value;
  const complejidad = document.querySelector('select[name="complejidad"]').value;
  
  await generateCompleteProject(ideaInput, tema, complejidad);
});

// Bot√≥n de an√°lisis y generaci√≥n
document.getElementById('btn-suggest').addEventListener('click', async function() {
  const ideaInput = document.getElementById('idea-input').value.trim();
  if (!ideaInput) {
    document.getElementById('create-status').textContent = "‚ùå Por favor, describe tu idea primero";
    document.getElementById('create-status').className = "gh-status error";
    return;
  }

  const tema = document.querySelector('select[name="tema"]').value;
  const complejidad = document.querySelector('select[name="complejidad"]').value;
  
  await generateCompleteProject(ideaInput, tema, complejidad);
});

// Funci√≥n principal de generaci√≥n de proyecto
async function generateCompleteProject(idea, tema, complejidad) {
  const suggestBtn = document.getElementById('btn-suggest');
  const suggestText = document.getElementById('suggest-text');
  const suggestLoading = document.getElementById('suggest-loading');
  const statusElement = document.getElementById('create-status');
  
  // Mostrar estado de carga
  suggestText.textContent = "Analizando y generando...";
  suggestLoading.style.display = "inline-block";
  suggestBtn.disabled = true;
  statusElement.textContent = "üöÄ Iniciando generaci√≥n completa del proyecto...";
  statusElement.className = "gh-status";
  
  try {
    // Paso 1: An√°lisis completo del proyecto
    statusElement.textContent = "üìã Analizando requisitos y estructura...";
    const analysisResponse = await getCompleteProjectAnalysis(idea, tema, complejidad);
    
    let projectData;
    try {
      const jsonMatch = analysisResponse.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        projectData = JSON.parse(jsonMatch[0]);
      } else {
        throw new Error("Formato de respuesta inv√°lido");
      }
    } catch (parseError) {
      console.error("Error parseando JSON:", parseError);
      statusElement.textContent = "‚ùå Error en el formato de respuesta de la IA";
      statusElement.className = "gh-status error";
      return;
    }
    
    currentProjectData = projectData;
    
    // Paso 2: Aplicar datos al formulario
    const form = document.getElementById('create-form');
    form.nombre.value = projectData.project_analysis.suggested_name;
    form.titulo.value = projectData.project_analysis.suggested_title;
    form.empresa.value = "influent";
    form.version.value = "1.0";
    
    // Paso 3: Generar estructura de archivos
    statusElement.textContent = "üìÅ Generando estructura de archivos...";
    const folder_name = `influent.${projectData.project_analysis.suggested_name}.v1.0-${getversion()}-danenone`;
    const hv = await sha256(`influent.${projectData.project_analysis.suggested_name}.v1.0`);
    
    const files = {};
    
    // Crear carpetas base
    [...DEFAULT_FOLDERS, ...(projectData.structure.folders || [])].forEach(f => {
      files[`${folder_name}/${f}/.${f}-container`] = `#store (sha256 hash):${f}/.${hv}`;
    });
    
    // Archivos generados por IA
    Object.entries(projectData.structure.files || {}).forEach(([filePath, content]) => {
      files[`${folder_name}/${filePath}`] = content;
    });
    
    // Archivos esenciales
    files[`${folder_name}/README.md`] = `# ${projectData.project_analysis.suggested_title}\n\n${projectData.project_analysis.description}\n\n## Caracter√≠sticas\n\n- Desarrollado con Influent Package Maker Web\n- ${projectData.project_analysis.complexity_analysis}\n\n## Consideraciones √âticas\n\n${projectData.project_analysis.ethical_considerations}`;
    
    files[`${folder_name}/lib/requirements.txt`] = (projectData.structure.dependencies || ["PyQt5", "numpy"]).join("\n");
    
    // Paso 4: Verificaci√≥n en bucle
    statusElement.textContent = "üîç Verificando calidad del c√≥digo y contenido...";
    const verificationResult = await verifyAllContent(files, projectData.project_analysis.description);
    
    if (!verificationResult.allValid) {
      statusElement.textContent = "‚ö†Ô∏è Se encontraron problemas durante la verificaci√≥n";
      statusElement.className = "gh-status warning";
      
      // Mostrar problemas encontrados
      let issuesHtml = "<h4>Problemas encontrados:</h4>";
      verificationResult.issues.forEach(issue => {
        issuesHtml += `<div class="verification-step error"><strong>${issue.file}:</strong> ${issue.problems.join(', ')}</div>`;
      });
      document.getElementById('verification-steps').innerHTML += issuesHtml;
    } else {
      statusElement.textContent = "‚úÖ Todo el contenido verificado correctamente";
      statusElement.className = "gh-status";
    }
    
    // Paso 5: Generar logotipos
    statusElement.textContent = "üé® Generando conceptos de logotipo...";
    const logos = await generateLogos(projectData.design.logo_concepts || ["Moderno", "Minimalista", "Profesional"], 
                                    projectData.project_analysis.suggested_title);
    
    // Mostrar logotipos
    const logoSection = document.getElementById('logo-section');
    const logoPreview = document.getElementById('logo-preview');
    
    logoPreview.innerHTML = logos.map((logo, index) => `
      <div class="logo-option" data-logo-index="${index}">
        <img src="${logo.url}" alt="${logo.concept}" class="logo-img">
        <div><strong>${logo.concept}</strong></div>
        <small>${logo.description}</small>
      </div>
    `).join('');
    
    logoSection.style.display = 'block';
    
    // Paso 6: Mostrar archivos generados
    let html = `<h3>üìÇ Estructura Generada para: ${projectData.project_analysis.suggested_title}</h3>`;
    html += `<p><strong>Descripci√≥n:</strong> ${projectData.project_analysis.description}</p>`;
    html += `<div class="two-column"><div><h4>Archivos y Carpetas:</h4><ul>`;
    
    Object.keys(files).forEach(f => {
      let ext = f.split('.').pop();
      html += `<li>${f} ${ext==="py"?"<span style='color:#2ea44f;'>(Python)</span>":ext==="txt"?"<span style='color:#0366d6;'>(Texto)</span>":""}</li>`;
    });
    
    html += `</ul></div><div><h4>Dependencias:</h4><ul>`;
    (projectData.structure.dependencies || ["PyQt5"]).forEach(dep => {
      html += `<li>${dep}</li>`;
    });
    html += `</ul></div></div>`;
    
    html += `<hr><h4>Edita archivos antes de descargar:</h4>`;
    Object.keys(files).forEach(f => {
      if (typeof files[f] === "string" && (f.endsWith(".py") || f.endsWith(".md") || f.endsWith(".txt"))) {
        html += `<details open><summary>${f}</summary>
        <textarea class="file-editbox" data-file="${f}">${files[f]}</textarea></details>`;
      }
    });
    
    document.getElementById('preview-files').innerHTML = html;
    document.getElementById('preview-files').style.display = 'block';
    document.getElementById('final-actions').style.display = 'flex';
    
    lastFiles = files;
    currentProjectData = projectData;
    
    statusElement.textContent = `‚úÖ Proyecto "${projectData.project_analysis.suggested_title}" generado exitosamente!`;
    
  } catch (error) {
    console.error("Error en generaci√≥n completa:", error);
    statusElement.textContent = "‚ùå Error durante la generaci√≥n: " + error.message;
    statusElement.className = "gh-status error";
  } finally {
    // Restaurar estado del bot√≥n
    suggestText.textContent = "üß† Analizar y Generar";
    suggestLoading.style.display = "none";
    suggestBtn.disabled = false;
  }
}

// Bot√≥n de descarga
document.getElementById('btn-download').addEventListener('click', async function() {
  if (!lastFiles) return;
  
  const statusElement = document.getElementById('create-status');
  statusElement.textContent = "üì¶ Empacando y verificando final...";
  
  // Recoger ediciones
  document.querySelectorAll(".file-editbox").forEach(e => {
    lastFiles[e.dataset.file] = e.value;
  });
  
  // Verificaci√≥n final
  const finalVerification = await verifyAllContent(lastFiles, "Verificaci√≥n final antes de descargar");
  
  if (!finalVerification.allValid) {
    statusElement.textContent = "‚ùå No se puede descargar - Hay problemas en el contenido";
    statusElement.className = "gh-status error";
    return;
  }
  
  // Generar ZIP
  const zip = new JSZip();
  for (const f in lastFiles) {
    if (typeof lastFiles[f] === "string") {
      zip.file(f, lastFiles[f]);
    }
  }
  
  let folder_name = Object.keys(lastFiles)[0].split("/")[0];
  zip.generateAsync({ type: "blob" }).then(blob => {
    saveAs(blob, `${folder_name}.iflapp`);
    statusElement.textContent = `‚úÖ Paquete descargado: ${folder_name}.iflapp`;
  });
});

// Bot√≥n de optimizaci√≥n
document.getElementById('btn-optimize').addEventListener('click', async function() {
  // Implementar optimizaci√≥n con IA
  alert("üöÄ Funci√≥n de optimizaci√≥n con IA - Pr√≥ximamente!");
});

// Bot√≥n de validaci√≥n
document.getElementById('btn-validate').addEventListener('click', async function() {
  if (!lastFiles) return;
  
  const statusElement = document.getElementById('create-status');
  statusElement.textContent = "üîç Ejecutando validaci√≥n completa...";
  
  const result = await verifyAllContent(lastFiles, "Validaci√≥n completa solicitada por usuario");
  
  if (result.allValid) {
    statusElement.textContent = "‚úÖ Validaci√≥n completada - Todo el c√≥digo es correcto";
    statusElement.className = "gh-status";
  } else {
    statusElement.textContent = "‚ö†Ô∏è Validaci√≥n completada - Se encontraron problemas";
    statusElement.className = "gh-status warning";
  }
});

// Enlace de √©tica
document.getElementById('ethics-link').addEventListener('click', function(e) {
  e.preventDefault();
  alert(`DIRECTRICES √âTICAS DEL SISTEMA:

1. SEGURIDAD: Todo el c√≥digo generado debe ser seguro y no contener vulnerabilidades
2. PRIVACIDAD: Respetar la privacidad del usuario y no recopilar datos sensibles
3. TRANSPARENCIA: El c√≥digo debe ser claro y comprensible
4. ACCESIBILIDAD: Las interfaces deben ser accesibles para todos los usuarios
5. LEGALIDAD: Cumplir con todas las leyes y regulaciones aplicables
6. BENEFICIO: El software debe proporcionar valor real a los usuarios

Estas directrices son aplicadas autom√°ticamente por el sistema de verificaci√≥n.`);
});

// Inicializar con tema por defecto
applyTheme('blue-purple');
document.querySelector('.theme-option[data-theme="blue-purple"]').classList.add('selected');
</script>
</body>
</html>
