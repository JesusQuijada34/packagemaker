<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Influent Package Maker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --primary-color: #0969da;
      --success-color: #1a7f37;
      --warning-color: #9a6700;
      --error-color: #cf222e;
      --bg-color: #ffffff;
      --sidebar-bg: #f6f8fa;
      --border-color: #d0d7de;
      --text-color: #24292f;
      --text-muted: #57606a;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.5;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    
    .sidebar {
      width: 300px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border-color);
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-color);
    }
    
    .header h1 {
      font-size: 16px;
      font-weight: 600;
    }
    
    .content-area {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .section {
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 6px;
    }
    
    .section-header {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      background: var(--sidebar-bg);
    }
    
    .section-title {
      font-size: 14px;
      font-weight: 600;
    }
    
    .section-body {
      padding: 16px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 4px;
      font-size: 14px;
    }
    
    .form-control {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 14px;
      background: var(--bg-color);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.1);
    }
    
    .textarea {
      min-height: 100px;
      resize: vertical;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 13px;
    }
    
    .btn {
      padding: 8px 16px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-color);
      color: var(--text-color);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn:hover {
      background: var(--sidebar-bg);
    }
    
    .btn-primary {
      background: var(--success-color);
      border-color: var(--success-color);
      color: white;
    }
    
    .btn-primary:hover {
      background: #1a7f37;
      border-color: #1a7f37;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .status {
      padding: 12px;
      border-radius: 6px;
      margin: 12px 0;
      font-size: 14px;
    }
    
    .status-success {
      background: #dafbe1;
      border: 1px solid #ace1af;
      color: var(--success-color);
    }
    
    .status-error {
      background: #ffebe9;
      border: 1px solid #ffcecb;
      color: var(--error-color);
    }
    
    .status-warning {
      background: #fff8c5;
      border: 1px solid #fae17d;
      color: var(--warning-color);
    }
    
    .status-info {
      background: #ddf4ff;
      border: 1px solid #b6e3ff;
      color: var(--primary-color);
    }
    
    .console {
      background: #0d1117;
      color: #e6edf3;
      border-radius: 6px;
      padding: 16px;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 13px;
      line-height: 1.45;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    
    .console-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #30363d;
    }
    
    .console-title {
      font-weight: 600;
      color: #7d8590;
    }
    
    .console-content {
      flex: 1;
      overflow-y: auto;
    }
    
    .console-line {
      margin-bottom: 8px;
      padding: 4px 0;
    }
    
    .console-timestamp {
      color: #7d8590;
      margin-right: 8px;
    }
    
    .console-info {
      color: #7ee787;
    }
    
    .console-warning {
      color: #f2cc60;
    }
    
    .console-error {
      color: #ff7b72;
    }
    
    .console-debug {
      color: #a5d6ff;
    }
    
    .file-tree {
      background: var(--sidebar-bg);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 16px;
      margin: 16px 0;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .file-item {
      padding: 4px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .file-icon {
      color: var(--text-muted);
      width: 16px;
      text-align: center;
    }
    
    .code-block {
      background: #0d1117;
      color: #e6edf3;
      padding: 16px;
      border-radius: 6px;
      margin: 12px 0;
      overflow-x: auto;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 13px;
      line-height: 1.45;
    }
    
    .code-block-header {
      background: #161b22;
      margin: -16px -16px 16px -16px;
      padding: 12px 16px;
      border-bottom: 1px solid #30363d;
      font-size: 12px;
      color: #7d8590;
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid currentColor;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .progress-bar {
      width: 100%;
      height: 4px;
      background: var(--border-color);
      border-radius: 2px;
      overflow: hidden;
      margin: 8px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--success-color);
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Configuraci√≥n del Proyecto</h2>
      </div>
      <div class="section-body">
        <div class="form-group">
          <label class="form-label">Fabricante</label>
          <input type="text" class="form-control" id="empresa" value="influent" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Nombre interno</label>
          <input type="text" class="form-control" id="nombre" value="scicalc" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Versi√≥n</label>
          <input type="text" class="form-control" id="version" value="1.0.0" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">T√≠tulo completo</label>
          <input type="text" class="form-control" id="titulo" value="Scientific Calculator Pro" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Tipo de aplicaci√≥n</label>
          <select class="form-control" id="tipo">
            <option value="calculadora">Calculadora/Cient√≠fica</option>
            <option value="utilidad">Utilidad del Sistema</option>
            <option value="herramienta">Herramienta de Desarrollo</option>
            <option value="productividad">Productividad</option>
            <option value="multimedia">Multimedia</option>
          </select>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Descripci√≥n con IA</h2>
      </div>
      <div class="section-body">
        <div class="form-group">
          <label class="form-label">Describe tu aplicaci√≥n en detalle</label>
          <textarea class="form-control textarea" id="idea-input">Calculadora cient√≠fica con interfaz moderna PyQt5, funciones trigonom√©tricas, historial de operaciones, temas claros/oscuros y exportaci√≥n de resultados.</textarea>
        </div>
        
        <button class="btn btn-primary" id="btn-generar">
          <span id="btn-text">üöÄ Generar Proyecto Completo</span>
          <span id="btn-loading" class="loading" style="display: none;"></span>
        </button>
        
        <div class="progress-bar" id="progress-bar" style="display: none;">
          <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <div class="section" id="results-section" style="display: none;">
      <div class="section-header">
        <h2 class="section-title">Resultados</h2>
      </div>
      <div class="section-body">
        <div id="file-tree" class="file-tree">
          <!-- Estructura de archivos se insertar√° aqu√≠ -->
        </div>
        
        <div class="form-group">
          <button class="btn btn-primary" id="btn-descargar">üì¶ Descargar Paquete .iflapp</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h1>Influent Package Maker - Consola de Desarrollo</h1>
    </div>
    
    <div class="content-area">
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">Consola de Debug</h2>
        </div>
        <div class="section-body" style="padding: 0; height: 500px;">
          <div class="console">
            <div class="console-header">
              <div class="console-title">Actividad del Sistema</div>
              <button class="btn" id="btn-clear-console" style="font-size: 12px; padding: 4px 8px;">Limpiar</button>
            </div>
            <div class="console-content" id="console-content">
              <div class="console-line">
                <span class="console-timestamp" id="current-time"></span>
                <span class="console-info">‚úÖ Sistema inicializado correctamente</span>
              </div>
              <div class="console-line">
                <span class="console-timestamp" id="current-time2"></span>
                <span class="console-info">üí° Completa la descripci√≥n y haz clic en Generar Proyecto</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <h2 class="section-title">Vista Previa del C√≥digo</h2>
        </div>
        <div class="section-body">
          <div id="code-preview">
            <div class="code-block">
              <div class="code-block-header">Esperando generaci√≥n de c√≥digo...</div>
              <pre>El c√≥digo generado aparecer√° aqu√≠ despu√©s de que completes la descripci√≥n y hagas clic en "Generar Proyecto Completo".</pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
  // =============================================
  // CONFIGURACI√ìN Y CONSTANTES
  // =============================================
  const GEMINI_API_KEY = "AIzaSyDD8X1GvPm6j3axGaWz-pmjKSQXdP8eci4";
  const DEFAULT_FOLDERS = ["app", "assets", "config", "docs", "source", "lib", "tests"];
  let currentProjectData = null;
  let lastFiles = null;

  // =============================================
  // SISTEMA DE LOGGING Y CONSOLA
  // =============================================
  function getCurrentTime() {
    return new Date().toLocaleTimeString();
  }

  function logToConsole(message, type = "info") {
    const consoleContent = document.getElementById('console-content');
    const timestamp = getCurrentTime();
    
    const line = document.createElement('div');
    line.className = 'console-line';
    
    const timeSpan = document.createElement('span');
    timeSpan.className = 'console-timestamp';
    timeSpan.textContent = `[${timestamp}]`;
    
    const messageSpan = document.createElement('span');
    messageSpan.className = `console-${type}`;
    messageSpan.textContent = message;
    
    line.appendChild(timeSpan);
    line.appendChild(messageSpan);
    consoleContent.appendChild(line);
    
    // Auto-scroll to bottom
    consoleContent.scrollTop = consoleContent.scrollHeight;
    
    // Tambi√©n log a la consola del navegador
    console.log(`[${timestamp}] ${message}`);
  }

  function updateProgress(percent, message = "") {
    const progressBar = document.getElementById('progress-bar');
    const progressFill = document.getElementById('progress-fill');
    
    progressBar.style.display = 'block';
    progressFill.style.width = `${percent}%`;
    
    if (message) {
      logToConsole(message, "info");
    }
  }

  function hideProgress() {
    document.getElementById('progress-bar').style.display = 'none';
  }

  // =============================================
  // UTILIDADES B√ÅSICAS
  // =============================================
  function getTimestamp() {
    const d = new Date();
    return `${d.getFullYear().toString().slice(-2)}.${(d.getMonth()+1).toString().padStart(2, '0')}-${d.getHours().toString().padStart(2, '0')}.${d.getMinutes().toString().padStart(2, '0')}`;
  }

  async function sha256(str) {
    const buf = new TextEncoder().encode(str);
    const hash = await window.crypto.subtle.digest('SHA-256', buf);
    return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, "0")).join("");
  }

  function escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // =============================================
  // COMUNICACI√ìN CON GEMINI AI
  // =============================================
  async function callGeminiAPI(prompt, context = "Generaci√≥n") {
    logToConsole(`üì° Enviando solicitud a Gemini: ${context}`, "debug");
    
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{
            parts: [{ text: prompt }]
          }],
          generationConfig: {
            temperature: 0.2,
            maxOutputTokens: 4096,
            topP: 0.8,
            topK: 40
          }
        })
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP ${response.status}: ${errorText}`);
      }

      const data = await response.json();
      
      if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
        throw new Error("Respuesta de API inv√°lida: estructura incorrecta");
      }
      
      const resultText = data.candidates[0].content.parts[0].text;
      logToConsole(`‚úÖ Respuesta recibida de Gemini (${resultText.length} caracteres)`, "debug");
      
      return resultText;
    } catch (error) {
      logToConsole(`‚ùå Error en API Gemini: ${error.message}`, "error");
      throw error;
    }
  }

  // =============================================
  // GENERACI√ìN DE PROYECTO CON IA
  // =============================================
  async function generateProjectWithAI(idea, projectConfig) {
    updateProgress(10, "üß† Analizando requisitos con IA...");
    
    const prompt = `Eres un experto en desarrollo de aplicaciones Python con PyQt5. 

CONFIGURACI√ìN DEL PROYECTO:
- Idea: ${idea}
- Fabricante: ${projectConfig.empresa}
- Nombre interno: ${projectConfig.nombre}
- Versi√≥n: ${projectConfig.version}
- T√≠tulo: ${projectConfig.titulo}
- Tipo: ${projectConfig.tipo}

REQUISITOS:
1. Genera una aplicaci√≥n Python completa con PyQt5
2. C√≥digo funcional y bien estructurado
3. Interfaz de usuario moderna
4. Manejo de errores robusto
5. Documentaci√≥n clara

RESPONDE EXCLUSIVAMENTE con este formato JSON:

{
  "project_structure": {
    "folders": ["app", "config", "lib", "assets"],
    "files": {
      "main.py": "c√≥digo python completo aqu√≠",
      "requirements.txt": "PyQt5\\n...",
      "README.md": "# T√≠tulo\\nDescripci√≥n...",
      "config/settings.json": "configuraci√≥n en JSON",
      "lib/utils.py": "funciones utilitarias"
    }
  },
  "metadata": {
    "description": "Descripci√≥n completa",
    "dependencies": ["PyQt5", "numpy"],
    "entry_point": "main.py"
  }
}

Genera c√≥digo REAL y FUNCIONAL. El usuario debe poder ejecutarlo inmediatamente.`;

    try {
      const response = await callGeminiAPI(prompt, "Generaci√≥n de proyecto");
      
      // Intentar extraer JSON
      const jsonMatch = response.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        return JSON.parse(jsonMatch[0]);
      } else {
        logToConsole("‚ö†Ô∏è No se pudo extraer JSON de la respuesta, usando proyecto por defecto", "warning");
        return createFallbackProject(idea, projectConfig);
      }
    } catch (error) {
      logToConsole("‚ùå Error en generaci√≥n con IA, usando proyecto por defecto", "error");
      return createFallbackProject(idea, projectConfig);
    }
  }

  function createFallbackProject(idea, projectConfig) {
    logToConsole("üîÑ Creando proyecto b√°sico por defecto...", "warning");
    
    return {
      project_structure: {
        folders: ["app", "config", "lib"],
        files: {
          "main.py": `#!/usr/bin/env python3
# ${projectConfig.titulo}
# Versi√≥n: ${projectConfig.version}

import sys
import os
from PyQt5.QtWidgets import (QApplication, QMainWindow, QVBoxLayout, 
                             QWidget, QPushButton, QLabel, QTextEdit)
from PyQt5.QtCore import Qt
from PyQt5.QtGui import QFont

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.initUI()
        
    def initUI(self):
        self.setWindowTitle("${projectConfig.titulo}")
        self.setGeometry(100, 100, 600, 400)
        
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        
        layout = QVBoxLayout()
        central_widget.setLayout(layout)
        
        title = QLabel("${projectConfig.titulo}")
        title.setAlignment(Qt.AlignCenter)
        title.setFont(QFont("Arial", 16, QFont.Bold))
        layout.addWidget(title)
        
        desc = QLabel("${idea.substring(0, 100)}")
        desc.setAlignment(Qt.AlignCenter)
        layout.addWidget(desc)
        
        self.text_area = QTextEdit()
        self.text_area.setPlaceholderText("Aqu√≠ ir√° la funcionalidad principal...")
        layout.addWidget(self.text_area)
        
        btn = QPushButton("Ejecutar")
        btn.clicked.connect(self.ejecutar_funcion)
        layout.addWidget(btn)
        
    def ejecutar_funcion(self):
        self.text_area.append("‚úÖ Aplicaci√≥n ejecut√°ndose correctamente")
        
if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = MainWindow()
    window.show()
    sys.exit(app.exec_())`,
          "requirements.txt": "PyQt5==5.15.9\nnumpy",
          "README.md": `# ${projectConfig.titulo}

${idea}

## Instalaci√≥n

\\`\\`\\`bash
pip install -r requirements.txt
python main.py
\\`\\`\\`

## Caracter√≠sticas

- Interfaz gr√°fica con PyQt5
- Desarrollado con Influent Package Maker
- Versi√≥n ${projectConfig.version}`,
          "config/settings.json": `{
  "app_name": "${projectConfig.titulo}",
  "version": "${projectConfig.version}",
  "company": "${projectConfig.empresa}"
}`,
          "lib/utils.py": `# Utilidades para ${projectConfig.titulo}

def saludar():
    return "¬°Hola desde ${projectConfig.titulo}!"

def version():
    return "${projectConfig.version}"`
        }
      },
      metadata: {
        description: idea,
        dependencies: ["PyQt5", "numpy"],
        entry_point: "main.py"
      }
    };
  }

  // =============================================
  // VERIFICACI√ìN DE C√ìDIGO
  // =============================================
  async function verifyCodeWithAI(content, fileType, context) {
    logToConsole(`üîç Verificando ${fileType}: ${context}`, "debug");
    
    const prompt = `Verifica este ${fileType}:

CONTENIDO:
\`\`\`
${content.substring(0, 1500)}
\`\`\`

CRITERIOS:
1. Sintaxis correcta
2. Seguridad (sin c√≥digo malicioso)
3. Funcionalidad b√°sica

Responde SOLO con: VALIDO o INVALIDO seguido de una breve explicaci√≥n.`;

    try {
      const response = await callGeminiAPI(prompt, `Verificaci√≥n de ${fileType}`);
      return response.includes("VALIDO") ? { isValid: true, feedback: response } : { isValid: false, feedback: response };
    } catch (error) {
      logToConsole(`‚ö†Ô∏è Error en verificaci√≥n, asumiendo v√°lido: ${error.message}`, "warning");
      return { isValid: true, feedback: "Verificaci√≥n omitida por error" };
    }
  }

  // =============================================
  // L√ìGICA PRINCIPAL DE GENERACI√ìN
  // =============================================
  async function generateCompleteProject(idea, projectConfig) {
    const btn = document.getElementById('btn-generar');
    const btnText = document.getElementById('btn-text');
    const btnLoading = document.getElementById('btn-loading');
    
    // Estado de carga
    btn.disabled = true;
    btnText.textContent = 'Generando...';
    btnLoading.style.display = 'inline-block';
    
    try {
      logToConsole("üöÄ INICIANDO GENERACI√ìN DE PROYECTO", "info");
      
      // Paso 1: Generar estructura con IA
      updateProgress(25, "üìã Generando estructura del proyecto...");
      const aiResult = await generateProjectWithAI(idea, projectConfig);
      
      if (!aiResult.project_structure) {
        throw new Error("No se pudo generar la estructura del proyecto");
      }
      
      // Paso 2: Crear estructura de archivos
      updateProgress(50, "üìÅ Construyendo archivos...");
      const folderName = `${projectConfig.empresa}.${projectConfig.nombre}.v${projectConfig.version}-${getTimestamp()}`;
      const hash = await sha256(`${projectConfig.empresa}.${projectConfig.nombre}.v${projectConfig.version}`);
      
      const files = {};
      
      // Crear carpetas
      [...DEFAULT_FOLDERS, ...(aiResult.project_structure.folders || [])].forEach(folder => {
        files[`${folderName}/${folder}/.gitkeep`] = '# Carpeta ' + folder;
      });
      
      // Archivos generados por IA
      Object.entries(aiResult.project_structure.files || {}).forEach(([filePath, content]) => {
        files[`${folderName}/${filePath}`] = content;
      });
      
      // Archivos esenciales del sistema
      files[`${folderName}/details.xml`] = `<?xml version="1.0" encoding="UTF-8"?>
<app>
  <publisher>${projectConfig.empresa}</publisher>
  <app>${projectConfig.nombre}</app>
  <name>${projectConfig.titulo}</name>
  <version>${projectConfig.version}</version>
  <description>${aiResult.metadata.description}</description>
  <entry_point>${aiResult.metadata.entry_point || 'main.py'}</entry_point>
  <hash>${hash}</hash>
</app>`;
      
      // Paso 3: Verificaci√≥n r√°pida del archivo principal
      updateProgress(75, "‚úÖ Verificando c√≥digo principal...");
      const mainFile = Object.entries(files).find(([path]) => path.includes('main.py'));
      if (mainFile) {
        const verification = await verifyCodeWithAI(mainFile[1], "c√≥digo Python", "Archivo principal");
        if (verification.isValid) {
          logToConsole("‚úÖ C√≥digo principal verificado correctamente", "info");
        } else {
          logToConsole(`‚ö†Ô∏è Advertencias en c√≥digo principal: ${verification.feedback}`, "warning");
        }
      }
      
      // Paso 4: Mostrar resultados
      updateProgress(100, "üéâ Proyecto generado exitosamente!");
      showResults(files, projectConfig, aiResult);
      
      lastFiles = files;
      currentProjectData = { projectConfig, aiResult };
      
      logToConsole("‚úÖ GENERACI√ìN COMPLETADA - Proyecto listo para descargar", "success");
      
    } catch (error) {
      logToConsole(`‚ùå ERROR CR√çTICO: ${error.message}`, "error");
      console.error("Error detallado:", error);
    } finally {
      // Restaurar estado del bot√≥n
      btn.disabled = false;
      btnText.textContent = 'üöÄ Generar Proyecto Completo';
      btnLoading.style.display = 'none';
      setTimeout(hideProgress, 1000);
    }
  }

  // =============================================
  // FUNCIONES DE UI
  // =============================================
  function showResults(files, projectConfig, aiResult) {
    // Mostrar secci√≥n de resultados
    document.getElementById('results-section').style.display = 'block';
    
    // Mostrar √°rbol de archivos
    const fileTree = document.getElementById('file-tree');
    fileTree.innerHTML = '<strong>Estructura generada:</strong><br>';
    
    Object.keys(files).forEach(filePath => {
      const icon = filePath.endsWith('.py') ? 'üêç' : 
                   filePath.endsWith('.md') ? 'üìù' : 
                   filePath.endsWith('.txt') ? 'üìÑ' : 
                   filePath.endsWith('.xml') ? '‚öôÔ∏è' : 
                   filePath.endsWith('.json') ? 'üîß' : 'üìÅ';
      
      fileTree.innerHTML += `<div class="file-item"><span class="file-icon">${icon}</span> ${filePath}</div>`;
    });
    
    // Mostrar vista previa del c√≥digo principal
    const codePreview = document.getElementById('code-preview');
    const mainFile = Object.entries(files).find(([path]) => path.includes('main.py') || path.includes('.py') && !path.includes('__'));
    
    if (mainFile) {
      const [filePath, content] = mainFile;
      codePreview.innerHTML = `
        <div class="code-block">
          <div class="code-block-header">${filePath}</div>
          <pre>${escapeHtml(content)}</pre>
        </div>
      `;
    }
  }

  // =============================================
  // MANEJADORES DE EVENTOS
  // =============================================
  document.getElementById('btn-generar').addEventListener('click', async function() {
    const ideaInput = document.getElementById('idea-input').value.trim();
    if (!ideaInput) {
      logToConsole("‚ùå Error: Describe tu aplicaci√≥n primero", "error");
      return;
    }

    const projectConfig = {
      empresa: document.getElementById('empresa').value,
      nombre: document.getElementById('nombre').value,
      version: document.getElementById('version').value,
      titulo: document.getElementById('titulo').value,
      tipo: document.getElementById('tipo').value
    };

    if (!projectConfig.nombre || !projectConfig.titulo) {
      logToConsole("‚ùå Error: Completa todos los campos requeridos", "error");
      return;
    }

    await generateCompleteProject(ideaInput, projectConfig);
  });

  document.getElementById('btn-descargar').addEventListener('click', async function() {
    if (!lastFiles) {
      logToConsole("‚ùå Error: No hay proyecto para descargar", "error");
      return;
    }
    
    logToConsole("üì¶ Preparando descarga del paquete...", "info");
    
    try {
      const zip = new JSZip();
      for (const [filePath, content] of Object.entries(lastFiles)) {
        zip.file(filePath, content);
      }
      
      const folderName = Object.keys(lastFiles)[0].split('/')[0];
      const blob = await zip.generateAsync({ type: 'blob' });
      
      saveAs(blob, `${folderName}.iflapp`);
      logToConsole(`‚úÖ Paquete descargado: ${folderName}.iflapp`, "success");
      
    } catch (error) {
      logToConsole(`‚ùå Error al descargar: ${error.message}`, "error");
    }
  });

  document.getElementById('btn-clear-console').addEventListener('click', function() {
    document.getElementById('console-content').innerHTML = '';
    logToConsole("üßπ Consola limpiada", "info");
  });

  // =============================================
  // INICIALIZACI√ìN
  // =============================================
  document.addEventListener('DOMContentLoaded', function() {
    // Actualizar timestamps iniciales
    document.getElementById('current-time').textContent = `[${getCurrentTime()}]`;
    document.getElementById('current-time2').textContent = `[${getCurrentTime()}]`;
    
    logToConsole("‚úÖ Sistema inicializado correctamente", "info");
    logToConsole("üí° Completa la configuraci√≥n y haz clic en 'Generar Proyecto Completo'", "info");
  });
  </script>
</body>
</html>