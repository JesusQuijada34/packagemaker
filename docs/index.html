<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Influent Package Maker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --color-border-default: #d0d7de;
      --color-border-muted: #d8dee4;
      --color-canvas-default: #ffffff;
      --color-canvas-subtle: #f6f8fa;
      --color-fg-default: #24292f;
      --color-fg-muted: #57606a;
      --color-accent-fg: #0969da;
      --color-success-fg: #1a7f37;
      --color-danger-fg: #cf222e;
      --color-attention-fg: #9a6700;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background-color: var(--color-canvas-default);
      color: var(--color-fg-default);
      line-height: 1.5;
    }
    
    .header {
      background-color: #24292f;
      color: white;
      padding: 16px;
      border-bottom: 1px solid var(--color-border-default);
    }
    
    .header-content {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo {
      width: 32px;
      height: 32px;
      background: white;
      border-radius: 6px;
    }
    
    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 24px;
    }
    
    .section {
      background: var(--color-canvas-default);
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      margin-bottom: 24px;
    }
    
    .section-header {
      padding: 16px;
      border-bottom: 1px solid var(--color-border-default);
      background: var(--color-canvas-subtle);
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
    }
    
    .section-body {
      padding: 16px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 4px;
      font-size: 14px;
    }
    
    .form-control {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      font-size: 14px;
      background: var(--color-canvas-default);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--color-accent-fg);
      box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.1);
    }
    
    .textarea {
      min-height: 80px;
      resize: vertical;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 13px;
    }
    
    .btn {
      padding: 8px 16px;
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      background: var(--color-canvas-default);
      color: var(--color-fg-default);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn:hover {
      background: var(--color-canvas-subtle);
    }
    
    .btn-primary {
      background: var(--color-success-fg);
      border-color: var(--color-success-fg);
      color: white;
    }
    
    .btn-primary:hover {
      background: #1a7f37;
      border-color: #1a7f37;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .status {
      padding: 12px;
      border-radius: 6px;
      margin: 12px 0;
      font-size: 14px;
    }
    
    .status-success {
      background: #dafbe1;
      border: 1px solid #ace1af;
      color: var(--color-success-fg);
    }
    
    .status-error {
      background: #ffebe9;
      border: 1px solid #ffcecb;
      color: var(--color-danger-fg);
    }
    
    .status-warning {
      background: #fff8c5;
      border: 1px solid #fae17d;
      color: var(--color-attention-fg);
    }
    
    .status-info {
      background: #ddf4ff;
      border: 1px solid #b6e3ff;
      color: var(--color-accent-fg);
    }
    
    .thinking {
      background: #fff8c5;
      border: 1px solid #fae17d;
      padding: 12px;
      border-radius: 6px;
      margin: 12px 0;
      font-size: 14px;
      font-style: italic;
      color: var(--color-attention-fg);
    }
    
    .file-tree {
      background: var(--color-canvas-subtle);
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      padding: 16px;
      margin: 16px 0;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 13px;
    }
    
    .file-item {
      padding: 4px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .file-icon {
      color: var(--color-fg-muted);
      width: 16px;
      text-align: center;
    }
    
    .code-block {
      background: #0d1117;
      color: #e6edf3;
      padding: 16px;
      border-radius: 6px;
      margin: 12px 0;
      overflow-x: auto;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 13px;
      line-height: 1.45;
    }
    
    .code-block-header {
      background: #161b22;
      margin: -16px -16px 16px -16px;
      padding: 12px 16px;
      border-bottom: 1px solid #30363d;
      font-size: 12px;
      color: #7d8590;
    }
    
    .verification-step {
      padding: 8px 12px;
      margin: 4px 0;
      background: var(--color-canvas-subtle);
      border-radius: 4px;
      font-size: 13px;
      border-left: 3px solid var(--color-border-default);
    }
    
    .verification-step.success {
      border-left-color: var(--color-success-fg);
      background: #dafbe1;
    }
    
    .verification-step.error {
      border-left-color: var(--color-danger-fg);
      background: #ffebe9;
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid currentColor;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }
    
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
      .container {
        padding: 16px;
      }
    }
    
    .ai-thinking {
      background: #fff8c5;
      border: 1px solid #fae17d;
      padding: 12px;
      border-radius: 6px;
      margin: 8px 0;
      font-size: 13px;
      color: var(--color-attention-fg);
    }
    
    .prompt-log {
      background: var(--color-canvas-subtle);
      border: 1px solid var(--color-border-default);
      border-radius: 6px;
      padding: 12px;
      margin: 8px 0;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 12px;
      color: var(--color-fg-muted);
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="logo"></div>
      <h1 style="font-size: 16px; font-weight: 600;">Influent Package Maker</h1>
    </div>
  </div>

  <div class="container">
    <div class="grid">
      <!-- Columna Izquierda: Formulario y Configuraci√≥n -->
      <div>
        <div class="section">
          <div class="section-header">
            <h2 class="section-title">Configuraci√≥n del Proyecto</h2>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label">Fabricante</label>
              <input type="text" class="form-control" id="empresa" value="influent" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">Nombre interno</label>
              <input type="text" class="form-control" id="nombre" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">Versi√≥n</label>
              <input type="text" class="form-control" id="version" value="1.0.0" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">T√≠tulo completo</label>
              <input type="text" class="form-control" id="titulo" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">Tipo de aplicaci√≥n</label>
              <select class="form-control" id="tipo">
                <option value="calculadora">Calculadora/Cient√≠fica</option>
                <option value="utilidad">Utilidad del Sistema</option>
                <option value="herramienta">Herramienta de Desarrollo</option>
                <option value="productividad">Productividad</option>
                <option value="multimedia">Multimedia</option>
              </select>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2 class="section-title">Descripci√≥n con IA</h2>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label">Describe tu aplicaci√≥n en detalle</label>
              <textarea class="form-control textarea" id="idea-input" placeholder="Ej: Calculadora cient√≠fica con interfaz moderna, funciones trigonom√©tricas, historial de operaciones y temas personalizables..."></textarea>
            </div>
            
            <button class="btn btn-primary" id="btn-generar">
              <span id="btn-text">üöÄ Generar Proyecto Completo</span>
              <span id="btn-loading" class="loading" style="display: none;"></span>
            </button>
            
            <div id="thinking" class="thinking" style="display: none;">
              <span class="loading"></span> La IA est√° analizando y generando tu proyecto...
            </div>
          </div>
        </div>
      </div>

      <!-- Columna Derecha: Resultados y Verificaci√≥n -->
      <div>
        <div class="section">
          <div class="section-header">
            <h2 class="section-title">Progreso y Verificaci√≥n</h2>
          </div>
          <div class="section-body">
            <div id="status" class="status status-info">
              Esperando descripci√≥n del proyecto...
            </div>
            
            <div id="prompt-log" class="prompt-log" style="display: none;">
              <!-- Log de prompts y respuestas de la IA -->
            </div>
            
            <div id="verification-steps">
              <!-- Pasos de verificaci√≥n se insertar√°n aqu√≠ -->
            </div>
            
            <div id="ai-thinking" class="ai-thinking" style="display: none;">
              <!-- Pensamientos en tiempo real de la IA -->
            </div>
          </div>
        </div>

        <div class="section" id="results-section" style="display: none;">
          <div class="section-header">
            <h2 class="section-title">Resultados Generados</h2>
          </div>
          <div class="section-body">
            <div id="file-tree" class="file-tree">
              <!-- Estructura de archivos se insertar√° aqu√≠ -->
            </div>
            
            <div id="code-preview">
              <!-- Vista previa del c√≥digo se insertar√° aqu√≠ -->
            </div>
            
            <div class="form-group">
              <button class="btn btn-primary" id="btn-descargar">üì¶ Descargar Paquete .iflapp</button>
              <button class="btn" id="btn-validar">üîç Validar C√≥digo</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
// --- Configuraci√≥n y Constantes ---
const API_KEY_PARTS = [
  "AIzaSyDD8X1GvPm6j3axGaW",
  "z-pmjKSQXdP8eci4"
];
const GEMINI_API_KEY = API_KEY_PARTS.join("");

const DEFAULT_FOLDERS = ["app", "assets", "config", "docs", "source", "lib", "tests"];
let currentProjectData = null;
let lastFiles = null;
let verificationAttempts = 0;
const MAX_VERIFICATION_ATTEMPTS = 3;

// --- Utilidades B√°sicas ---
function getTimestamp() {
  const d = new Date();
  return `${d.getFullYear().toString().slice(-2)}.${(d.getMonth()+1).toString().padStart(2, '0')}-${d.getHours().toString().padStart(2, '0')}.${d.getMinutes().toString().padStart(2, '0')}`;
}

async function sha256(str) {
  const buf = new TextEncoder().encode(str);
  const hash = await window.crypto.subtle.digest('SHA-256', buf);
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, "0")).join("");
}

// --- Sistema de Logging ---
function logPrompt(prompt, response = null) {
  const logElement = document.getElementById('prompt-log');
  logElement.style.display = 'block';
  
  const timestamp = new Date().toLocaleTimeString();
  let logEntry = `[${timestamp}] PROMPT: ${prompt.substring(0, 100)}...\n`;
  
  if (response) {
    logEntry += `[${timestamp}] RESPUESTA: ${response.substring(0, 150)}...\n`;
    logEntry += '‚îÄ'.repeat(50) + '\n';
  }
  
  logElement.textContent += logEntry;
  logElement.scrollTop = logElement.scrollHeight;
}

function showThinking(message) {
  const thinkingElement = document.getElementById('ai-thinking');
  thinkingElement.style.display = 'block';
  thinkingElement.textContent = `üí≠ ${message}`;
}

function hideThinking() {
  document.getElementById('ai-thinking').style.display = 'none';
}

// --- Sistema de Verificaci√≥n Mejorado ---
async function verifyWithAI(content, fileType, context) {
  showThinking(`Verificando ${fileType}...`);
  
  const prompt = `AN√ÅLISIS DE ${fileType.toUpperCase()} - CONTEXTO: ${context}

CONTENIDO A VERIFICAR:
\`\`\`
${content}
\`\`\`

CRITERIOS DE VERIFICACI√ìN:
1. ‚úÖ SINT√ÅXIS: El c√≥digo debe ser sint√°cticamente correcto
2. ‚úÖ SEGURIDAD: No debe contener vulnerabilidades o c√≥digo malicioso
3. ‚úÖ FUNCIONALIDAD: Debe cumplir con su prop√≥sito declarado
4. ‚úÖ EST√ÅNDARES: Seguir mejores pr√°cticas del lenguaje
5. ‚úÖ √âTICA: Contenido apropiado y profesional

RESPONDE EXCLUSIVAMENTE con este formato JSON:
{
  "is_valid": true/false,
  "confidence": 0-100,
  "issues": ["lista espec√≠fica de problemas"],
  "suggestions": ["sugerencias concretas de mejora"],
  "summary": "Resumen breve del an√°lisis"
}`;

  try {
    logPrompt(`Verificaci√≥n ${fileType}`, `Analizando: ${context}`);
    
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [{ text: prompt }]
        }],
        generationConfig: {
          temperature: 0.1,
          maxOutputTokens: 1024
        }
      })
    });

    if (!response.ok) {
      throw new Error(`Error HTTP: ${response.status}`);
    }

    const data = await response.json();
    const resultText = data.candidates[0].content.parts[0].text;
    
    logPrompt(`Verificaci√≥n ${fileType}`, `Respuesta recibida: ${resultText.substring(0, 100)}...`);
    
    // Extraer JSON de la respuesta
    const jsonMatch = resultText.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      return JSON.parse(jsonMatch[0]);
    } else {
      return {
        is_valid: false,
        confidence: 0,
        issues: ["No se pudo parsear la respuesta de verificaci√≥n"],
        suggestions: ["Revisar el formato de la respuesta"],
        summary: "Error en el an√°lisis"
      };
    }
  } catch (error) {
    console.error('Error en verificaci√≥n:', error);
    return {
      is_valid: false,
      confidence: 0,
      issues: [`Error de conexi√≥n: ${error.message}`],
      suggestions: ["Reintentar la verificaci√≥n"],
      summary: "Error en el proceso de verificaci√≥n"
    };
  } finally {
    hideThinking();
  }
}

// --- Generaci√≥n de Proyecto con IA ---
async function generateProjectWithAI(idea, projectConfig) {
  showThinking("Analizando requisitos y generando estructura del proyecto...");
  
  const prompt = `GENERACI√ìN DE PROYECTO PYTHON COMPLETO

CONFIGURACI√ìN:
- Idea: ${idea}
- Fabricante: ${projectConfig.empresa}
- Nombre: ${projectConfig.nombre}
- Versi√≥n: ${projectConfig.version}
- T√≠tulo: ${projectConfig.titulo}
- Tipo: ${projectConfig.tipo}

REQUISITOS T√âCNICOS:
1. Aplicaci√≥n Python con PyQt5 para interfaz gr√°fica
2. Estructura de proyecto profesional y mantenible
3. C√≥digo limpio, documentado y con manejo de errores
4. Archivos de configuraci√≥n y dependencias
5. README completo con instrucciones de instalaci√≥n

GENERA EXCLUSIVAMENTE en formato JSON:

{
  "project_structure": {
    "folders": ["lista", "de", "carpetas"],
    "files": {
      "ruta/archivo.py": "contenido completo del archivo aqu√≠",
      "ruta/otro.txt": "contenido de archivo de texto"
    }
  },
  "metadata": {
    "description": "Descripci√≥n completa del proyecto",
    "dependencies": ["PyQt5", "otras dependencias"],
    "entry_point": "archivo principal .py"
  },
  "verification_notes": "Notas importantes para la verificaci√≥n"
}

IMPORTANTE: Genera al menos 6 archivos esenciales incluyendo el principal, README, requirements.txt y configuraci√≥n.`;

  try {
    logPrompt("Generaci√≥n de proyecto completo", `Idea: ${idea}`);
    
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [{ text: prompt }]
        }],
        generationConfig: {
          temperature: 0.2,
          maxOutputTokens: 4096
        }
      })
    });

    if (!response.ok) {
      throw new Error(`Error HTTP: ${response.status}`);
    }

    const data = await response.json();
    const resultText = data.candidates[0].content.parts[0].text;
    
    logPrompt("Generaci√≥n de proyecto completo", `Respuesta recibida (${resultText.length} caracteres)`);
    
    // Extraer y parsear JSON
    const jsonMatch = resultText.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      throw new Error("No se encontr√≥ JSON en la respuesta");
    }
    
    return JSON.parse(jsonMatch[0]);
  } catch (error) {
    console.error('Error en generaci√≥n:', error);
    throw error;
  } finally {
    hideThinking();
  }
}

// --- Verificaci√≥n en Bucle Mejorada ---
async function verifyAllFiles(files, context) {
  const verificationSteps = document.getElementById('verification-steps');
  verificationSteps.innerHTML = '<div class="verification-step">üîÑ Iniciando verificaci√≥n de archivos...</div>';
  
  let allValid = true;
  const issues = [];
  let filesProcessed = 0;
  const totalFiles = Object.keys(files).filter(f => typeof files[f] === 'string').length;

  for (const [filePath, content] of Object.entries(files)) {
    if (typeof content === 'string') {
      filesProcessed++;
      const progress = Math.round((filesProcessed / totalFiles) * 100);
      
      verificationSteps.innerHTML += `<div class="verification-step">üîç Verificando (${progress}%): ${filePath}</div>`;
      
      const fileType = filePath.endsWith('.py') ? 'c√≥digo Python' : 
                      filePath.endsWith('.md') ? 'documentaci√≥n Markdown' :
                      filePath.endsWith('.txt') ? 'archivo de texto' : 'contenido';
      
      const result = await verifyWithAI(content, fileType, `${context} - ${filePath}`);
      
      if (result.is_valid && result.confidence > 80) {
        verificationSteps.innerHTML += `<div class="verification-step success">‚úÖ ${filePath} - V√°lido (${result.confidence}% confianza)</div>`;
      } else {
        verificationSteps.innerHTML += `<div class="verification-step error">‚ùå ${filePath} - Problemas encontrados</div>`;
        issues.push({ 
          file: filePath, 
          problems: result.issues,
          suggestions: result.suggestions
        });
        allValid = false;
      }
      
      // Peque√±a pausa para no saturar la API
      await new Promise(resolve => setTimeout(resolve, 800));
    }
  }
  
  return { allValid, issues };
}
<script>
// --- L√≥gica Principal de la Aplicaci√≥n ---
document.getElementById('btn-generar').addEventListener('click', async function() {
  const ideaInput = document.getElementById('idea-input').value.trim();
  if (!ideaInput) {
    showStatus('‚ùå Por favor, describe tu aplicaci√≥n primero', 'error');
    return;
  }

  // Obtener configuraci√≥n del formulario
  const projectConfig = {
    empresa: document.getElementById('empresa').value,
    nombre: document.getElementById('nombre').value,
    version: document.getElementById('version').value,
    titulo: document.getElementById('titulo').value,
    tipo: document.getElementById('tipo').value
  };

  // Validar campos requeridos
  if (!projectConfig.nombre || !projectConfig.titulo) {
    showStatus('‚ùå Completa todos los campos requeridos', 'error');
    return;
  }

  await generateCompleteProject(ideaInput, projectConfig);
});

// Funci√≥n principal de generaci√≥n
async function generateCompleteProject(idea, projectConfig) {
  const btn = document.getElementById('btn-generar');
  const btnText = document.getElementById('btn-text');
  const btnLoading = document.getElementById('btn-loading');
  const thinkingElement = document.getElementById('thinking');
  
  // Estado de carga
  btn.disabled = true;
  btnText.textContent = 'Generando...';
  btnLoading.style.display = 'inline-block';
  thinkingElement.style.display = 'block';
  
  try {
    showStatus('üöÄ Iniciando generaci√≥n del proyecto...', 'info');
    
    // Paso 1: Generar estructura con IA
    showStatus('üìã Analizando requisitos con IA...', 'info');
    const aiResult = await generateProjectWithAI(idea, projectConfig);
    
    if (!aiResult.project_structure || !aiResult.metadata) {
      throw new Error('La IA no gener√≥ una estructura v√°lida');
    }
    
    // Paso 2: Crear estructura de archivos
    showStatus('üìÅ Creando estructura de archivos...', 'info');
    const folderName = `${projectConfig.empresa}.${projectConfig.nombre}.v${projectConfig.version}-${getTimestamp()}`;
    const hash = await sha256(`${projectConfig.empresa}.${projectConfig.nombre}.v${projectConfig.version}`);
    
    const files = {};
    
    // Crear carpetas
    [...DEFAULT_FOLDERS, ...(aiResult.project_structure.folders || [])].forEach(folder => {
      files[`${folderName}/${folder}/.gitkeep`] = '# Carpeta ' + folder;
    });
    
    // Archivos generados por IA
    Object.entries(aiResult.project_structure.files || {}).forEach(([filePath, content]) => {
      files[`${folderName}/${filePath}`] = content;
    });
    
    // Archivos esenciales adicionales
    files[`${folderName}/README.md`] = `# ${projectConfig.titulo}\n\n${aiResult.metadata.description}\n\n## Instalaci√≥n\n\n1. Instalar dependencias: pip install -r requirements.txt\n2. Ejecutar: python ${aiResult.metadata.entry_point || 'main.py'}\n\n## Caracter√≠sticas\n\n- Desarrollado con Influent Package Maker\n- ${projectConfig.tipo}\n- Versi√≥n ${projectConfig.version}`;
    
    files[`${folderName}/requirements.txt`] = (aiResult.metadata.dependencies || ['PyQt5==5.15.9', 'numpy']).join('\n');
    
    files[`${folderName}/config/settings.json`] = JSON.stringify({
      app_name: projectConfig.titulo,
      version: projectConfig.version,
      company: projectConfig.empresa
    }, null, 2);
    
    // Paso 3: Verificaci√≥n en bucle
    showStatus('üîç Verificando calidad del c√≥digo...', 'info');
    const verificationResult = await verifyAllFiles(files, aiResult.metadata.description);
    
    // Paso 4: Mostrar resultados
    showResults(files, projectConfig, aiResult, verificationResult);
    
    if (verificationResult.allValid) {
      showStatus('‚úÖ Proyecto generado y verificado exitosamente!', 'success');
    } else {
      showStatus('‚ö†Ô∏è Proyecto generado con advertencias de verificaci√≥n', 'warning');
      showVerificationIssues(verificationResult.issues);
    }
    
    lastFiles = files;
    currentProjectData = { projectConfig, aiResult };
    
  } catch (error) {
    console.error('Error en generaci√≥n:', error);
    showStatus(`‚ùå Error: ${error.message}`, 'error');
  } finally {
    // Restaurar estado del bot√≥n
    btn.disabled = false;
    btnText.textContent = 'üöÄ Generar Proyecto Completo';
    btnLoading.style.display = 'none';
    thinkingElement.style.display = 'none';
  }
}

// --- Funciones de UI ---
function showStatus(message, type = 'info') {
  const statusElement = document.getElementById('status');
  statusElement.textContent = message;
  statusElement.className = `status status-${type}`;
}

function showResults(files, projectConfig, aiResult, verificationResult) {
  // Mostrar secci√≥n de resultados
  document.getElementById('results-section').style.display = 'block';
  
  // Mostrar √°rbol de archivos
  const fileTree = document.getElementById('file-tree');
  fileTree.innerHTML = '<strong>Estructura generada:</strong><br>';
  
  Object.keys(files).forEach(filePath => {
    const icon = filePath.endsWith('.py') ? 'üêç' : 
                 filePath.endsWith('.md') ? 'üìù' : 
                 filePath.endsWith('.txt') ? 'üìÑ' : 'üìÅ';
    
    fileTree.innerHTML += `<div class="file-item"><span class="file-icon">${icon}</span> ${filePath}</div>`;
  });
  
  // Mostrar vista previa del c√≥digo principal
  const codePreview = document.getElementById('code-preview');
  const mainFile = Object.entries(files).find(([path]) => path.includes('.py') && !path.includes('__'));
  
  if (mainFile) {
    const [filePath, content] = mainFile;
    codePreview.innerHTML = `
      <div class="code-block">
        <div class="code-block-header">${filePath}</div>
        <pre>${escapeHtml(content)}</pre>
      </div>
    `;
  }
  
  // Mostrar issues de verificaci√≥n si los hay
  if (!verificationResult.allValid) {
    showVerificationIssues(verificationResult.issues);
  }
}

function showVerificationIssues(issues) {
  const verificationSteps = document.getElementById('verification-steps');
  
  issues.forEach(issue => {
    verificationSteps.innerHTML += `
      <div class="verification-step error">
        <strong>${issue.file}:</strong><br>
        ${issue.problems.join('<br>')}
        ${issue.suggestions.length ? `<br><em>Sugerencias: ${issue.suggestions.join(', ')}</em>` : ''}
      </div>
    `;
  });
}

function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// --- Descarga del Proyecto ---
document.getElementById('btn-descargar').addEventListener('click', async function() {
  if (!lastFiles) return;
  
  showStatus('üì¶ Preparando descarga del paquete...', 'info');
  
  try {
    // Verificaci√≥n final r√°pida
    const finalCheck = await verifyAllFiles(lastFiles, 'Verificaci√≥n final antes de descargar');
    
    if (!finalCheck.allValid) {
      showStatus('‚ùå No se puede descargar - Problemas detectados en la verificaci√≥n final', 'error');
      return;
    }
    
    // Crear ZIP
    const zip = new JSZip();
    for (const [filePath, content] of Object.entries(lastFiles)) {
      zip.file(filePath, content);
    }
    
    const folderName = Object.keys(lastFiles)[0].split('/')[0];
    const blob = await zip.generateAsync({ type: 'blob' });
    
    saveAs(blob, `${folderName}.iflapp`);
    showStatus(`‚úÖ Paquete descargado: ${folderName}.iflapp`, 'success');
    
  } catch (error) {
    console.error('Error en descarga:', error);
    showStatus(`‚ùå Error al descargar: ${error.message}`, 'error');
  }
});

// --- Validaci√≥n Adicional ---
document.getElementById('btn-validar').addEventListener('click', async function() {
  if (!lastFiles) return;
  
  showStatus('üîç Ejecutando validaci√≥n completa...', 'info');
  
  const result = await verifyAllFiles(lastFiles, 'Validaci√≥n completa solicitada por usuario');
  
  if (result.allValid) {
    showStatus('‚úÖ Validaci√≥n completada - Todo el c√≥digo es correcto', 'success');
  } else {
    showStatus('‚ö†Ô∏è Validaci√≥n completada - Se encontraron problemas que requieren atenci√≥n', 'warning');
  }
});

// --- Inicializaci√≥n ---
document.addEventListener('DOMContentLoaded', function() {
  showStatus('üí° Describe tu aplicaci√≥n y haz clic en "Generar Proyecto Completo" para comenzar', 'info');
  
  // Ejemplo de descripci√≥n pre-cargada
  document.getElementById('idea-input').value = 'Calculadora cient√≠fica con interfaz moderna PyQt5, funciones trigonom√©tricas, historial de operaciones, temas claros/oscuros y exportaci√≥n de resultados.';
  document.getElementById('nombre').value = 'scicalc';
  document.getElementById('titulo').value = 'Scientific Calculator Pro';
});
</script>
</body>
</html>
