<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Influent Package Maker Web + AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --color-bg: #f4f6f8;
      --color-primary: #0366d6;
      --color-success: #2ea44f;
      --color-text: #24292e;
      --color-surface: #ffffff;
    }
    body {
      font-family: "Inter", system-ui, sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      margin: 0;
    }
    header {
      display: flex;
      align-items: center;
      gap: 14px;
      background: var(--color-primary);
      color: #fff;
      padding: 14px 18px;
      box-shadow: 0 2px 5px #0003;
    }
    .gh-logo {
      width: 36px; height: 36px; border-radius: 6px; background: #fff; border: 1px solid #e1e4e8;
    }
    h1 {
      font-size: 1.1em; font-weight: 600; margin: 0;
    }
    main {
      max-width: 460px;
      margin: 25px auto;
      background: var(--color-surface);
      border: 1px solid #e1e4e8;
      border-radius: 10px;
      padding: 22px 16px 18px 16px;
      box-shadow: 0 3px 8px #0002;
    }
    section h2 {
      font-size: 1.1em; margin-bottom: 10px; font-weight: 600;
    }
    .gh-form { display: flex; flex-direction: column; gap: 12px; margin-bottom: 12px; }
    .gh-form label { display: flex; flex-direction: column; gap: 4px; font-weight: 500; }
    input[type="text"], input[type="file"] {
      padding: 8px 10px; font-size: 1em;
      border: 1px solid #ccc; border-radius: 6px;
      background: #fafbfc; transition: border .2s;
    }
    input:focus { border-color: var(--color-primary); outline: none; }
    .gh-btn {
      padding: 10px 16px; font-weight: 600;
      border: none; border-radius: 6px;
      color: #fff; background: var(--color-success);
      cursor: pointer; transition: background .2s;
    }
    .gh-btn:hover { background: #248a3d; }
    .gh-status { margin-top: 8px; font-size: .95em; color: var(--color-success); }
    #ai-response {
      margin-top: 10px; font-size: .93em;
      background: #f6f8fa; border: 1px solid #e1e4e8;
      border-radius: 6px; padding: 10px; white-space: pre-wrap;
    }
    code {
      display: block; background: #eee; padding: 6px;
      border-radius: 5px; font-family: monospace; white-space: pre-wrap;
    }
    footer {
      text-align: center; padding: 10px;
      font-size: .9em; color: #666;
    }
    footer a { color: var(--color-primary); text-decoration: none; }
    footer a:hover { text-decoration: underline; }
    hr { border: none; border-top: 1px solid #e1e4e8; margin: 18px 0 14px 0; }
    @media (max-width:520px){
      main{max-width:95vw;padding:7vw 4vw;}
      header{padding:7vw 4vw;}
    }
  </style>
</head>
<body>
<header>
  <img src="https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/assets/product_logo.png" class="gh-logo" alt="logo">
  <h1>Influent Package Maker + AI</h1>
</header>

<main>
  <section>
    <h2>Detalles del Proyecto</h2>
    <form id="create-form" class="gh-form">
      <label><span>Fabricante</span><input name="empresa" type="text" required></label>
      <label><span>Nombre interno</span><input name="nombre" type="text" required></label>
      <label><span>Versi√≥n</span><input name="version" type="text" required></label>
      <label><span>T√≠tulo completo</span><input name="titulo" type="text" required></label>
      <button type="submit" class="gh-btn">Generar estructura</button>
    </form>
    <div id="create-status" class="gh-status"></div>
    <div id="preview-files"></div>
    <button id="btn-download" class="gh-btn" style="display:none;">Descargar ZIP</button>
  </section>

  <hr>

  <section>
    <h2>Asistente Inteligente</h2>
    <form id="ai-form" class="gh-form">
      <label><span>Describe brevemente tu proyecto</span>
        <input id="ai-prompt" type="text" placeholder="Ej. una app m√≥vil para notas r√°pidas">
      </label>
      <button type="submit" class="gh-btn">Sugerir con IA</button>
    </form>
    <div id="ai-response"></div>
  </section>

  <hr>

  <section>
    <h2>Explorar Paquete</h2>
    <form class="gh-form">
      <label><span>Selecciona un paquete ZIP (.iflapp)</span>
        <input type="file" accept=".zip,.iflapp" id="zipfile">
      </label>
    </form>
    <div id="install-status" class="gh-status"></div>
    <div id="zip-details"></div>
  </section>
</main>

<footer>
  <span>GitHub: <a href="https://github.com/JesusQuijada34/packagemaker/">packagemaker</a></span>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script type="module">
import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
const ai = new GoogleGenerativeAI("AIzaSyAXnbWHp1-7wC8vVbDbrTWBVIOBPGv7nis"); // Reemplaza con tu API key
const model = ai.getGenerativeModel({ model: "gemini-2.0-flash" });

// --- PROMPT INTERNO CONTROLADO ---
const SYSTEM_PROMPT = `
Eres un asistente de desarrollo profesional para Influent Package Maker.
Responde SIEMPRE en formato JSON compacto y corto como este:
{
  "empresa": "TechNova",
  "nombre": "weatherly",
  "version": "1.0",
  "titulo": "Weatherly - App del Clima",
  "colores": { "primario": "#007acc", "fondo": "#f4f6fb" }
}
No expliques, no uses frases largas ni descripciones. Solo devuelve el JSON o bloque de c√≥digo equivalente.
Evita texto fuera del bloque JSON.
`;

// --- FUNCIONES BASE ---
function applyAITheme(colors) {
  if (!colors) return;
  document.documentElement.style.setProperty("--color-primary", colors.primario || "#0366d6");
  document.documentElement.style.setProperty("--color-bg", colors.fondo || "#f4f6f8");
}
function updateFormFields(data) {
  if (data.empresa) document.querySelector('[name="empresa"]').value = data.empresa;
  if (data.nombre) document.querySelector('[name="nombre"]').value = data.nombre;
  if (data.version) document.querySelector('[name="version"]').value = data.version;
  if (data.titulo) document.querySelector('[name="titulo"]').value = data.titulo;
}

// --- FORMULARIO IA ---
document.getElementById("ai-form").onsubmit = async (e)=>{
  e.preventDefault();
  const prompt = document.getElementById("ai-prompt").value.trim();
  const output = document.getElementById("ai-response");
  if(!prompt){ output.textContent="Escribe una descripci√≥n primero."; return; }
  output.textContent = "ü§ñ Generando sugerencias...";

  try {
    const fullPrompt = `${SYSTEM_PROMPT}\nDescripci√≥n del usuario: ${prompt}`;
    const result = await model.generateContent(fullPrompt);
    let text = result.response.text().trim();

    // Buscar bloque JSON o bloque de c√≥digo
    const match = text.match(/\{[\s\S]*\}/);
    if (!match) { output.textContent = "‚ö†Ô∏è No se detect√≥ JSON v√°lido."; return; }

    const jsonText = match[0];
    const data = JSON.parse(jsonText);

    // Aplicar en interfaz
    updateFormFields(data);
    applyAITheme(data.colores);

    // Mostrar en bloque visual
    output.innerHTML = `<code>${JSON.stringify(data, null, 2)}</code>`;
  } catch(err) {
    output.textContent = "Error: " + err.message;
  }
};

// --- Resto del c√≥digo ZIP (resumido pero funcional) ---
const RAW_ICON_URL = "https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/app/app-icon.ico";
const RAW_LICENSE_URL = "https://raw.githubusercontent.com/JesusQuijada34/packagemaker/main/LICENSE";
const DEFAULT_FOLDERS = ["app","assets","config","docs","source","lib"];

async function sha256(str) {
  const buf = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest('SHA-256', buf);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

document.getElementById("create-form").onsubmit = async (e)=>{
  e.preventDefault();
  const empresa = e.target.empresa.value.trim();
  const nombre = e.target.nombre.value.trim();
  const version = e.target.version.value.trim();
  const titulo = e.target.titulo.value.trim();
  const hv = await sha256(`${empresa}.${nombre}.${version}`);

  const folder = `${empresa}.${nombre}.v${version}`;
  const files = {
    [`${folder}/README.md`]: `# ${titulo}\nGenerado por Influent Package Maker.`,
    [`${folder}/details.xml`]: `<app><publisher>${empresa}</publisher><name>${titulo}</name><version>${version}</version></app>`
  };

  const zip = new JSZip();
  for(const f in files) zip.file(f, files[f]);
  zip.generateAsync({type:"blob"}).then(blob=>saveAs(blob, `${folder}.iflapp`));
  document.getElementById("create-status").textContent = "‚úÖ Proyecto empaquetado correctamente.";
};
</script>
</body>
</html>
