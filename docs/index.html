<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Influent Package Maker ‚Äî Fix & UI Improvements</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --primary-color: #0969da;
      --success-color: #1a7f37;
      --accent-color: #0f1724;
      --warning-color: #9a6700;
      --error-color: #cf222e;
      --bg-color: #f7f9fc;
      --card-bg: #ffffff;
      --sidebar-bg: #f1f5f9;
      --border-color: #e2e8f0;
      --text-color: #0b1220;
      --text-muted: #475569;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Segoe UI Mono', monospace;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background: var(--bg-color);
      color: var(--text-color);
      display: flex; height: 100vh; overflow: hidden;
    }

    /* Sidebar */
    .sidebar { width: 320px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); padding: 20px; overflow-y: auto; }
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

    h1, h2 { color: var(--text-color); }
    .header { padding: 20px; border-bottom: 1px solid var(--border-color); background: linear-gradient(90deg,#fff 0%, #fbfdff 100%); }
    .header h1 { font-size: 18px; font-weight: 700; }

    .content-area { padding: 20px; overflow-y: auto; display: grid; grid-template-columns: 1fr; gap: 16px; }

    .card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; }
    .card .card-header { padding: 14px 16px; border-bottom: 1px solid var(--border-color); background: transparent; }
    .card .card-body { padding: 16px; }
    .section-title { font-size: 14px; font-weight: 700; }

    .form-group { margin-bottom: 12px; }
    .form-label { display:block; font-size:13px; color:var(--text-muted); margin-bottom:6px; }
    .form-control { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border-color); background: #fff; font-size:14px; }
    .form-control:focus { outline: none; box-shadow: 0 4px 12px rgba(9,105,218,.08); border-color: var(--primary-color); }
    .textarea { min-height: 110px; resize: vertical; font-family: var(--mono); font-size:13px; }

    .btn { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:8px; border:1px solid var(--border-color); background:#fff; cursor:pointer; font-weight:600; }
    .btn:hover { transform: translateY(-1px); }
    .btn:disabled { opacity:0.6; cursor:not-allowed; transform:none; }
    .btn-primary { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
    .btn-success { background: var(--success-color); color:#fff; border-color: var(--success-color); }

    .status { padding: 10px; border-radius: 8px; font-size:13px; }
    .status-info { background: #e6f0ff; color: var(--primary-color); }

    /* Console */
    .console { background: #0b1220; color: #dbeafe; border-radius: 8px; padding: 12px; font-family: var(--mono); min-height: 260px; max-height: 420px; overflow-y:auto; }
    .console-line { margin-bottom:8px; display:flex; gap:8px; align-items:flex-start; }
    .console-timestamp { color:#94a3b8; font-size:12px; min-width:92px; }
    .console-info { color:#9be7ff; }
    .console-success { color:#a7f3d0; }
    .console-warning { color:#fbd38d; }
    .console-error { color:#ffb4b4; }

    .file-tree { background: transparent; border-radius:8px; padding:8px; font-family: var(--mono); font-size:13px; max-height:260px; overflow:auto; }
    .file-item { display:flex; gap:8px; align-items:center; padding:6px; border-radius:6px; cursor:pointer; }
    .file-item:hover { background: rgba(15,23,42,0.03); }
    .file-icon { width:20px; text-align:center; }

    .code-block { background:#071027; color:#e6f6ff; padding:12px; border-radius:8px; font-family:var(--mono); font-size:13px; overflow:auto; }
    .code-block-header { font-size:12px; color:#94a3b8; margin-bottom:8px; }

    .progress-bar { width:100%; height:6px; background:var(--border-color); border-radius:6px; overflow:hidden; margin-top:10px; }
    .progress-fill { height:100%; background:var(--success-color); width:0%; transition:width 300ms ease; }

    /* responsive */
    @media (max-width: 900px) {
      .sidebar { display:none; }
      body { flex-direction:column; }
      .header { position:sticky; top:0; z-index:10; }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="card">
      <div class="card-header"><div class="section-title">Configuraci√≥n del Proyecto</div></div>
      <div class="card-body">
        <div class="form-group">
          <label class="form-label" for="empresa">Fabricante</label>
          <input id="empresa" class="form-control" value="influent" placeholder="ej. influent">
        </div>
        <div class="form-group">
          <label class="form-label" for="nombre">Nombre interno</label>
          <input id="nombre" class="form-control" value="scicalc" placeholder="ej. scicalc">
        </div>
        <div class="form-group">
          <label class="form-label" for="version">Versi√≥n</label>
          <input id="version" class="form-control" value="1.0.0">
        </div>
        <div class="form-group">
          <label class="form-label" for="titulo">T√≠tulo completo</label>
          <input id="titulo" class="form-control" value="Scientific Calculator Pro">
        </div>
        <div class="form-group">
          <label class="form-label" for="tipo">Tipo de aplicaci√≥n</label>
          <select id="tipo" class="form-control">
            <option value="calculadora">Calculadora/Cient√≠fica</option>
            <option value="utilidad">Utilidad del Sistema</option>
            <option value="herramienta">Herramienta de Desarrollo</option>
            <option value="productividad">Productividad</option>
            <option value="multimedia">Multimedia</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="card-header"><div class="section-title">Descripci√≥n con IA</div></div>
      <div class="card-body">
        <div class="form-group">
          <label class="form-label" for="idea-input">Describe tu aplicaci√≥n en detalle</label>
          <textarea id="idea-input" class="form-control textarea">Calculadora cient√≠fica con interfaz moderna PyQt5, funciones trigonom√©tricas, historial de operaciones, temas claros/oscuros y exportaci√≥n de resultados.</textarea>
        </div>

        <div style="display:flex; gap:8px; align-items:center;">
          <button id="btn-generar" class="btn btn-primary">üöÄ Generar Proyecto Completo</button>
          <button id="btn-generate-local" class="btn">‚öôÔ∏è Generaci√≥n local (fallback)</button>
        </div>

        <div class="progress-bar" id="progress-bar" style="display:none;">
          <div class="progress-fill" id="progress-fill" style="width:0%"></div>
        </div>

        <div style="margin-top:10px; font-size:13px; color:var(--text-muted);">
          <div>API Gemini: <span id="api-status">No configurada</span></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px; display:none;" id="results-section">
      <div class="card-header"><div class="section-title">Resultados</div></div>
      <div class="card-body">
        <div id="file-tree" class="file-tree"></div>
        <div style="display:flex; gap:8px; margin-top:12px;">
          <button id="btn-descargar" class="btn btn-success" disabled>üì¶ Descargar Paquete .iflapp</button>
          <button id="btn-copy-structure" class="btn">üìã Copiar estructura</button>
        </div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="header">
      <h1>Influent Package Maker ‚Äî Consola de Desarrollo</h1>
    </div>

    <div class="content-area">
      <div class="card">
        <div class="card-header"><div class="section-title">Consola de Debug</div>
          <div style="float:right;"><button id="btn-clear-console" class="btn" style="font-size:12px;">üßπ Limpiar</button></div>
        </div>
        <div class="card-body">
          <div class="console" id="console-content"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><div class="section-title">Vista Previa del C√≥digo</div></div>
        <div class="card-body" id="code-preview">
          <div class="code-block">
            <div class="code-block-header">Esperando generaci√≥n de c√≥digo...</div>
            <pre id="code-pre">El c√≥digo generado aparecer√° aqu√≠ despu√©s de que completes la descripci√≥n y hagas clic en "Generar Proyecto Completo".</pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
  // ================ CONFIG & STATE ================
  // IMPORTANT: Set your Gemini API key here (or leave empty to use local fallback)
  const GEMINI_API_KEY = "AIzaSyDD8X1GvPm6j3axGaWz-pmjKSQXdP8eci4"; // <-- removed embedded key for security. Add your key if you want remote AI.

  const DEFAULT_FOLDERS = ["app","assets","config","docs","source","lib","tests"];
  let lastFiles = null;
  let currentProjectData = null;

  // ================ UTILITIES ================
  function nowTimestamp() { return new Date().toLocaleString(); }
  function getCurrentTime() { return new Date().toLocaleTimeString(); }

  function logToConsole(message, level = 'info'){
    try{
      const container = document.getElementById('console-content');
      const line = document.createElement('div');
      line.className = 'console-line';
      const ts = document.createElement('div'); ts.className='console-timestamp'; ts.textContent = '[' + getCurrentTime() + ']';
      const msg = document.createElement('div'); msg.className = 'console-' + (level||'info'); msg.textContent = message;
      line.appendChild(ts); line.appendChild(msg); container.appendChild(line);
      container.scrollTop = container.scrollHeight;
      console.log(`[${nowTimestamp()}] ${message}`);
    } catch(e){ console.error('Console log failed', e); }
  }

  function updateProgress(percent, message){
    const bar = document.getElementById('progress-bar'); const fill = document.getElementById('progress-fill');
    if(!bar || !fill) return;
    bar.style.display = 'block'; fill.style.width = percent + '%';
    if(message) logToConsole(message, 'info');
  }
  function hideProgress(){ const bar = document.getElementById('progress-bar'); if(bar) bar.style.display='none'; }

  async function sha256(s){ const buf = new TextEncoder().encode(s); const h = await crypto.subtle.digest('SHA-256', buf); return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // ================ GEMINI COMMUNICATION (optional) ================
  async function callGeminiAPI(prompt){
    if(!GEMINI_API_KEY) throw new Error('Gemini API key no configurada');
    logToConsole('üì° Enviando solicitud a Gemini...', 'info');
    try{
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ contents:[{ parts:[{ text: prompt }] }], generationConfig:{ temperature:0.2, maxOutputTokens:4096, topP:0.8 } })
      });
      if(!res.ok){ const t = await res.text(); throw new Error('HTTP ' + res.status + ': ' + t); }
      const data = await res.json();
      // safe access
      const text = (data?.candidates?.[0]?.content?.parts?.[0]?.text) || JSON.stringify(data);
      logToConsole('‚úÖ Respuesta recibida de Gemini', 'success');
      return text;
    } catch(err){ logToConsole('‚ùå Error Gemini: ' + err.message, 'error'); throw err; }
  }

  // ================ AI GENERATION & FALLBACK ================
  async function generateProjectWithAI(idea, projectConfig){
    updateProgress(10, 'üß† Preparando prompt...');

    const prompt = `Eres un experto en desarrollo de aplicaciones Python con PyQt5.\n\nCONFIG:\n- Idea: ${idea}\n- Fabricante: ${projectConfig.empresa}\n- Nombre: ${projectConfig.nombre}\n- Versi√≥n: ${projectConfig.version}\n- T√≠tulo: ${projectConfig.titulo}\n- Tipo: ${projectConfig.tipo}\n\nGenera una estructura de proyecto en JSON con carpetas y archivos (archivos con contenido real). Responde √∫nicamente con JSON.`;

    try{
      const response = await callGeminiAPI(prompt);
      // intentar extraer primer bloque JSON
      const jsonMatch = response.match(/\{[\s\S]*\}/);
      if(jsonMatch){ try{ return JSON.parse(jsonMatch[0]); }catch(err){ logToConsole('‚ö†Ô∏è JSON inv√°lido recibido de Gemini, se usar√° fallback', 'warning'); return createFallbackProject(idea, projectConfig); } }
      logToConsole('‚ö†Ô∏è No se encontr√≥ JSON en la respuesta de Gemini, usando fallback', 'warning');
      return createFallbackProject(idea, projectConfig);
    } catch(err){ logToConsole('üîÑ Usando generaci√≥n local por fallback', 'warning'); return createFallbackProject(idea, projectConfig); }
  }

  function createFallbackProject(idea, projectConfig){
    logToConsole('üîß Creando proyecto de ejemplo (fallback)', 'info');
    return {
      project_structure:{ folders:['app','config','lib'], files:{
        'main.py': `#!/usr/bin/env python3\n# ${projectConfig.titulo}\n# Versi√≥n: ${projectConfig.version}\n\nimport sys\nfrom PyQt5.QtWidgets import QApplication, QMainWindow, QLabel\n\nclass MainWindow(QMainWindow):\n  def __init__(self):\n    super().__init__()\n    self.setWindowTitle('${projectConfig.titulo}')\n    self.setGeometry(100,100,640,420)\n    lbl=QLabel('¬°Aplicaci√≥n generada autom√°ticamente (fallback)!', self)\n    lbl.move(20,20)\n\nif __name__=='__main__':\n  app=QApplication(sys.argv)\n  w=MainWindow()\n  w.show()\n  sys.exit(app.exec_())`,
        'requirements.txt': 'PyQt5==5.15.9\nnumpy',
        'README.md': `# ${projectConfig.titulo}\n\n${idea}\n\nInstalaci√≥n:\n\n\`\`\`bash\npip install -r requirements.txt\npython main.py\n\`\`\``,
        'config/settings.json': JSON.stringify({ app_name: projectConfig.titulo, version: projectConfig.version, company: projectConfig.empresa }, null, 2),
        'lib/utils.py': `def saludo():\n  return '¬°Hola desde ${projectConfig.titulo}!'`
      } }, metadata:{ description: idea, dependencies:['PyQt5','numpy'], entry_point:'main.py' }
    };
  }

  // ================ CODE VERIFICATION (light) ================
  async function verifyCodeWithAI(content,fileType,context){
    logToConsole(`üîç Verificando ${fileType} (${context})`, 'info');
    // Simple local checks: ensure balanced indentation, no obvious 'eval' calls, file not empty
    if(!content || content.trim().length===0) return { isValid:false, feedback:'Archivo vac√≠o' };
    if(/\beval\(/i.test(content)) return { isValid:false, feedback:'Uso de eval detectado' };
    return { isValid:true, feedback:'Verificaci√≥n local OK' };
  }

  // ================ MAIN GENERATION FLOW ================
  async function generateCompleteProject(idea, projectConfig){
    const btn = document.getElementById('btn-generar');
    btn.disabled = true; updateProgress(5, 'üöÄ Iniciando generaci√≥n');
    try{
      const aiResult = await generateProjectWithAI(idea, projectConfig);
      if(!aiResult?.project_structure) throw new Error('Estructura de proyecto inv√°lida');

      updateProgress(40, 'üìÅ Construyendo archivos...');
      const folderName = `${projectConfig.empresa}.${projectConfig.nombre}.v${projectConfig.version}-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}`;
      const hash = await sha256(`${projectConfig.empresa}.${projectConfig.nombre}.v${projectConfig.version}`);
      const files = {};

      // ensure default folders present
      const folders = Array.from(new Set([...DEFAULT_FOLDERS, ...(aiResult.project_structure.folders || [])]));
      folders.forEach(f => files[`${folderName}/${f}/.gitkeep`] = '# placeholder');

      // add AI files
      Object.entries(aiResult.project_structure.files || {}).forEach(([path, content]) => { files[`${folderName}/${path}`] = content; });

      files[`${folderName}/details.xml`] = `<?xml version="1.0" encoding="UTF-8"?>\n<app>\n  <publisher>${projectConfig.empresa}</publisher>\n  <app>${projectConfig.nombre}</app>\n  <name>${projectConfig.titulo}</name>\n  <version>${projectConfig.version}</version>\n  <description>${escapeHtml(aiResult.metadata?.description || '')}</description>\n  <entry_point>${aiResult.metadata?.entry_point || 'main.py'}</entry_point>\n  <hash>${hash}</hash>\n</app>`;

      updateProgress(70, 'üîé Verificando archivo principal...');
      const mainFileEntry = Object.entries(files).find(([p])=>p.endsWith('/main.py') || p.endsWith('main.py'));
      if(mainFileEntry){
        const verification = await verifyCodeWithAI(mainFileEntry[1],'python','Archivo principal');
        if(!verification.isValid) logToConsole('‚ö†Ô∏è Advertencia: ' + verification.feedback, 'warning');
        else logToConsole('‚úÖ C√≥digo principal verificado (local)', 'success');
      }

      updateProgress(94, 'üéâ Preparando resultados...');
      lastFiles = files; currentProjectData = { projectConfig, aiResult };
      showResults(files, projectConfig, aiResult);
      logToConsole('‚úÖ Proyecto generado correctamente', 'success');
    } catch(err){ logToConsole('‚ùå Error durante generaci√≥n: ' + err.message, 'error'); }
    finally{ document.getElementById('btn-generar').disabled = false; setTimeout(hideProgress, 800); }
  }

  // ================ UI HELPERS ================
  function showResults(files){
    const results = document.getElementById('results-section'); results.style.display = 'block';
    const tree = document.getElementById('file-tree'); tree.innerHTML = '';

    Object.keys(files).sort().forEach(fp => {
      const item = document.createElement('div'); item.className='file-item';
      const icon = document.createElement('div'); icon.className='file-icon';
      if(fp.endsWith('.py')) icon.textContent='üêç'; else if(fp.endsWith('.md')) icon.textContent='üìù'; else if(fp.endsWith('.txt')) icon.textContent='üìÑ'; else if(fp.endsWith('.json')) icon.textContent='üîß'; else icon.textContent='üìÅ';
      const label = document.createElement('div'); label.textContent = fp;
      item.appendChild(icon); item.appendChild(label);
      item.addEventListener('click', ()=>{ previewFile(fp, files[fp]); });
      tree.appendChild(item);
    });

    document.getElementById('btn-descargar').disabled = false;
  }

  function previewFile(path, content){
    const preview = document.getElementById('code-pre');
    preview.textContent = content;
    const header = document.querySelector('.code-block-header');
    if(header) header.textContent = path;
    logToConsole('üîé Vista previa: ' + path, 'info');
  }
  // ================ EVENTS ================

  document.getElementById('btn-descargar').addEventListener('click', async ()=>{
    if(!lastFiles){ logToConsole('‚ùå No hay archivos para descargar', 'error'); return; }
    try{
      logToConsole('üì¶ Creando paquete...');
      const zip = new JSZip(); for(const [p,c] of Object.entries(lastFiles)) zip.file(p, c);
      const folder = Object.keys(lastFiles)[0].split('/')[0] || 'project';
      const blob = await zip.generateAsync({type:'blob'});
      saveAs(blob, folder + '.iflapp');
      logToConsole('‚úÖ Paquete descargado: ' + folder + '.iflapp', 'success');
    }catch(err){ logToConsole('‚ùå Error al crear paquete: ' + err.message, 'error'); }
  });

  document.getElementById('btn-clear-console').addEventListener('click', ()=>{
    const c = document.getElementById('console-content'); c.innerHTML = ''; logToConsole('üßπ Consola limpiada', 'info');
  });

  document.getElementById('btn-copy-structure').addEventListener('click', ()=>{
    if(!lastFiles) return logToConsole('‚ùå Nada que copiar', 'error');
    const structure = Object.keys(lastFiles).join('\n'); navigator.clipboard.writeText(structure).then(()=> logToConsole('üìã Estructura copiada al portapapeles', 'success')).catch(e=> logToConsole('‚ùå No se pudo copiar: '+e.message,'error'));
  });

  // ================ INITIALIZE ================
  (function init(){
    document.getElementById('api-status').textContent = GEMINI_API_KEY ? 'Configurada' : 'No configurada (usar fallback local)';
    logToConsole('‚úÖ Sistema inicializado', 'success');
    logToConsole('üí° Describe tu app y pulsa "Generar Proyecto Completo" (o usa "Generaci√≥n local" si no tienes API key)', 'info');
  })();

  </script>
</body>
</html>
