// /api/genai.js
import fetch from "node-fetch";

export default async function handler(req, res) {
  if (req.method !== "POST") return res.status(405).json({ error: "Method not allowed" });

  const { prompt, mode, files } = req.body;

  if (!prompt || !mode) return res.status(400).json({ error: "Missing prompt or mode" });

  const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
  if (!GEMINI_API_KEY) return res.status(500).json({ error: "GEMINI_API_KEY not set" });

  try {
    // Construir prompt para Gemini
    let systemPrompt = "";
    let userPrompt = prompt;

    if (mode === "full") {
      systemPrompt = `
      Eres un asistente que genera proyectos de software completos en JSON.
      Devuelve un bloque de código JSON con la siguiente estructura:
      {
        "meta": {
          "empresa": "nombre fabricante",
          "nombre": "nombre corto",
          "version": "1.0",
          "titulo": "Titulo completo",
          "colores": {"primario":"#...","secundario":"#...","fondo":"#..."}
        },
        "files": [
          {"path":"{folder}/README.md","content":"..."},
          {"path":"{folder}/main.py","content":"..."},
          {"path":"{folder}/lib/requirements.txt","content":"..."},
          {"path":"{folder}/details.xml","content":"..."},
          {"path":"{folder}/autorun","content":"..."},
          {"path":"{folder}/LICENSE","content":"..."}
        ]
      }
      Usa prompts internos y material previo para generar los archivos.`;
    } else if (mode === "edit") {
      systemPrompt = `
      Eres un asistente que edita archivos existentes. Recibirás un JSON con los archivos actuales.
      Devuelve el mismo JSON con los contenidos actualizados según la descripción del usuario.`;
    } else {
      systemPrompt = "Eres un asistente que sugiere valores para un proyecto de software en JSON.";
    }

    // Preparar payload para Gemini
    const payload = {
      model: "gemini-1.5",
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: JSON.stringify({ prompt: userPrompt, files: files || [] }) }
      ],
      temperature: 0.7
    };

    const r = await fetch("https://api.generativeai.google/v1beta2/models/gemini-1.5:generateMessage", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${GEMINI_API_KEY}`
      },
      body: JSON.stringify(payload)
    });

    if (!r.ok) {
      const t = await r.text();
      return res.status(500).json({ error: "Gemini API error", details: t });
    }

    const data = await r.json();
    let content = data?.candidates?.[0]?.content?.[0]?.text || "";

    // Extraer JSON del bloque de código (si lo hay)
    const match = content.match(/```json([\s\S]*?)```/i);
    if (match) content = match[1];

    const parsed = JSON.parse(content);

    // Responder al frontend
    res.status(200).json(parsed);

  } catch (e) {
    res.status(500).json({ error: e.message });
  }
}
